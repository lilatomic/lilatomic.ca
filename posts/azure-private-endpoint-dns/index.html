<!doctype html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>The DNS Shenanigans that make Azure Private Endpoints Work</title>
	<meta name="description" content="Azure private endpoints allow you to privately access services via their public DNS names. DNS shenanigans are at play.">
	<link rel="stylesheet" href="/css/index.css">
	<link rel="stylesheet" href="/css/prism-base16-monokai.dark.css">
	<link rel="alternate" href="/feed/feed.xml" type="application/atom+xml"
		  title="lilatomic">
	<link rel="alternate" href="/feed/feed.json" type="application/json"
		  title="lilatomic">
</head>
<body>
<div class="ctn">
	<header>
		<h1 class="home"><a id="home" href="/">lilatomic</a></h1>
	</header>
	<div id="main">
		<main  class="tmpl-post" >

			
<article>
<h1>The DNS Shenanigans that make Azure Private Endpoints Work</h1>

<aside id="tagbox">
<p>Tags</p>

  <a href="/tags/azure/" class="post-tag">azure</a>
  <a href="/tags/hindsight/" class="post-tag">hindsight</a>
</aside>





<aside id="toc">
	<nav class="toc" >
        <ol><li><a href="#how-it-works">How it works</a><ol><li><a href="#a-resource-with-no-pes">A resource with no PEs</a></li><li><a href="#a-resource-with-a-pe">A resource with a PE</a></li></ol></li><li><a href="#shenanigans!">Shenanigans!</a></li></ol>
      </nav>
</aside>

<div class="content">
<!-- prettier-ignore-start -->
<!-- prettier-ignore-end -->
<h1 id="the-dns-shenanigans-that-make-azure-private-endpoints-work" tabindex="-1"><a class="direct-link" href="#the-dns-shenanigans-that-make-azure-private-endpoints-work">The <abbr title="Domain Name System">DNS</abbr> Shenanigans that make Azure Private Endpoints Work</a></h1>
<p>In Azure, you can create a <abbr title="Private Endpoint">PE</abbr> to an IaaS service, like blobstores. These allow you to have a &quot;local&quot; IP in a <abbr title="Virtual network">VNet</abbr> to the &quot;internet&quot; resource. Convenient. Just as convenient is that you can access them via their public <abbr title="Domain Name System">DNS</abbr> name: &quot;<a href="http://myblobs.blob.core.windows.net">myblobs.blob.core.windows.net</a>&quot; will work whether you're on the public Internet or your <abbr title="Virtual network">VNet</abbr>.<br>
How this works is interesting. The <abbr title="Domain Name System">DNS</abbr> name needs to resolve to a public IP on the Internet, but your custom local IP on your <abbr title="Virtual network">VNet</abbr>. Not only are these 2 different, but one is in Public IP space and the other is (probably) in <a href="https://en.wikipedia.org/wiki/Private_network">RFC1918</a> IP space.</p>
<h2 id="how-it-works" tabindex="-1"><a class="direct-link" href="#how-it-works">How it works</a></h2>
<p>Let's examine the shenanigans that make this work by stepping through all the <abbr title="Domain Name System">DNS</abbr> configurations.</p>
<h3 id="a-resource-with-no-pes" tabindex="-1"><a class="direct-link" href="#a-resource-with-no-pes">A resource with no PEs</a></h3>
<p>You'd expect this <abbr title="Domain Name System">DNS</abbr> to function normally: Just a pointer to an IP. It's more complicated, as Azure adds some redirect elements to make redundancy scenarios easier. For an <abbr title="Locally Redundant Storage, a redundancy level in Azure that stores data in 1 zone">LRS</abbr> storage account, it's simply a <abbr title="Canonical name, a pointer to another domain name">CNAME</abbr> to (presumably) a datacentre's name and then an A to the IP:</p>
<pre class="language-command-line"><code class="language-command-line"><span class="highlight-line">dig +noall +answer myblobstorenopelrs.blob.core.windows.net</span>
<span class="highlight-line">myblobstorenopelrs.blob.core.windows.net. 60 IN CNAME	blob.yto22prdstr05a.store.core.windows.net.</span>
<span class="highlight-line">blob.yto22prdstr05a.store.core.windows.net. 86202 IN A 20.60.242.11</span></code></pre>
<p>For a storage account with <abbr title="Zone Redundant Storage, a redundancy level in Azure that stores data in multiple zones">ZRS</abbr>, there are multiple datacentres/zones that keep the data. We see the redirect to the <a href="http://store.core.windows.net">store.core.windows.net</a> domain this time redirect to a trafficmanager endpoint. This allows Azure to balance traffic between the 3 zones, which are the 3 A records.</p>
<pre class="language-command-line"><code class="language-command-line"><span class="highlight-line">dig +noall +answer myblobstorenope.blob.core.windows.net</span>
<span class="highlight-line">myblobstorenope.blob.core.windows.net. 7 IN	CNAME	blob.yto21prdstrz05a.store.core.windows.net.</span>
<span class="highlight-line">blob.yto21prdstrz05a.store.core.windows.net. 7 IN CNAME	blob.YTO21PrdStrz05A.trafficmanager.net.</span>
<span class="highlight-line">blob.YTO21PrdStrz05A.trafficmanager.net. 7 IN A	20.150.16.196</span>
<span class="highlight-line">blob.YTO21PrdStrz05A.trafficmanager.net. 7 IN A	52.239.189.228</span>
<span class="highlight-line">blob.YTO21PrdStrz05A.trafficmanager.net. 7 IN A	20.150.31.4</span></code></pre>
<h3 id="a-resource-with-a-pe" tabindex="-1"><a class="direct-link" href="#a-resource-with-a-pe">A resource with a <abbr title="Private Endpoint">PE</abbr></a></h3>
<p>Adding a <abbr title="Private Endpoint">PE</abbr> to a resource engages the <abbr title="Private Link">PL</abbr> <abbr title="Domain Name System">DNS</abbr> machinery. This adds a redirection to a <a href="http://privatelink.blob.core.windows.net">privatelink.blob.core.windows.net</a>. It's this privatelink name that adds the decoupling that can redirect to the correct endpoint.</p>
<p>On the public Internet, this just forwards to the same datacentre or trafficmanager name as before:</p>
<pre class="language-command-line"><code class="language-command-line"><span class="highlight-line">dig +noall +answer myblobstorepe.blob.core.windows.net</span>
<span class="highlight-line">myblobstorepe.blob.core.windows.net. 60 IN	CNAME	myblobstorepe.privatelink.blob.core.windows.net.</span>
<span class="highlight-line">myblobstorepe.privatelink.blob.core.windows.net. 60 IN CNAME blob.yto22prdstr03c.store.core.windows.net.</span>
<span class="highlight-line">blob.yto22prdstr03c.store.core.windows.net. 86279 IN A 20.60.43.235</span></code></pre>
<p>On the side of the <abbr title="Virtual network">VNet</abbr>, this is supposed to redirect to the <abbr title="Private Endpoint">PE</abbr>. Some additional infra/magic makes this work. The <abbr title="Private Endpoint">PE</abbr> itself has the option of integrating with a Private <abbr title="Domain Name System">DNS</abbr> Zone Group. This is the default. And, if you've created this in the portal, it'll even create the privatelink <abbr title="Domain Name System">DNS</abbr> zone for you (in this case, <a href="http://blob.privatelink.core.windows.net">blob.privatelink.core.windows.net</a>). This Private <abbr title="Domain Name System">DNS</abbr> Zone Group must also be linked with the <abbr title="Virtual network">VNet</abbr> for the records to show up with the Azure resolver (the default). (If you're using your own resolver, you'll want to figure out some really fun <a href="https://en.wikipedia.org/wiki/Split-horizon_DNS">split-horizon <abbr title="Domain Name System">DNS</abbr></a> and automatic loading of config into it.)</p>
<pre class="language-command-line"><code class="language-command-line"><span class="highlight-line">dig +noall +answer myblobstorepe.blob.core.windows.net</span>
<span class="highlight-line">myblobstorepe.blob.core.windows.net. 60 IN	CNAME	myblobstorepe.privatelink.blob.core.windows.net.</span>
<span class="highlight-line">myblobstorepe.privatelink.blob.core.windows.net. 10 IN A 10.0.0.10</span></code></pre>
<h2 id="shenanigans!" tabindex="-1"><a class="direct-link" href="#shenanigans!">Shenanigans!</a></h2>
<p>This leads to some complications. There's <a href="https://learn.microsoft.com/en-us/azure/private-link/private-endpoint-dns">a doc</a> on Azure that has some big red boxes about this. Let's go over them and include implementations of the workaround.</p>
<p>The privatelink <abbr title="Domain Name System">DNS</abbr> zone is needed for the <abbr title="Private Endpoint">PE</abbr> to work. This <abbr title="Domain Name System">DNS</abbr> zone will only contain entries of PEs linked to it. But, every resource that has a <abbr title="Private Endpoint">PE</abbr> anywhere has the <abbr title="Canonical name, a pointer to another domain name">CNAME</abbr> redirect to a private endpoint. This means that if you try to use the public endpoint to access a resource that has a private endpoint, you will receive an NX for the privatelink domain and won't be able to. For example, our Private <abbr title="Domain Name System">DNS</abbr> zone from above only contains a record for <a href="http://myblobstorepe.privatelink.blob.core.windows.net">myblobstorepe.privatelink.blob.core.windows.net</a>, and it doesn't have a record for <a href="http://publicblob.privatelink.core.windows.net">publicblob.privatelink.core.windows.net</a>; therefore, we get NXDOMAIN and can't access a publicly accessible resource.</p>
<p>This requirement for a private <abbr title="Domain Name System">DNS</abbr> zone that will NX other records also prevents you from using service endpoints and private endpoints together in similar circumstances. You'll have to complete the <abbr title="Domain Name System">DNS</abbr> chain yourself.</p>
<p>One solution is to add the missing <abbr title="Domain Name System">DNS</abbr> record manually. In our example, we could add the record <code>publicblob.privatelink.blob.core.windows.net. 60 IN CNAME blob.yto22prdstr03c.store.core.windows.net.</code>. This is fiddly. Finding the value for the target requires some manual intervention. The target is obviously internal to Azure. I have no idea how often or if ever it changes. From my experience, it hasn't changed in a year. But is also clearly linked to the region and zones the storage account is in, so it could change suddenly if the owner of the storage account reconfigures it in ways that would seem safe.</p>

</div>
</article>



<hr>
<ul><li>Next: <a href="/posts/migrating-tox-to-pants/">Migrating a project from tox to Pants</a></li><li>Previous: <a href="/posts/azure_function_durable_testing/">Testing Azure Durable Functions in Python</a></li>
</ul>

		</main>
		<nav class="nav">
			<ul>
				<li class="nav-item"><a
						href="/">Home</a></li>
				<li class="nav-item"><a
						href="/posts/">Archive</a></li>
				<li class="nav-item"><a
						href="/tags/">Tags</a></li>
				<li class="nav-item"><a
						href="/series/">Series</a></li>
				<li class="nav-item"><a
						href="/about/">About Me</a></li>
				<li class="nav-item"><a
						href="/colophon/">Colophon</a></li>
				<li class="nav-item"><a
						href="/feedlist/">Feeds</a></li>
			</ul>
		</nav>
	</div>
</div>
<footer></footer>

<!-- Current page: /posts/azure-private-endpoint-dns/ -->
</body>
</html>
