<!doctype html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Writing a Vars Plugin in Ansible</title>
	<meta name="description" content="How to write an Action Plugin in Ansible. These let you load variables.">
	<link rel="stylesheet" href="/css/index.css">
	<link rel="stylesheet" href="/css/prism-base16-monokai.dark.css">
	<link rel="alternate" href="/feed/feed.xml" type="application/atom+xml"
		  title="lilatomic">
	<link rel="alternate" href="/feed/feed.json" type="application/json"
		  title="lilatomic">
</head>
<body>
<div class="ctn">
	<header>
		<h1 class="home"><a id="home" href="/">lilatomic</a></h1>
	</header>
	<div id="main">
		<main  class="tmpl-post" >

			
<article>
<h1>Writing a Vars Plugin in Ansible</h1>

<aside id="tagbox">
<p>Tags</p>

  <a href="/tags/ansible/" class="post-tag">ansible</a>
</aside>



<aside id="seriesbox">
<p> Member of series: </p>

  
  <a href="/series/ansible plugins/" class="post-tag">ansible plugins</a>

</aside>



<aside id="toc">
	<nav class="toc" >
        <ol><li><a href="#basic-outline">Basic outline</a></li><li><a href="#using-hosts-and-groups">Using hosts and groups</a></li><li><a href="#loading-files">Loading files</a></li><li><a href="#execution">Execution</a></li></ol>
      </nav>
</aside>

<div class="content">
<h1 id="writing-a-vars-plugin-in-ansible" tabindex="-1"><a class="direct-link" href="#writing-a-vars-plugin-in-ansible">Writing a Vars Plugin in Ansible</a></h1>
<p>Often there are facts you wish were just ambiently available, especially if you are working with cloud infrastructure. For example, you might want to have your subscription id, tenant id, user object id, contents of a resource group, and many other things. You could have tasks which set these as facts, but that severely limits your ability to resume at a task.</p>
<h2 id="basic-outline" tabindex="-1"><a class="direct-link" href="#basic-outline">Basic outline</a></h2>
<p>The most basic version of a vars plugin is just a reflectable classname and method name.</p>
<pre class="language-python"><code class="language-python"><span class="highlight-line"><span class="token keyword">from</span> ansible<span class="token punctuation">.</span>plugins<span class="token punctuation">.</span><span class="token builtin">vars</span> <span class="token keyword">import</span> BaseVarsPlugin</span>
<span class="highlight-line"></span>
<span class="highlight-line"><span class="token keyword">class</span> <span class="token class-name">VarsModule</span><span class="token punctuation">(</span>BaseVarsPlugin<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="highlight-line"></span>
<span class="highlight-line">	<span class="token keyword">def</span> <span class="token function">get_vars</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> loader<span class="token punctuation">,</span> path<span class="token punctuation">,</span> entities<span class="token punctuation">,</span> cache<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="highlight-line">		<span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span></code></pre>
<p>Let's get our documentation in order. We want to include this fragment to let people know how to set when the plugin runs (See <a href="#execution">Execution</a> for why)</p>
<pre class="language-yaml"><code class="language-yaml"><span class="highlight-line"><span class="token key atrule">vars</span><span class="token punctuation">:</span> gitroot</span>
<span class="highlight-line"><span class="token key atrule">version_added</span><span class="token punctuation">:</span> <span class="token string">"0.2"</span> <span class="token comment"># for collections, use the collection version, not the Ansible version</span></span>
<span class="highlight-line"><span class="token key atrule">short_description</span><span class="token punctuation">:</span> Finds the git root</span>
<span class="highlight-line"><span class="token key atrule">description</span><span class="token punctuation">:</span> Finds the git root</span>
<span class="highlight-line"><span class="token key atrule">options</span><span class="token punctuation">:</span></span>
<span class="highlight-line">  <span class="token key atrule">stage</span><span class="token punctuation">:</span></span>
<span class="highlight-line">    <span class="token key atrule">ini</span><span class="token punctuation">:</span></span>
<span class="highlight-line">      <span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> stage</span>
<span class="highlight-line">        <span class="token key atrule">section</span><span class="token punctuation">:</span> lilatomic.alpacloud.gitroot</span>
<span class="highlight-line">    <span class="token key atrule">env</span><span class="token punctuation">:</span></span>
<span class="highlight-line">      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> LILATOMIC_ALPACLOUD_GITROOT</span>
<span class="highlight-line"><span class="token key atrule">extends_documentation_fragment</span><span class="token punctuation">:</span></span>
<span class="highlight-line">  <span class="token punctuation">-</span> vars_plugin_staging</span></code></pre>
<p>Combining we get a sample like:</p>
<pre class="language-python"><code class="language-python">DOCUMENTATION <span class="token operator">=</span> <span class="token triple-quoted-string string">r"""
<span class="highlight-line">vars: gitroot</span>
<span class="highlight-line">version_added: "0.2"</span>
<span class="highlight-line">short_description: Finds the git root</span>
<span class="highlight-line">description: Finds the git root</span>
<span class="highlight-line">options:</span>
<span class="highlight-line">  stage:</span>
<span class="highlight-line">    ini:</span>
<span class="highlight-line">      - key: stage</span>
<span class="highlight-line">        section: lilatomic.alpacloud.gitroot</span>
<span class="highlight-line">    env:</span>
<span class="highlight-line">      - name: LILATOMIC_ALPACLOUD_GITROOT</span>
<span class="highlight-line">extends_documentation_fragment:</span>
<span class="highlight-line">  - vars_plugin_staging</span>
"""</span>
<span class="highlight-line"></span>
<span class="highlight-line"><span class="token keyword">import</span> subprocess</span>
<span class="highlight-line"></span>
<span class="highlight-line"><span class="token keyword">from</span> ansible<span class="token punctuation">.</span>plugins<span class="token punctuation">.</span><span class="token builtin">vars</span> <span class="token keyword">import</span> BaseVarsPlugin</span>
<span class="highlight-line"></span>
<span class="highlight-line"></span>
<span class="highlight-line"><span class="token keyword">class</span> <span class="token class-name">VarsModule</span><span class="token punctuation">(</span>BaseVarsPlugin<span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># Must be named VarsModule</span></span>
<span class="highlight-line">	<span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># Not necessary if you're just going to call up</span></span>
<span class="highlight-line">		<span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="highlight-line"></span>
<span class="highlight-line">	<span class="token keyword">def</span> <span class="token function">get_vars</span><span class="token punctuation">(</span></span>
<span class="highlight-line">		self<span class="token punctuation">,</span> loader<span class="token punctuation">,</span> path<span class="token punctuation">,</span> entities<span class="token punctuation">,</span> cache<span class="token operator">=</span><span class="token boolean">None</span></span>
<span class="highlight-line">	<span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># the function which actualy does the lookup</span></span>
<span class="highlight-line"></span>
<span class="highlight-line">		<span class="token comment"># call to super. `self._basedir = basedir(path)`</span></span>
<span class="highlight-line">		<span class="token builtin">super</span><span class="token punctuation">(</span>VarsModule<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>get_vars<span class="token punctuation">(</span>loader<span class="token punctuation">,</span> path<span class="token punctuation">,</span> entities<span class="token punctuation">)</span></span>
<span class="highlight-line"></span>
<span class="highlight-line">		<span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token string">"src"</span><span class="token punctuation">:</span> _get_git_root<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span>
<span class="highlight-line"></span>
<span class="highlight-line"></span>
<span class="highlight-line"><span class="token keyword">def</span> <span class="token function">_get_git_root</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="highlight-line">	res <span class="token operator">=</span> subprocess<span class="token punctuation">.</span>run<span class="token punctuation">(</span></span>
<span class="highlight-line">		<span class="token string">"git rev-parse --show-toplevel"</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">" "</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="highlight-line">		stdout<span class="token operator">=</span>subprocess<span class="token punctuation">.</span>PIPE<span class="token punctuation">,</span></span>
<span class="highlight-line">		universal_newlines<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span></span>
<span class="highlight-line">	<span class="token punctuation">)</span></span>
<span class="highlight-line">	<span class="token keyword">return</span> res<span class="token punctuation">.</span>stdout</span></code></pre>
<p>This sample is really bad, because it gets executed <em>a lot</em> (See <a href="#execution">Execution</a>). So we want to build some caching into it. This is patterned off of how host_group_vars does it (the only vars plugin included in base), but other vars plugins do a similar thing:</p>
<pre class="language-python"><code class="language-python">DOCUMENTATION <span class="token operator">=</span> <span class="token triple-quoted-string string">r"""
<span class="highlight-line">vars: gitroot</span>
<span class="highlight-line">version_added: "0.2"</span>
<span class="highlight-line">short_description: Finds the git root</span>
<span class="highlight-line">description: Finds the git root</span>
<span class="highlight-line">options:</span>
<span class="highlight-line">  stage:</span>
<span class="highlight-line">    ini:</span>
<span class="highlight-line">      - key: stage</span>
<span class="highlight-line">        section: lilatomic.alpacloud.gitroot</span>
<span class="highlight-line">    env:</span>
<span class="highlight-line">      - name: LILATOMIC_ALPACLOUD_GITROOT</span>
<span class="highlight-line">extends_documentation_fragment:</span>
<span class="highlight-line">  - vars_plugin_staging</span>
"""</span>
<span class="highlight-line"></span>
<span class="highlight-line"><span class="token keyword">import</span> subprocess</span>
<span class="highlight-line"></span>
<span class="highlight-line"><span class="token keyword">from</span> ansible<span class="token punctuation">.</span>plugins<span class="token punctuation">.</span><span class="token builtin">vars</span> <span class="token keyword">import</span> BaseVarsPlugin</span>
<span class="highlight-line"></span>
<span class="highlight-line"></span>
<span class="highlight-line">FOUND <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span>
<span class="highlight-line"></span>
<span class="highlight-line"></span>
<span class="highlight-line"><span class="token keyword">class</span> <span class="token class-name">VarsModule</span><span class="token punctuation">(</span>BaseVarsPlugin<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="highlight-line">	<span class="token keyword">def</span> <span class="token function">get_vars</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> loader<span class="token punctuation">,</span> path<span class="token punctuation">,</span> entities<span class="token punctuation">,</span> cache<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="highlight-line"></span>
<span class="highlight-line">		<span class="token keyword">if</span> <span class="token keyword">not</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>entities<span class="token punctuation">,</span> <span class="token builtin">list</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="highlight-line">			entities <span class="token operator">=</span> <span class="token punctuation">[</span>entities<span class="token punctuation">]</span></span>
<span class="highlight-line"></span>
<span class="highlight-line">		<span class="token builtin">super</span><span class="token punctuation">(</span>VarsModule<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>get_vars<span class="token punctuation">(</span>loader<span class="token punctuation">,</span> path<span class="token punctuation">,</span> entities<span class="token punctuation">)</span></span>
<span class="highlight-line"></span>
<span class="highlight-line">		<span class="token keyword">if</span> <span class="token string">"src"</span> <span class="token keyword">not</span> <span class="token keyword">in</span> FOUND<span class="token punctuation">:</span></span>
<span class="highlight-line">			FOUND<span class="token punctuation">[</span><span class="token string">"src"</span><span class="token punctuation">]</span> <span class="token operator">=</span> _get_git_root<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="highlight-line"></span>
<span class="highlight-line">		<span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token string">"src"</span><span class="token punctuation">:</span> FOUND<span class="token punctuation">[</span><span class="token string">"src"</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span>
<span class="highlight-line"></span>
<span class="highlight-line"></span>
<span class="highlight-line"><span class="token keyword">def</span> <span class="token function">_get_git_root</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="highlight-line">	res <span class="token operator">=</span> subprocess<span class="token punctuation">.</span>run<span class="token punctuation">(</span></span>
<span class="highlight-line">		<span class="token string">"git rev-parse --show-toplevel"</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">" "</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="highlight-line">		stdout<span class="token operator">=</span>subprocess<span class="token punctuation">.</span>PIPE<span class="token punctuation">,</span></span>
<span class="highlight-line">		universal_newlines<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span></span>
<span class="highlight-line">	<span class="token punctuation">)</span></span>
<span class="highlight-line">	<span class="token keyword">return</span> res<span class="token punctuation">.</span>stdout</span></code></pre>
<h2 id="using-hosts-and-groups" tabindex="-1"><a class="direct-link" href="#using-hosts-and-groups">Using hosts and groups</a></h2>
<p>In the above example, we added a general var (one which isn't attached to a particular host). We may want to add other data associated with each host or group. There are a couple moving pieces detailed in the following:</p>
<pre class="language-python"><code class="language-python">DOCUMENTATION <span class="token operator">=</span> <span class="token triple-quoted-string string">r"""
<span class="highlight-line">vars: knownhostentry</span>
<span class="highlight-line">version_added: "0.2"</span>
<span class="highlight-line">short_description: Adds a known-hosts entry for each host, if you have one</span>
<span class="highlight-line">description: </span>
<span class="highlight-line">  - Adds a known-hosts entry for each host, if you have one in you local known-hosts</span>
<span class="highlight-line">  - Useful for not having to construct it every time</span>
<span class="highlight-line">options:</span>
<span class="highlight-line">  stage:</span>
<span class="highlight-line">    ini:</span>
<span class="highlight-line">      - key: stage</span>
<span class="highlight-line">        section: lilatomic.alpacloud.knownhostentry</span>
<span class="highlight-line">    env:</span>
<span class="highlight-line">      - name: LILATOMIC_ALPACLOUD_KNOWNHOSTENTRY</span>
<span class="highlight-line">extends_documentation_fragment:</span>
<span class="highlight-line">  - vars_plugin_staging</span>
"""</span>
<span class="highlight-line"><span class="token keyword">import</span> json</span>
<span class="highlight-line"><span class="token keyword">import</span> os</span>
<span class="highlight-line"><span class="token keyword">import</span> subprocess</span>
<span class="highlight-line"></span>
<span class="highlight-line"><span class="token keyword">from</span> ansible<span class="token punctuation">.</span>errors <span class="token keyword">import</span> AnsibleParserError</span>
<span class="highlight-line"><span class="token keyword">from</span> ansible<span class="token punctuation">.</span>module_utils<span class="token punctuation">.</span>_text <span class="token keyword">import</span> to_bytes<span class="token punctuation">,</span> to_native<span class="token punctuation">,</span> to_text</span>
<span class="highlight-line"><span class="token keyword">from</span> ansible<span class="token punctuation">.</span>plugins<span class="token punctuation">.</span><span class="token builtin">vars</span> <span class="token keyword">import</span> BaseVarsPlugin</span>
<span class="highlight-line"><span class="token keyword">from</span> ansible<span class="token punctuation">.</span>inventory<span class="token punctuation">.</span>host <span class="token keyword">import</span> Host</span>
<span class="highlight-line"><span class="token keyword">from</span> ansible<span class="token punctuation">.</span>inventory<span class="token punctuation">.</span>group <span class="token keyword">import</span> Group</span>
<span class="highlight-line"><span class="token keyword">from</span> ansible<span class="token punctuation">.</span>utils<span class="token punctuation">.</span><span class="token builtin">vars</span> <span class="token keyword">import</span> combine_vars</span>
<span class="highlight-line"></span>
<span class="highlight-line"></span>
<span class="highlight-line"><span class="token keyword">from</span> ansible<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>display <span class="token keyword">import</span> Display</span>
<span class="highlight-line"></span>
<span class="highlight-line">display <span class="token operator">=</span> Display<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="highlight-line"></span>
<span class="highlight-line">FOUND <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span>
<span class="highlight-line"></span>
<span class="highlight-line"></span>
<span class="highlight-line"><span class="token keyword">class</span> <span class="token class-name">VarsModule</span><span class="token punctuation">(</span>BaseVarsPlugin<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="highlight-line">	<span class="token keyword">def</span> <span class="token function">get_vars</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> loader<span class="token punctuation">,</span> path<span class="token punctuation">,</span> entities<span class="token punctuation">,</span> cache<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="highlight-line"></span>
<span class="highlight-line">		<span class="token comment"># not sure what this is about, it's not invoked when I run it</span></span>
<span class="highlight-line">		<span class="token comment"># there's probably a compatibility thing</span></span>
<span class="highlight-line">		<span class="token keyword">if</span> <span class="token keyword">not</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>entities<span class="token punctuation">,</span> <span class="token builtin">list</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="highlight-line">			entities <span class="token operator">=</span> <span class="token punctuation">[</span>entities<span class="token punctuation">]</span></span>
<span class="highlight-line"></span>
<span class="highlight-line">		<span class="token builtin">super</span><span class="token punctuation">(</span>VarsModule<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>get_vars<span class="token punctuation">(</span>loader<span class="token punctuation">,</span> path<span class="token punctuation">,</span> entities<span class="token punctuation">)</span></span>
<span class="highlight-line"></span>
<span class="highlight-line">		data <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span>
<span class="highlight-line">		<span class="token comment"># loop through entities</span></span>
<span class="highlight-line">		<span class="token keyword">for</span> entity <span class="token keyword">in</span> entities<span class="token punctuation">:</span></span>
<span class="highlight-line">			<span class="token comment"># entities come as either Hosts or Groups. This example ignores groups.</span></span>
<span class="highlight-line">			<span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>entity<span class="token punctuation">,</span> Host<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="highlight-line">				<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></span>
<span class="highlight-line">			<span class="token keyword">elif</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>entity<span class="token punctuation">,</span> Group<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="highlight-line">				<span class="token keyword">continue</span></span>
<span class="highlight-line">			<span class="token keyword">else</span><span class="token punctuation">:</span></span>
<span class="highlight-line">				<span class="token keyword">raise</span> AnsibleParserError<span class="token punctuation">(</span></span>
<span class="highlight-line">					<span class="token string">"Supplied entity must be Host or Group, got %s instead"</span> <span class="token operator">%</span> <span class="token punctuation">(</span><span class="token builtin">type</span><span class="token punctuation">(</span>entity<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="highlight-line">				<span class="token punctuation">)</span></span>
<span class="highlight-line"></span>
<span class="highlight-line">			<span class="token keyword">if</span> entity<span class="token punctuation">.</span>name<span class="token punctuation">.</span>startswith<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>sep<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="highlight-line">				<span class="token comment"># avoid 'chroot' type inventory hostnames /path/to/chroot</span></span>
<span class="highlight-line">				<span class="token comment"># this is from the sample plugin</span></span>
<span class="highlight-line">				<span class="token keyword">continue</span></span>
<span class="highlight-line"></span>
<span class="highlight-line">			<span class="token keyword">try</span><span class="token punctuation">:</span></span>
<span class="highlight-line">				key <span class="token operator">=</span> <span class="token builtin">str</span><span class="token punctuation">(</span>entity<span class="token punctuation">.</span>name<span class="token punctuation">)</span></span>
<span class="highlight-line">				<span class="token keyword">if</span> cache <span class="token keyword">and</span> key <span class="token keyword">in</span> FOUND<span class="token punctuation">:</span></span>
<span class="highlight-line">					known_hosts <span class="token operator">=</span> FOUND<span class="token punctuation">[</span>key<span class="token punctuation">]</span></span>
<span class="highlight-line">				<span class="token keyword">else</span><span class="token punctuation">:</span></span>
<span class="highlight-line">					FOUND<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> _get_known_host<span class="token punctuation">(</span>entity<span class="token punctuation">.</span>name<span class="token punctuation">)</span></span>
<span class="highlight-line">					known_hosts <span class="token operator">=</span> FOUND<span class="token punctuation">[</span>key<span class="token punctuation">]</span></span>
<span class="highlight-line"></span>
<span class="highlight-line">				<span class="token keyword">if</span> known_hosts<span class="token punctuation">:</span></span>
<span class="highlight-line">					data<span class="token punctuation">[</span><span class="token string">"known_hosts"</span><span class="token punctuation">]</span> <span class="token operator">=</span> known_hosts</span>
<span class="highlight-line"></span>
<span class="highlight-line">			<span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span></span>
<span class="highlight-line">				display<span class="token punctuation">.</span>warning<span class="token punctuation">(</span><span class="token string">"HALP"</span><span class="token punctuation">)</span></span>
<span class="highlight-line">				<span class="token keyword">raise</span> AnsibleParserError<span class="token punctuation">(</span>to_native<span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="highlight-line"></span>
<span class="highlight-line">		display<span class="token punctuation">.</span>v<span class="token punctuation">(</span>json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="highlight-line">		<span class="token keyword">return</span> data</span>
<span class="highlight-line"></span>
<span class="highlight-line"></span>
<span class="highlight-line"><span class="token keyword">def</span> <span class="token function">_get_known_host</span><span class="token punctuation">(</span>host<span class="token punctuation">,</span> <span class="token builtin">file</span><span class="token operator">=</span><span class="token string">"~/.ssh/known_hosts"</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="highlight-line">	<span class="token builtin">file</span> <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>expanduser<span class="token punctuation">(</span><span class="token builtin">file</span><span class="token punctuation">)</span></span>
<span class="highlight-line"></span>
<span class="highlight-line">	cmd <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"/usr/bin/ssh-keygen"</span><span class="token punctuation">,</span> <span class="token string">"-f"</span><span class="token punctuation">,</span> <span class="token builtin">file</span><span class="token punctuation">,</span> <span class="token string">"-F"</span><span class="token punctuation">,</span> host<span class="token punctuation">]</span></span>
<span class="highlight-line"></span>
<span class="highlight-line">	display<span class="token punctuation">.</span>v<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"cmd : </span><span class="token interpolation"><span class="token punctuation">{</span>cmd<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span></span>
<span class="highlight-line">	res <span class="token operator">=</span> subprocess<span class="token punctuation">.</span>run<span class="token punctuation">(</span></span>
<span class="highlight-line">		cmd<span class="token punctuation">,</span> stdout<span class="token operator">=</span>subprocess<span class="token punctuation">.</span>PIPE<span class="token punctuation">,</span> stderr<span class="token operator">=</span>subprocess<span class="token punctuation">.</span>PIPE<span class="token punctuation">,</span> universal_newlines<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span></span>
<span class="highlight-line">	<span class="token punctuation">)</span></span>
<span class="highlight-line">	display<span class="token punctuation">.</span>v<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"stdout </span><span class="token interpolation"><span class="token punctuation">{</span>res<span class="token punctuation">.</span>stdout<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span></span>
<span class="highlight-line">	display<span class="token punctuation">.</span>v<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"stderr </span><span class="token interpolation"><span class="token punctuation">{</span>res<span class="token punctuation">.</span>stderr<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span></span>
<span class="highlight-line">	display<span class="token punctuation">.</span>warning<span class="token punctuation">(</span>res<span class="token punctuation">.</span>stderr<span class="token punctuation">)</span></span>
<span class="highlight-line">	lines <span class="token operator">=</span> res<span class="token punctuation">.</span>stdout<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">"\n"</span><span class="token punctuation">)</span></span>
<span class="highlight-line">	hostlines <span class="token operator">=</span> <span class="token punctuation">[</span>x <span class="token keyword">for</span> x <span class="token keyword">in</span> lines <span class="token keyword">if</span> x <span class="token keyword">and</span> <span class="token keyword">not</span> x<span class="token punctuation">.</span>startswith<span class="token punctuation">(</span><span class="token string">"#"</span><span class="token punctuation">)</span><span class="token punctuation">]</span></span>
<span class="highlight-line">	<span class="token keyword">return</span> hostlines</span>
<span class="highlight-line"></span></code></pre>
<h2 id="loading-files" tabindex="-1"><a class="direct-link" href="#loading-files">Loading files</a></h2>
<p>You can probably figure out how to load files by cribbing from the host_group_vars plugin. I've included one here for completeness. The main difference is that <code>loader.load_from_file</code> only supports YAML/JSON, so we write our own little functionlet.</p>
<pre class="language-python"><code class="language-python">DOCUMENTATION <span class="token operator">=</span> <span class="token triple-quoted-string string">r"""
<span class="highlight-line">vars: dhall_vars</span>
<span class="highlight-line">version_added: "0.2"</span>
<span class="highlight-line">short_description: Loads vars from a Dhall file</span>
<span class="highlight-line">description: </span>
<span class="highlight-line">  - Loads vars from a Dhall file</span>
<span class="highlight-line">options:</span>
<span class="highlight-line">  stage:</span>
<span class="highlight-line">    ini:</span>
<span class="highlight-line">      - key: stage</span>
<span class="highlight-line">        section: lilatomic.alpacloud.dhall_vars</span>
<span class="highlight-line">    env:</span>
<span class="highlight-line">      - name: LILATOMIC_ALPACLOUD_DHALL_VARS</span>
<span class="highlight-line">extends_documentation_fragment:</span>
<span class="highlight-line">  - vars_plugin_staging</span>
"""</span>
<span class="highlight-line"></span>
<span class="highlight-line"><span class="token keyword">import</span> os</span>
<span class="highlight-line"><span class="token keyword">import</span> subprocess</span>
<span class="highlight-line"></span>
<span class="highlight-line"><span class="token keyword">from</span> ansible<span class="token punctuation">.</span>errors <span class="token keyword">import</span> AnsibleParserError</span>
<span class="highlight-line"><span class="token keyword">from</span> ansible<span class="token punctuation">.</span>module_utils<span class="token punctuation">.</span>_text <span class="token keyword">import</span> to_bytes<span class="token punctuation">,</span> to_native<span class="token punctuation">,</span> to_text</span>
<span class="highlight-line"><span class="token keyword">from</span> ansible<span class="token punctuation">.</span>plugins<span class="token punctuation">.</span><span class="token builtin">vars</span> <span class="token keyword">import</span> BaseVarsPlugin</span>
<span class="highlight-line"><span class="token keyword">from</span> ansible<span class="token punctuation">.</span>inventory<span class="token punctuation">.</span>host <span class="token keyword">import</span> Host</span>
<span class="highlight-line"><span class="token keyword">from</span> ansible<span class="token punctuation">.</span>inventory<span class="token punctuation">.</span>group <span class="token keyword">import</span> Group</span>
<span class="highlight-line"><span class="token keyword">from</span> ansible<span class="token punctuation">.</span>utils<span class="token punctuation">.</span><span class="token builtin">vars</span> <span class="token keyword">import</span> combine_vars</span>
<span class="highlight-line"></span>
<span class="highlight-line"><span class="token keyword">import</span> dhall</span>
<span class="highlight-line"></span>
<span class="highlight-line"></span>
<span class="highlight-line">FOUND <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span>
<span class="highlight-line"></span>
<span class="highlight-line"></span>
<span class="highlight-line"><span class="token keyword">class</span> <span class="token class-name">VarsModule</span><span class="token punctuation">(</span>BaseVarsPlugin<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="highlight-line">	<span class="token keyword">def</span> <span class="token function">get_vars</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> loader<span class="token punctuation">,</span> path<span class="token punctuation">,</span> entities<span class="token punctuation">,</span> cache<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="highlight-line"></span>
<span class="highlight-line">		<span class="token keyword">if</span> <span class="token keyword">not</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>entities<span class="token punctuation">,</span> <span class="token builtin">list</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="highlight-line">			entities <span class="token operator">=</span> <span class="token punctuation">[</span>entities<span class="token punctuation">]</span></span>
<span class="highlight-line"></span>
<span class="highlight-line">		<span class="token builtin">super</span><span class="token punctuation">(</span>VarsModule<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>get_vars<span class="token punctuation">(</span>loader<span class="token punctuation">,</span> path<span class="token punctuation">,</span> entities<span class="token punctuation">)</span></span>
<span class="highlight-line"></span>
<span class="highlight-line">		data <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span>
<span class="highlight-line"></span>
<span class="highlight-line">		<span class="token keyword">for</span> entity <span class="token keyword">in</span> entities<span class="token punctuation">:</span></span>
<span class="highlight-line">			<span class="token comment"># we set the subdir here</span></span>
<span class="highlight-line">			<span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>entity<span class="token punctuation">,</span> Host<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="highlight-line">				subdir <span class="token operator">=</span> <span class="token string">"host_vars"</span></span>
<span class="highlight-line">			<span class="token keyword">elif</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>entity<span class="token punctuation">,</span> Group<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="highlight-line">				subdir <span class="token operator">=</span> <span class="token string">"group_vars"</span></span>
<span class="highlight-line">			<span class="token keyword">else</span><span class="token punctuation">:</span></span>
<span class="highlight-line">				<span class="token keyword">raise</span> AnsibleParserError<span class="token punctuation">(</span></span>
<span class="highlight-line">					<span class="token string">"Supplied entity must be Host or Group, got %s instead"</span> <span class="token operator">%</span> <span class="token punctuation">(</span><span class="token builtin">type</span><span class="token punctuation">(</span>entity<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="highlight-line">				<span class="token punctuation">)</span></span>
<span class="highlight-line"></span>
<span class="highlight-line">			<span class="token comment"># avoid 'chroot' type inventory hostnames /path/to/chroot</span></span>
<span class="highlight-line">			<span class="token keyword">if</span> entity<span class="token punctuation">.</span>name<span class="token punctuation">.</span>startswith<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>sep<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="highlight-line">				<span class="token keyword">continue</span></span>
<span class="highlight-line"></span>
<span class="highlight-line">			<span class="token keyword">try</span><span class="token punctuation">:</span></span>
<span class="highlight-line">				<span class="token comment"># mostly copied from host_group_vars</span></span>
<span class="highlight-line">				found_files <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span></span>
<span class="highlight-line">				<span class="token comment"># load vars</span></span>
<span class="highlight-line">				b_opath <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>realpath<span class="token punctuation">(</span>to_bytes<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>self<span class="token punctuation">.</span>_basedir<span class="token punctuation">,</span> subdir<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="highlight-line">				opath <span class="token operator">=</span> to_text<span class="token punctuation">(</span>b_opath<span class="token punctuation">)</span></span>
<span class="highlight-line">				self<span class="token punctuation">.</span>_display<span class="token punctuation">.</span>v<span class="token punctuation">(</span><span class="token string">"\tprocessing dir %s"</span> <span class="token operator">%</span> opath<span class="token punctuation">)</span></span>
<span class="highlight-line"></span>
<span class="highlight-line">				<span class="token comment"># We set the cache key to be specific to both entity and file</span></span>
<span class="highlight-line">				key <span class="token operator">=</span> <span class="token string">"%s.%s"</span> <span class="token operator">%</span> <span class="token punctuation">(</span>entity<span class="token punctuation">.</span>name<span class="token punctuation">,</span> opath<span class="token punctuation">)</span></span>
<span class="highlight-line">				<span class="token keyword">if</span> cache <span class="token keyword">and</span> key <span class="token keyword">in</span> FOUND<span class="token punctuation">:</span></span>
<span class="highlight-line">					<span class="token comment"># cache hit</span></span>
<span class="highlight-line">					found_files <span class="token operator">=</span> FOUND<span class="token punctuation">[</span>key<span class="token punctuation">]</span></span>
<span class="highlight-line">				<span class="token keyword">else</span><span class="token punctuation">:</span></span>
<span class="highlight-line">					<span class="token keyword">if</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>b_opath<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="highlight-line">						<span class="token keyword">if</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>isdir<span class="token punctuation">(</span>b_opath<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="highlight-line">							self<span class="token punctuation">.</span>_display<span class="token punctuation">.</span>debug<span class="token punctuation">(</span><span class="token string">"\tprocessing dir %s"</span> <span class="token operator">%</span> opath<span class="token punctuation">)</span></span>
<span class="highlight-line">							<span class="token comment"># use the file loader to load</span></span>
<span class="highlight-line">							found_files <span class="token operator">=</span> loader<span class="token punctuation">.</span>find_vars_files<span class="token punctuation">(</span></span>
<span class="highlight-line">								path<span class="token operator">=</span>opath<span class="token punctuation">,</span></span>
<span class="highlight-line">								name<span class="token operator">=</span>entity<span class="token punctuation">.</span>name<span class="token punctuation">,</span></span>
<span class="highlight-line">								extensions<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">""</span><span class="token punctuation">,</span> <span class="token string">".dhall"</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="highlight-line">								<span class="token comment"># allow_dir=True</span></span>
<span class="highlight-line">							<span class="token punctuation">)</span></span>
<span class="highlight-line">						<span class="token keyword">else</span><span class="token punctuation">:</span></span>
<span class="highlight-line">							self<span class="token punctuation">.</span>_display<span class="token punctuation">.</span>warning<span class="token punctuation">(</span></span>
<span class="highlight-line">								<span class="token string">"Found %s that is not a directory, skipping: %s"</span> <span class="token operator">%</span> <span class="token punctuation">(</span>subdir<span class="token punctuation">,</span> opath<span class="token punctuation">)</span></span>
<span class="highlight-line">							<span class="token punctuation">)</span></span>
<span class="highlight-line"></span>
<span class="highlight-line">				<span class="token keyword">for</span> found <span class="token keyword">in</span> found_files<span class="token punctuation">:</span></span>
<span class="highlight-line">					new_data <span class="token operator">=</span> _read_dhall_file<span class="token punctuation">(</span>found<span class="token punctuation">)</span></span>
<span class="highlight-line">					<span class="token keyword">if</span> new_data<span class="token punctuation">:</span>  <span class="token comment"># ignore empty files</span></span>
<span class="highlight-line">						data <span class="token operator">=</span> combine_vars<span class="token punctuation">(</span>data<span class="token punctuation">,</span> new_data<span class="token punctuation">)</span></span>
<span class="highlight-line"></span>
<span class="highlight-line">			<span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span></span>
<span class="highlight-line">				<span class="token keyword">raise</span> AnsibleParserError<span class="token punctuation">(</span>to_native<span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="highlight-line"></span>
<span class="highlight-line">		<span class="token keyword">return</span> data</span>
<span class="highlight-line"></span>
<span class="highlight-line"></span>
<span class="highlight-line"><span class="token keyword">def</span> <span class="token function">_read_dhall_file</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="highlight-line">	<span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> <span class="token string">"r"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span></span>
<span class="highlight-line">		ctn <span class="token operator">=</span> f<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="highlight-line">		<span class="token builtin">vars</span> <span class="token operator">=</span> dhall<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>ctn<span class="token punctuation">)</span></span>
<span class="highlight-line">	<span class="token keyword">return</span> <span class="token builtin">vars</span></span></code></pre>
<h2 id="execution" tabindex="-1"><a class="direct-link" href="#execution">Execution</a></h2>
<p>Vars plugins are invoked at 2 stages:</p>
<ol>
<li>Inventory : upon initial inventory parsing</li>
</ol>
<ul>
<li>once for every group (including &quot;all&quot; and &quot;ungrouped&quot;)</li>
<li>once for every host</li>
</ul>
<ol>
<li>Task : every task</li>
</ol>
<ul>
<li>once per cartesian product of:
<ul>
<li>entity: hostname or group involved in the play</li>
<li>path:
<ul>
<li>each inventory source path</li>
<li>the basedir for the play (or the nested play)</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>This can be specified with the option specified in the documentation.</p>
<p>This is why you want your plugin to implement a load phase and some form of caching!</p>

</div>
</article>



<hr>
<ul><li>Next: <a href="/posts/ansible_httpapi_plugins/">Understanding Ansible HttpApi plugins</a></li><li>Previous: <a href="/posts/ansible_writing_filter_plugin/">Writing a Filter Plugin in Ansible</a></li>
</ul>

		</main>
		<nav class="nav">
			<ul>
				<li class="nav-item"><a
						href="/">Home</a></li>
				<li class="nav-item"><a
						href="/posts/">Archive</a></li>
				<li class="nav-item"><a
						href="/tags/">Tags</a></li>
				<li class="nav-item"><a
						href="/series/">Series</a></li>
				<li class="nav-item"><a
						href="/about/">About Me</a></li>
				<li class="nav-item"><a
						href="/colophon/">Colophon</a></li>
				<li class="nav-item"><a
						href="/feedlist/">Feeds</a></li>
			</ul>
		</nav>
	</div>
</div>
<footer></footer>

<!-- Current page: /posts/ansible_writing_facts_plugin/ -->
</body>
</html>
