<!doctype html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Testing Azure Durable Functions in Python</title>
	<meta name="description" content="It is possible to test Azure Durable Functions in Python, but it&#39;s more difficult than you&#39;d want and not for the reasons you&#39;d expect">
	<link rel="stylesheet" href="/css/index.css">
	<link rel="stylesheet" href="/css/prism-base16-monokai.dark.css">
	<link rel="alternate" href="/feed/feed.xml" type="application/atom+xml"
		  title="lilatomic">
	<link rel="alternate" href="/feed/feed.json" type="application/json"
		  title="lilatomic">
</head>
<body>
<div class="ctn">
	<header>
		<h1 class="home"><a id="home" href="/">lilatomic</a></h1>
	</header>
	<div id="main">
		<main  class="tmpl-post" >

			
<article>
<h1>Testing Azure Durable Functions in Python</h1>

<aside id="tagbox">
<p>Tags</p>

  <a href="/tags/serverless/" class="post-tag">serverless</a>
  <a href="/tags/azure/" class="post-tag">azure</a>
  <a href="/tags/testing/" class="post-tag">testing</a>
  <a href="/tags/python/" class="post-tag">python</a>
</aside>





<aside id="toc">
	<nav class="toc" >
        <ol><li><a href="#background-%3A-python-generators">Background : Python Generators</a></li><li><a href="#background-%3A-a-basic-executor">Background : A basic executor</a></li><li><a href="#background-%3A-examining-the-source-code">Background : Examining the source code</a><ol><li><a href="#user-code-generator">User code generator</a></li><li><a href="#iterating-over-the-tasks">Iterating over the tasks</a></li></ol></li><li><a href="#mocking-durable-functions">Mocking durable functions</a><ol><li><a href="#durableorchestrationcontext">DurableOrchestrationContext</a></li><li><a href="#creating-a-mock-executor">Creating a mock executor</a></li><li><a href="#mocking-the-evaluation-of-remote-calls">Mocking the evaluation of remote calls</a></li></ol></li><li><a href="#making-a-useful-mocking-library">Making a useful mocking library</a></li></ol>
      </nav>
</aside>

<div class="content">
<!-- prettier-ignore-start -->
<!-- prettier-ignore-end -->
<h1 id="testing-azure-durable-functions-in-python" tabindex="-1">Testing Azure Durable Functions in Python <a class="direct-link" href="#testing-azure-durable-functions-in-python">#</a></h1>
<p><a href="#making-a-useful-mocking-library">TLDR</a></p>
<p>Azure Durable Functions allow you to use Azure Serverless Functions to make workflows and to implement a number of standard patterns for enterprise systems. Obviously, we'd like to test our code. But the Serverless paradigm does not lend itself well to rapid cycle times and deep testing. Every deploy-test-evaluate cycle to a testing instance in Azure takes about 5 minutes, especially if you've bought into the whole stack and are monitoring with AppInsights. Plus, it's difficult to test for error conditions if you have to actually produce them in an environment rather than being able to mock them in. Wouldn't it be nice if we could test these function like they were normal functions with all the techniques and tools that we developed for those?</p>
<p>Forunately, Azure Functions are amenable to this. But most of the examples are wrong.</p>
<h2 id="background-%3A-python-generators" tabindex="-1">Background : Python Generators <a class="direct-link" href="#background-%3A-python-generators">#</a></h2>
<p>ADFs make use of Python generators to invoke other functions. Here's an example from the <a href="https://docs.microsoft.com/en-us/azure/azure-functions/durable/durable-functions-sequence?tabs=python">tutorial</a>:</p>
<pre class="language-python"><code class="language-python"><span class="highlight-line">result1 <span class="token operator">=</span> <span class="token keyword">yield</span> context<span class="token punctuation">.</span>call_activity<span class="token punctuation">(</span><span class="token string">'E1_SayHello'</span><span class="token punctuation">,</span> <span class="token string">"Tokyo"</span><span class="token punctuation">)</span></span></code></pre>
<p>If you're only a little familiar with Python generators, you've probably seen them as a way to generate a (possible infinite) sequence of values. The example from the <a href="https://wiki.python.org/moin/Generators">Python wiki</a> generates a series of numbers up to a value:</p>
<pre class="language-python"><code class="language-python"><span class="highlight-line"><span class="token keyword">def</span> <span class="token function">first_n</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="highlight-line">	num <span class="token operator">=</span> <span class="token number">0</span></span>
<span class="highlight-line">	<span class="token keyword">while</span> num <span class="token operator">&lt;</span> n<span class="token punctuation">:</span></span>
<span class="highlight-line">		<span class="token keyword">yield</span> num</span>
<span class="highlight-line">		num <span class="token operator">+=</span> <span class="token number">1</span></span></code></pre>
<p>The syntax here is a bit different than the one used in the <abbr title="Azure Durable Function">ADF</abbr>, in that the return of the yield statement is discarded. If you're more familiar with Python generators, you might know that the <code>yield</code> statement can have a return value if you're using it to send values <em>to</em> a generator and get a return from it using the <code>send</code> keyword:</p>
<pre class="language-python"><code class="language-python"><span class="highlight-line"><span class="token keyword">def</span> <span class="token function">useful</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="highlight-line">	n <span class="token operator">=</span> <span class="token number">0</span></span>
<span class="highlight-line">	<span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span></span>
<span class="highlight-line">		x <span class="token operator">=</span> n <span class="token operator">*</span> <span class="token number">2</span></span>
<span class="highlight-line">		n <span class="token operator">=</span> <span class="token keyword">yield</span> x</span></code></pre>
<p>We can then use it with</p>
<pre class="language-python"><code class="language-python"><span class="highlight-line"><span class="token operator">>></span><span class="token operator">></span> g <span class="token operator">=</span> useful<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="highlight-line"><span class="token operator">>></span><span class="token operator">></span> g<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token boolean">None</span><span class="token punctuation">)</span> <span class="token comment"># prime the generator</span></span>
<span class="highlight-line"><span class="token number">0</span></span>
<span class="highlight-line"><span class="token operator">>></span><span class="token operator">></span> g<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token number">42</span><span class="token punctuation">)</span></span>
<span class="highlight-line"><span class="token number">84</span></span></code></pre>
<p>But this is actually hiding some complexity, which we can see if we instrument this function. We could use print statements, but we're going to need some more sophisticated instrumentation later, so we're instead going to just push things onto a list:</p>
<pre class="language-python"><code class="language-python"><span class="highlight-line">e <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span></span>
<span class="highlight-line"><span class="token keyword">def</span> <span class="token function">log</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="highlight-line">	e<span class="token punctuation">.</span>append<span class="token punctuation">(</span>event<span class="token punctuation">)</span></span>
<span class="highlight-line"></span>
<span class="highlight-line"><span class="token keyword">def</span> <span class="token function">useful</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="highlight-line">	r <span class="token operator">=</span> <span class="token number">0</span></span>
<span class="highlight-line">	log<span class="token punctuation">(</span><span class="token string">"init"</span><span class="token punctuation">)</span></span>
<span class="highlight-line">	<span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span></span>
<span class="highlight-line">		log<span class="token punctuation">(</span><span class="token string">"start of loop"</span><span class="token punctuation">)</span></span>
<span class="highlight-line">		x <span class="token operator">=</span> r <span class="token operator">*</span> <span class="token number">2</span></span>
<span class="highlight-line">		log<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"computation done: </span><span class="token interpolation"><span class="token punctuation">{</span>r<span class="token punctuation">}</span></span><span class="token string"> * 2 = </span><span class="token interpolation"><span class="token punctuation">{</span>x<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span></span>
<span class="highlight-line">		r <span class="token operator">=</span> <span class="token keyword">yield</span> x</span>
<span class="highlight-line">		log<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"yielded </span><span class="token interpolation"><span class="token punctuation">{</span>x<span class="token operator">=</span><span class="token punctuation">}</span></span><span class="token string">, got </span><span class="token interpolation"><span class="token punctuation">{</span>r<span class="token operator">=</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span></span></code></pre>
<p>We can test this out with</p>
<pre class="language-python"><code class="language-python"><span class="highlight-line">g <span class="token operator">=</span> useful<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="highlight-line">log<span class="token punctuation">(</span>g<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="highlight-line">log<span class="token punctuation">(</span><span class="token string">"sending 10"</span><span class="token punctuation">)</span></span>
<span class="highlight-line">log<span class="token punctuation">(</span>g<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="highlight-line">log<span class="token punctuation">(</span><span class="token string">"sending 11"</span><span class="token punctuation">)</span></span>
<span class="highlight-line">log<span class="token punctuation">(</span>g<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span></code></pre>
<p>This gives us about what we'd expect:</p>
<pre class="language-python"><code class="language-python"><span class="highlight-line"><span class="token punctuation">[</span><span class="token string">'init'</span><span class="token punctuation">,</span></span>
<span class="highlight-line"> <span class="token string">'start of loop'</span><span class="token punctuation">,</span></span>
<span class="highlight-line"> <span class="token string">'computation done: 0 * 2 = 0'</span><span class="token punctuation">,</span></span>
<span class="highlight-line"> <span class="token number">0</span><span class="token punctuation">,</span></span>
<span class="highlight-line"> <span class="token string">'sending 10'</span><span class="token punctuation">,</span></span>
<span class="highlight-line"> <span class="token string">'yielded x=0, got r=10'</span><span class="token punctuation">,</span></span>
<span class="highlight-line"> <span class="token string">'start of loop'</span><span class="token punctuation">,</span></span>
<span class="highlight-line"> <span class="token string">'computation done: 10 * 2 = 20'</span><span class="token punctuation">,</span></span>
<span class="highlight-line"> <span class="token number">20</span><span class="token punctuation">,</span></span>
<span class="highlight-line"> <span class="token string">'sending 11'</span><span class="token punctuation">,</span></span>
<span class="highlight-line"> <span class="token string">'yielded x=20, got r=11'</span><span class="token punctuation">,</span></span>
<span class="highlight-line"> <span class="token string">'start of loop'</span><span class="token punctuation">,</span></span>
<span class="highlight-line"> <span class="token string">'computation done: 11 * 2 = 22'</span><span class="token punctuation">,</span></span>
<span class="highlight-line"> <span class="token number">22</span><span class="token punctuation">]</span></span></code></pre>
<p>What complexity is that hiding? From one perspective, none. This is exactly what the <code>send</code> keyword was built for. Of course this is how you build coroutines. But there is a key difference between a coroutine and an <abbr title="Azure Durable Function">ADF</abbr>: the <abbr title="Azure Durable Function">ADF</abbr> is the one doing the driving. That is, in this example, we sent values to the generator and got results back; but in an <abbr title="Azure Durable Function">ADF</abbr>, the generator submits tasks nebulously and gets the results back. This is completely backwards. For example, we normally have a function that looks something like this:</p>
<pre class="language-python"><code class="language-python"><span class="highlight-line"><span class="token keyword">import</span> azure<span class="token punctuation">.</span>functions <span class="token keyword">as</span> func</span>
<span class="highlight-line"><span class="token keyword">import</span> azure<span class="token punctuation">.</span>durable_functions <span class="token keyword">as</span> df</span>
<span class="highlight-line"></span>
<span class="highlight-line"></span>
<span class="highlight-line"><span class="token keyword">def</span> <span class="token function">orchestrator_function</span><span class="token punctuation">(</span>context<span class="token punctuation">:</span> df<span class="token punctuation">.</span>DurableOrchestrationContext<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="highlight-line">	result1 <span class="token operator">=</span> <span class="token keyword">yield</span> context<span class="token punctuation">.</span>call_activity<span class="token punctuation">(</span><span class="token string">'E1_SayHello'</span><span class="token punctuation">,</span> <span class="token string">"Tokyo"</span><span class="token punctuation">)</span></span>
<span class="highlight-line">	result2 <span class="token operator">=</span> <span class="token keyword">yield</span> context<span class="token punctuation">.</span>call_activity<span class="token punctuation">(</span><span class="token string">'E1_SayHello'</span><span class="token punctuation">,</span> <span class="token string">"Seattle"</span><span class="token punctuation">)</span></span>
<span class="highlight-line">	result3 <span class="token operator">=</span> <span class="token keyword">yield</span> context<span class="token punctuation">.</span>call_activity<span class="token punctuation">(</span><span class="token string">'E1_SayHello'</span><span class="token punctuation">,</span> <span class="token string">"London"</span><span class="token punctuation">)</span></span>
<span class="highlight-line">	<span class="token keyword">return</span> <span class="token punctuation">[</span>result1<span class="token punctuation">,</span> result2<span class="token punctuation">,</span> result3<span class="token punctuation">]</span></span>
<span class="highlight-line"></span>
<span class="highlight-line">main <span class="token operator">=</span> df<span class="token punctuation">.</span>Orchestrator<span class="token punctuation">.</span>create<span class="token punctuation">(</span>orchestrator_function<span class="token punctuation">)</span></span>
<span class="highlight-line"></span></code></pre>
<p>So what happens if we make a generator which looks like that?</p>
<pre class="language-python"><code class="language-python"><span class="highlight-line"><span class="token keyword">def</span> <span class="token function">workflow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="highlight-line">	log<span class="token punctuation">(</span><span class="token string">"init"</span><span class="token punctuation">)</span></span>
<span class="highlight-line">	x <span class="token operator">=</span> <span class="token number">0</span></span>
<span class="highlight-line">	r <span class="token operator">=</span> <span class="token keyword">yield</span> x</span>
<span class="highlight-line">	log<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"yielded </span><span class="token interpolation"><span class="token punctuation">{</span>x<span class="token operator">=</span><span class="token punctuation">}</span></span><span class="token string">, got </span><span class="token interpolation"><span class="token punctuation">{</span>r<span class="token operator">=</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span></span>
<span class="highlight-line">	x <span class="token operator">=</span> <span class="token number">1</span></span>
<span class="highlight-line">	r <span class="token operator">=</span> <span class="token keyword">yield</span> x</span>
<span class="highlight-line">	log<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"yielded </span><span class="token interpolation"><span class="token punctuation">{</span>x<span class="token operator">=</span><span class="token punctuation">}</span></span><span class="token string">, got </span><span class="token interpolation"><span class="token punctuation">{</span>r<span class="token operator">=</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span></span>
<span class="highlight-line">	x <span class="token operator">=</span> <span class="token number">2</span></span>
<span class="highlight-line">	r <span class="token operator">=</span> <span class="token keyword">yield</span> x</span>
<span class="highlight-line">	log<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"yielded </span><span class="token interpolation"><span class="token punctuation">{</span>x<span class="token operator">=</span><span class="token punctuation">}</span></span><span class="token string">, got </span><span class="token interpolation"><span class="token punctuation">{</span>r<span class="token operator">=</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span></span>
<span class="highlight-line">	<span class="token keyword">return</span> <span class="token string-interpolation"><span class="token string">f"return value </span><span class="token interpolation"><span class="token punctuation">{</span>r<span class="token operator">=</span><span class="token punctuation">}</span></span><span class="token string">"</span></span></span>
<span class="highlight-line"></span></code></pre>
<p>Let's pretend that we're submitting tasks and we want the number to be added to 100:</p>
<pre class="language-python"><code class="language-python"><span class="highlight-line">g <span class="token operator">=</span> workflow<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="highlight-line">log<span class="token punctuation">(</span>g<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="highlight-line">log<span class="token punctuation">(</span>g<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="highlight-line">log<span class="token punctuation">(</span>g<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token number">101</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="highlight-line">log<span class="token punctuation">(</span>g<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token number">102</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="highlight-line"></span></code></pre>
<p>we get</p>
<pre class="language-python"><code class="language-python"><span class="highlight-line">Traceback <span class="token punctuation">(</span>most recent call last<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="highlight-line">  File <span class="token string">"_includes/resources/azure_functions/durable_testing_python/00_generator_like_sample.py"</span><span class="token punctuation">,</span> line <span class="token number">25</span><span class="token punctuation">,</span> <span class="token keyword">in</span> <span class="token operator">&lt;</span>module<span class="token operator">></span></span>
<span class="highlight-line">    log<span class="token punctuation">(</span>g<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token number">102</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="highlight-line">StopIteration<span class="token punctuation">:</span> <span class="token number">102</span></span>
<span class="highlight-line"><span class="token operator">>></span><span class="token operator">></span> pprint<span class="token punctuation">.</span>pp<span class="token punctuation">(</span>e<span class="token punctuation">)</span></span>
<span class="highlight-line"><span class="token punctuation">[</span><span class="token string">'init'</span><span class="token punctuation">,</span></span>
<span class="highlight-line"> <span class="token number">0</span><span class="token punctuation">,</span></span>
<span class="highlight-line"> <span class="token string">'yielded x=0, got r=100'</span><span class="token punctuation">,</span></span>
<span class="highlight-line"> <span class="token number">1</span><span class="token punctuation">,</span></span>
<span class="highlight-line"> <span class="token string">'yielded x=1, got r=101'</span><span class="token punctuation">,</span></span>
<span class="highlight-line"> <span class="token number">2</span><span class="token punctuation">,</span></span>
<span class="highlight-line"> <span class="token string">'yielded x=2, got r=102'</span><span class="token punctuation">]</span></span></code></pre>
<p>Well that makes sense. It's a bit weird that the return value comes in the <code>StopIteration</code>, but it's in the documentation for generators.</p>
<h2 id="background-%3A-a-basic-executor" tabindex="-1">Background : A basic executor <a class="direct-link" href="#background-%3A-a-basic-executor">#</a></h2>
<p>Let's pretend that instead of mocking out the dispatching, we actually wanted to run the <abbr title="Azure Durable Function">ADF</abbr>. With the knowledge we gained from exploring generators previously, we know that we'll have 3 different conditions to handle:</p>
<ul>
<li>the initial task which will be submitted through the priming (with <code>send(None)</code>)</li>
<li>all the intermediate executions</li>
<li>the return value which will be sent in a <code>StopIteration</code></li>
</ul>
<p>We can then bang out the following executor:</p>
<pre class="language-python"><code class="language-python"><span class="highlight-line"><span class="token keyword">def</span> <span class="token function">executor</span><span class="token punctuation">(</span>generator<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="highlight-line">	log<span class="token punctuation">(</span><span class="token string">"init executor"</span><span class="token punctuation">)</span></span>
<span class="highlight-line">	arg <span class="token operator">=</span> generator<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token boolean">None</span><span class="token punctuation">)</span></span>
<span class="highlight-line">	<span class="token keyword">try</span><span class="token punctuation">:</span></span>
<span class="highlight-line">		log<span class="token punctuation">(</span><span class="token string">"entering loop"</span><span class="token punctuation">)</span></span>
<span class="highlight-line">		<span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span></span>
<span class="highlight-line">			value <span class="token operator">=</span> useful<span class="token punctuation">(</span>arg<span class="token punctuation">)</span></span>
<span class="highlight-line">			log<span class="token punctuation">(</span>value<span class="token punctuation">)</span></span>
<span class="highlight-line">			arg <span class="token operator">=</span> generator<span class="token punctuation">.</span>send<span class="token punctuation">(</span>value<span class="token punctuation">)</span></span>
<span class="highlight-line">	<span class="token keyword">except</span> StopIteration <span class="token keyword">as</span> ret<span class="token punctuation">:</span></span>
<span class="highlight-line">		log<span class="token punctuation">(</span><span class="token string">"stopped iteration"</span><span class="token punctuation">)</span></span>
<span class="highlight-line">		log<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"return value is </span><span class="token interpolation"><span class="token punctuation">{</span>ret<span class="token punctuation">.</span>value<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span></span></code></pre>
<p>We can also restart it equivalently as follows, although I'm not sure it's clearer.</p>
<pre class="language-python"><code class="language-python"><span class="highlight-line"><span class="token keyword">def</span> <span class="token function">executor</span><span class="token punctuation">(</span>generator<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="highlight-line">	log<span class="token punctuation">(</span><span class="token string">"init executor"</span><span class="token punctuation">)</span></span>
<span class="highlight-line">	value <span class="token operator">=</span> <span class="token boolean">None</span></span>
<span class="highlight-line">	<span class="token keyword">try</span><span class="token punctuation">:</span></span>
<span class="highlight-line">		log<span class="token punctuation">(</span><span class="token string">"entering loop"</span><span class="token punctuation">)</span></span>
<span class="highlight-line">		<span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span></span>
<span class="highlight-line">			arg <span class="token operator">=</span> generator<span class="token punctuation">.</span>send<span class="token punctuation">(</span>value<span class="token punctuation">)</span></span>
<span class="highlight-line">			value <span class="token operator">=</span> useful<span class="token punctuation">(</span>arg<span class="token punctuation">)</span></span>
<span class="highlight-line">			log<span class="token punctuation">(</span>value<span class="token punctuation">)</span></span>
<span class="highlight-line">	<span class="token keyword">except</span> StopIteration <span class="token keyword">as</span> ret<span class="token punctuation">:</span></span>
<span class="highlight-line">		log<span class="token punctuation">(</span><span class="token string">"stopped iteration"</span><span class="token punctuation">)</span></span>
<span class="highlight-line">		log<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"return value is </span><span class="token interpolation"><span class="token punctuation">{</span>ret<span class="token punctuation">.</span>value<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span></span></code></pre>
<p>This simple executor suggests an alternative for mocking the functions that our orchestrator calls out to. Instead of trying to patch those functions, we could simply execute the function-under-test with an executor which will provide the answers we need. This means that we can't use fun mocking libraries out-of-the-box, but it also means that we might not need to use them.</p>
<h2 id="background-%3A-examining-the-source-code" tabindex="-1">Background : Examining the source code <a class="direct-link" href="#background-%3A-examining-the-source-code">#</a></h2>
<p>Microsoft has been open-sourcing a lot of their stuff. This is very convenient for them: Every time their documentation is missing something very basic, if it happens to be important enough for a company, that company might pay someone to dig into that code and write up that documentation.</p>
<p>There are 3 relevant repositories:</p>
<ul>
<li><a href="https://github.com/Azure/azure-functions-python-worker">azure-fucntions-python-worker</a> : the thing that loads functions and dispatches calls</li>
<li><a href="https://github.com/Azure/azure-functions-python-library">azure-functions-python-library</a> : contains various bits for bindings and extensions</li>
<li><a href="https://github.com/Azure/azure-functions-durable-python">azure-functions-durable-python</a> : the extension for ADFs</li>
</ul>
<p>The 3rd is the important one. The executor is called <a href="https://github.com/Azure/azure-functions-durable-python/blob/9a02c58616a5de272ea7ad81c7071449b83509ab/azure/durable_functions/models/TaskOrchestrationExecutor.py">TaskOrchestrationExecutor</a>. You'll notice that you can't find calls which invoke the <code>__next__()</code> method (either the <code>next</code> keyword or hidden in iterable operations, like <code>list(generator)</code>) on the generator itself. But it does call <code>send</code> on that generator <a href="https://github.com/Azure/azure-functions-durable-python/blob/9a02c58616a5de272ea7ad81c7071449b83509ab/azure/durable_functions/models/TaskOrchestrationExecutor.py#L214">here</a>. They do iterate over the <code>history</code> <a href="https://github.com/Azure/azure-functions-durable-python/blob/9a02c58616a5de272ea7ad81c7071449b83509ab/azure/durable_functions/models/TaskOrchestrationExecutor.py#L76">here</a>, but it's not as straightforward as that.</p>
<h3 id="user-code-generator" tabindex="-1">User code generator <a class="direct-link" href="#user-code-generator">#</a></h3>
<p>We'll start closest to our code: the <code>resume_user_code</code> function. I'll first point out that they catch the <code>StopIteration</code> and mark that as the function output, just like out little executor. The most interesting part is:</p>
<pre class="language-python"><code class="language-python"><span class="highlight-line"><span class="token comment"># resume orchestration with a resolved task's value</span></span>
<span class="highlight-line">task_value <span class="token operator">=</span> current_task<span class="token punctuation">.</span>result</span>
<span class="highlight-line">task_succeeded <span class="token operator">=</span> current_task<span class="token punctuation">.</span>state <span class="token keyword">is</span> TaskState<span class="token punctuation">.</span>SUCCEEDED</span>
<span class="highlight-line">new_task <span class="token operator">=</span> self<span class="token punctuation">.</span>generator<span class="token punctuation">.</span>send<span class="token punctuation">(</span></span>
<span class="highlight-line">	task_value<span class="token punctuation">)</span> <span class="token keyword">if</span> task_succeeded <span class="token keyword">else</span> self<span class="token punctuation">.</span>generator<span class="token punctuation">.</span>throw<span class="token punctuation">(</span>task_value<span class="token punctuation">)</span></span>
<span class="highlight-line">self<span class="token punctuation">.</span>context<span class="token punctuation">.</span>_add_to_open_tasks<span class="token punctuation">(</span>new_task<span class="token punctuation">)</span></span></code></pre>
<p>It's a bit hard to parse out, but this code uses the <code>send</code> to send the previous result <em>and</em> to get the next task at the same time. Just like our little executor!<br>
Later, it also shuffles the new task to the current task, and adds it to the list of actions in the <code>context</code>.But if you trace it, you find that this doesnt actually trigger any further execution.</p>
<h3 id="iterating-over-the-tasks" tabindex="-1">Iterating over the tasks <a class="direct-link" href="#iterating-over-the-tasks">#</a></h3>
<p>The only iteration we've seen is over the <code>history</code> parameter. This is passed into the <code>TaskOrchestrationExecutor.execute</code> method. You have to dig in to the internals of the <abbr title="Azure Durable Function">ADF</abbr> execution to find where this comes from. Essentially, every time a function is ready to advance, the entire function up to that point will be invoked. Every time a task is created (with <code>yield context.call_activity(...)</code>, for example), that result has been serialised and is passed back into the function. The orchestrator can then advance until it hits a <code>yield</code> statement which creates a new task.</p>
<p>This replay behaviour is somewhat described in the article on <a href="https://docs.microsoft.com/en-us/azure/azure-functions/durable/durable-functions-code-constraints">Orchestrator function code constraints</a>. The focus isn't really on the implementation; it's on the natural consequence that only deterministic APIs can be used.</p>
<p>You can see the replay behaviour for yourself by instrumenting a basic function.</p>
<pre class="language-python"><code class="language-python"><span class="highlight-line"><span class="token keyword">import</span> azure<span class="token punctuation">.</span>durable_functions <span class="token keyword">as</span> df</span>
<span class="highlight-line"></span>
<span class="highlight-line"><span class="token keyword">class</span> <span class="token class-name">Logotron</span><span class="token punctuation">:</span></span>
<span class="highlight-line">    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token boolean">None</span><span class="token punctuation">:</span></span>
<span class="highlight-line">        self<span class="token punctuation">.</span>i <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span></span>
<span class="highlight-line">        self<span class="token punctuation">.</span>l <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span></span>
<span class="highlight-line"></span>
<span class="highlight-line">    <span class="token keyword">def</span> <span class="token function">new_span</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="highlight-line">        self<span class="token punctuation">.</span>i <span class="token operator">+=</span><span class="token number">1</span></span>
<span class="highlight-line">        self<span class="token punctuation">.</span>l<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span></span>
<span class="highlight-line">    </span>
<span class="highlight-line">    <span class="token keyword">def</span> <span class="token function">log</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="highlight-line">        self<span class="token punctuation">.</span>l<span class="token punctuation">[</span>self<span class="token punctuation">.</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span>e<span class="token punctuation">)</span></span>
<span class="highlight-line"></span>
<span class="highlight-line">logotron <span class="token operator">=</span> Logotron<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="highlight-line"></span>
<span class="highlight-line"><span class="token keyword">def</span> <span class="token function">orchestrator_function</span><span class="token punctuation">(</span>context<span class="token punctuation">:</span> df<span class="token punctuation">.</span>DurableOrchestrationContext<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="highlight-line">    logotron<span class="token punctuation">.</span>new_span<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="highlight-line">    logotron<span class="token punctuation">.</span>log<span class="token punctuation">(</span><span class="token string">"Tokyo"</span><span class="token punctuation">)</span></span>
<span class="highlight-line">    result1 <span class="token operator">=</span> <span class="token keyword">yield</span> context<span class="token punctuation">.</span>call_activity<span class="token punctuation">(</span><span class="token string">'Hello'</span><span class="token punctuation">,</span> <span class="token string">"Tokyo"</span><span class="token punctuation">)</span></span>
<span class="highlight-line">    logotron<span class="token punctuation">.</span>log<span class="token punctuation">(</span><span class="token string">"Seattle"</span><span class="token punctuation">)</span></span>
<span class="highlight-line">    result2 <span class="token operator">=</span> <span class="token keyword">yield</span> context<span class="token punctuation">.</span>call_activity<span class="token punctuation">(</span><span class="token string">'Hello'</span><span class="token punctuation">,</span> <span class="token string">"Seattle"</span><span class="token punctuation">)</span></span>
<span class="highlight-line">    logotron<span class="token punctuation">.</span>log<span class="token punctuation">(</span><span class="token string">"London"</span><span class="token punctuation">)</span></span>
<span class="highlight-line">    result3 <span class="token operator">=</span> <span class="token keyword">yield</span> context<span class="token punctuation">.</span>call_activity<span class="token punctuation">(</span><span class="token string">'Hello'</span><span class="token punctuation">,</span> <span class="token string">"London"</span><span class="token punctuation">)</span></span>
<span class="highlight-line">    logotron<span class="token punctuation">.</span>log<span class="token punctuation">(</span><span class="token string">"Done"</span><span class="token punctuation">)</span></span>
<span class="highlight-line">    <span class="token keyword">return</span> logotron<span class="token punctuation">.</span>log</span>
<span class="highlight-line"></span>
<span class="highlight-line">main <span class="token operator">=</span> df<span class="token punctuation">.</span>Orchestrator<span class="token punctuation">.</span>create<span class="token punctuation">(</span>orchestrator_function<span class="token punctuation">)</span></span>
<span class="highlight-line"></span></code></pre>
<p>We then get this as the trace. We <em>also</em> get a <code>Non-Deterministic workflow detected</code> warning, which is True.</p>
<pre><code>[['Tokyo'],
 ['Tokyo', 'Seattle'],
 ['Tokyo', 'Seattle', 'London'],
 ['Tokyo', 'Seattle', 'London', 'Done']]
</code></pre>
<h2 id="mocking-durable-functions" tabindex="-1">Mocking durable functions <a class="direct-link" href="#mocking-durable-functions">#</a></h2>
<p>With all the background done, it looks like there are 3 parts to the challenge of implementing mocking for <abbr title="Azure Durable Function">ADF</abbr>:</p>
<ol>
<li>feeding in a DurableOrchestrationContext</li>
<li>creating a mock executor</li>
<li>mocking the evaluation of remote calls</li>
</ol>
<h3 id="durableorchestrationcontext" tabindex="-1">DurableOrchestrationContext <a class="direct-link" href="#durableorchestrationcontext">#</a></h3>
<p>There's a bit of shimming that you have to do to get one of these created, but you can just fake all the values and it seems to work as well as we need it to.</p>
<pre class="language-python"><code class="language-python"><span class="highlight-line"><span class="token keyword">def</span> <span class="token function">make_ctx</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> df<span class="token punctuation">.</span>DurableOrchestrationContext<span class="token punctuation">:</span></span>
<span class="highlight-line">	<span class="token triple-quoted-string string">"""Create a DurableOrchestrationContext by filling in dummy values """</span></span>
<span class="highlight-line">	fakeEvent <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="highlight-line">		<span class="token string">"EventType"</span><span class="token punctuation">:</span> <span class="token number">12</span><span class="token punctuation">,</span></span>
<span class="highlight-line">		<span class="token string">"EventId"</span><span class="token punctuation">:</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span></span>
<span class="highlight-line">		<span class="token string">"IsPlayed"</span><span class="token punctuation">:</span> <span class="token boolean">False</span><span class="token punctuation">,</span></span>
<span class="highlight-line">		<span class="token string">"Timestamp"</span><span class="token punctuation">:</span> datetime<span class="token punctuation">.</span>datetime<span class="token punctuation">.</span>utcnow<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>isoformat<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="highlight-line">	<span class="token punctuation">}</span></span>
<span class="highlight-line">	<span class="token keyword">return</span> df<span class="token punctuation">.</span>DurableOrchestrationContext<span class="token punctuation">(</span><span class="token punctuation">[</span>fakeEvent<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">,</span> <span class="token boolean">False</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span></span></code></pre>
<h3 id="creating-a-mock-executor" tabindex="-1">Creating a mock executor <a class="direct-link" href="#creating-a-mock-executor">#</a></h3>
<p>We've done most of the generator work for the executor. Now we have to build it to actually interpret the Tasks that are given to it. There are a few task types that we have to handle: <code>AtomicTask</code>, <code>WhenAllTask</code>, <code>WhenAnyTask</code>. We can also handle <code>RetryAbleTask</code> (subclass of <code>WhenAllTask</code>) and <code>TimerTask</code> (subclass of <code>AtomicTask</code>) separately if we choose, although I'm going to leave that as a contribution for the reader. Handling these is mostly a matter of dispatching down to the <code>AtomicTask</code>s in the <code>CompoundTask</code>s. After that, we just need to unwrap the requested <code>Action</code> and dispatch that to our mocks.</p>
<pre class="language-python"><code class="language-python"><span class="highlight-line">	<span class="token keyword">def</span> <span class="token function">execute</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> fn<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="highlight-line">		<span class="token triple-quoted-string string">"""Execute an orchestrator function with external calls mocked"""</span></span>
<span class="highlight-line">		ctx <span class="token operator">=</span> make_ctx<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="highlight-line">		g <span class="token operator">=</span> fn<span class="token punctuation">(</span>ctx<span class="token punctuation">)</span></span>
<span class="highlight-line">		result <span class="token operator">=</span> <span class="token boolean">None</span></span>
<span class="highlight-line">		<span class="token keyword">try</span><span class="token punctuation">:</span></span>
<span class="highlight-line">			<span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span></span>
<span class="highlight-line">				task <span class="token operator">=</span> g<span class="token punctuation">.</span>send<span class="token punctuation">(</span>result<span class="token punctuation">)</span></span>
<span class="highlight-line">				result <span class="token operator">=</span> self<span class="token punctuation">.</span>_handle<span class="token punctuation">(</span>task<span class="token punctuation">)</span></span>
<span class="highlight-line">		<span class="token keyword">except</span> StopIteration <span class="token keyword">as</span> ret<span class="token punctuation">:</span></span>
<span class="highlight-line">			<span class="token keyword">return</span> ret<span class="token punctuation">.</span>value</span></code></pre>
<h3 id="mocking-the-evaluation-of-remote-calls" tabindex="-1">Mocking the evaluation of remote calls <a class="direct-link" href="#mocking-the-evaluation-of-remote-calls">#</a></h3>
<p>The <code>Action</code> itself has 3 properties we care about:</p>
<ul>
<li>type (<code>ActionType</code>) : the category of thing we want invoked, like an Activity Function or a SubOrchestrator</li>
<li>function name : the name of that thing we want invoked</li>
<li>intput_ : the paylod to send to that function</li>
</ul>
<p>So now it's just a matter of building a system which can dispatch the first 2 and pass in the 3rd item. This too isn't hard. One hiccough is that some of the types are sortof equivalent from a unit-testing point of view (<code>CALL_ACTIVITY</code> vs <code>CALL_ACTIVITY_WITH_RETRY</code>). We don't need to handle <code>WHEN_ANY</code> or <code>WHEN_ALL</code> because we expand those into the component tasks, although we do need to add a way of determining which task to resolve.</p>
<p>There's honestly not much special with this code, so I'm just going to skip talking about it. you can see the whole resources in the repo.</p>
<h2 id="making-a-useful-mocking-library" tabindex="-1">Making a useful mocking library <a class="direct-link" href="#making-a-useful-mocking-library">#</a></h2>
<p>This executor is competent enough at walking through a function, but it lacks the ability to intelligently verify calls like other popular mocking libraries. Good thing all of our functions accept Task objects which contain the function invocation and the argument.<br>
We should try for a similar API to <code>unittest.mock</code>. Implementing it is straightforward, although does require a bit of gruntwork. Reporting results is where most of the utility comes from, and I'll admit that I skimped on that.</p>
<pre class="language-python"><code class="language-python"><span class="highlight-line"><span class="token keyword">import</span> copy</span>
<span class="highlight-line"><span class="token keyword">import</span> datetime</span>
<span class="highlight-line"><span class="token keyword">import</span> itertools</span>
<span class="highlight-line"><span class="token keyword">import</span> json</span>
<span class="highlight-line"><span class="token keyword">import</span> operator</span>
<span class="highlight-line"><span class="token keyword">import</span> random</span>
<span class="highlight-line"><span class="token keyword">from</span> collections <span class="token keyword">import</span> defaultdict</span>
<span class="highlight-line"><span class="token keyword">from</span> dataclasses <span class="token keyword">import</span> dataclass</span>
<span class="highlight-line"><span class="token keyword">from</span> typing <span class="token keyword">import</span> Callable<span class="token punctuation">,</span> Dict<span class="token punctuation">,</span> Iterable<span class="token punctuation">,</span> List<span class="token punctuation">,</span> NewType<span class="token punctuation">,</span> Union</span>
<span class="highlight-line"></span>
<span class="highlight-line"><span class="token keyword">import</span> azure<span class="token punctuation">.</span>durable_functions <span class="token keyword">as</span> df</span>
<span class="highlight-line"><span class="token keyword">import</span> azure<span class="token punctuation">.</span>durable_functions<span class="token punctuation">.</span>models<span class="token punctuation">.</span>actions <span class="token keyword">as</span> dfactions</span>
<span class="highlight-line"><span class="token keyword">import</span> azure<span class="token punctuation">.</span>durable_functions<span class="token punctuation">.</span>models<span class="token punctuation">.</span>Task <span class="token keyword">as</span> dftask</span>
<span class="highlight-line"></span>
<span class="highlight-line"></span>
<span class="highlight-line"><span class="token keyword">def</span> <span class="token function">make_ctx</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> df<span class="token punctuation">.</span>DurableOrchestrationContext<span class="token punctuation">:</span></span>
<span class="highlight-line">	<span class="token triple-quoted-string string">"""Create a DurableOrchestrationContext by filling in dummy values """</span></span>
<span class="highlight-line">	fakeEvent <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="highlight-line">		<span class="token string">"EventType"</span><span class="token punctuation">:</span> <span class="token number">12</span><span class="token punctuation">,</span></span>
<span class="highlight-line">		<span class="token string">"EventId"</span><span class="token punctuation">:</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span></span>
<span class="highlight-line">		<span class="token string">"IsPlayed"</span><span class="token punctuation">:</span> <span class="token boolean">False</span><span class="token punctuation">,</span></span>
<span class="highlight-line">		<span class="token string">"Timestamp"</span><span class="token punctuation">:</span> datetime<span class="token punctuation">.</span>datetime<span class="token punctuation">.</span>utcnow<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>isoformat<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="highlight-line">	<span class="token punctuation">}</span></span>
<span class="highlight-line">	<span class="token keyword">return</span> df<span class="token punctuation">.</span>DurableOrchestrationContext<span class="token punctuation">(</span><span class="token punctuation">[</span>fakeEvent<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">,</span> <span class="token boolean">False</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span></span>
<span class="highlight-line"></span>
<span class="highlight-line"></span>
<span class="highlight-line"><span class="token decorator annotation punctuation">@dataclass</span></span>
<span class="highlight-line"><span class="token keyword">class</span> <span class="token class-name">AZDFMock</span><span class="token punctuation">:</span></span>
<span class="highlight-line">	type_<span class="token punctuation">:</span> dfactions<span class="token punctuation">.</span>ActionType</span>
<span class="highlight-line">	name<span class="token punctuation">:</span> <span class="token builtin">str</span></span>
<span class="highlight-line">	fn<span class="token punctuation">:</span> Callable</span>
<span class="highlight-line"></span>
<span class="highlight-line"></span>
<span class="highlight-line">Handlers <span class="token operator">=</span> NewType<span class="token punctuation">(</span><span class="token string">"Handlers"</span><span class="token punctuation">,</span> Dict<span class="token punctuation">[</span>dfactions<span class="token punctuation">.</span>ActionType<span class="token punctuation">,</span> Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> Callable<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span></span>
<span class="highlight-line"></span>
<span class="highlight-line"></span>
<span class="highlight-line"><span class="token keyword">def</span> <span class="token function">mocks2handlers</span><span class="token punctuation">(</span>mocks<span class="token punctuation">:</span> List<span class="token punctuation">[</span>AZDFMock<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> Handlers<span class="token punctuation">:</span></span>
<span class="highlight-line">	by_type <span class="token operator">=</span> itertools<span class="token punctuation">.</span>groupby<span class="token punctuation">(</span>mocks<span class="token punctuation">,</span> key<span class="token operator">=</span>operator<span class="token punctuation">.</span>attrgetter<span class="token punctuation">(</span><span class="token string">"type_"</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="highlight-line">	handlers <span class="token operator">=</span> <span class="token punctuation">{</span>type_<span class="token punctuation">:</span> <span class="token punctuation">{</span>mock<span class="token punctuation">.</span>name<span class="token punctuation">:</span> mock<span class="token punctuation">.</span>fn <span class="token keyword">for</span> mock <span class="token keyword">in</span> mocks<span class="token punctuation">}</span> <span class="token keyword">for</span> type_<span class="token punctuation">,</span> mocks <span class="token keyword">in</span> by_type<span class="token punctuation">}</span></span>
<span class="highlight-line">	<span class="token keyword">return</span> handlers</span>
<span class="highlight-line"></span>
<span class="highlight-line"></span>
<span class="highlight-line"><span class="token keyword">def</span> <span class="token function">combine_handlers</span><span class="token punctuation">(</span>this<span class="token punctuation">,</span> that<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="highlight-line">	combined <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span>
<span class="highlight-line">	<span class="token keyword">for</span> type_ <span class="token keyword">in</span> dfactions<span class="token punctuation">.</span>ActionType<span class="token punctuation">:</span></span>
<span class="highlight-line">		combined<span class="token punctuation">[</span>type_<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token operator">**</span>this<span class="token punctuation">.</span>get<span class="token punctuation">(</span>type_<span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">**</span>that<span class="token punctuation">.</span>get<span class="token punctuation">(</span>type_<span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span>
<span class="highlight-line">	<span class="token keyword">return</span> combined</span>
<span class="highlight-line"></span>
<span class="highlight-line"></span>
<span class="highlight-line"><span class="token keyword">class</span> <span class="token class-name">MockExecutor</span><span class="token punctuation">:</span></span>
<span class="highlight-line">	<span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span></span>
<span class="highlight-line">		self<span class="token punctuation">,</span> handlers<span class="token punctuation">:</span> Handlers<span class="token punctuation">,</span> _select_winning_task<span class="token punctuation">:</span> dftask<span class="token punctuation">.</span>WhenAnyTask <span class="token operator">=</span> <span class="token boolean">None</span></span>
<span class="highlight-line">	<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token boolean">None</span><span class="token punctuation">:</span></span>
<span class="highlight-line">		self<span class="token punctuation">.</span>handlers <span class="token operator">=</span> handlers</span>
<span class="highlight-line">		self<span class="token punctuation">.</span>_select_winning_task <span class="token operator">=</span> _select_winning_task <span class="token keyword">or</span> self<span class="token punctuation">.</span>_select_random_task</span>
<span class="highlight-line"></span>
<span class="highlight-line">		self<span class="token punctuation">.</span>_calls <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span></span>
<span class="highlight-line">		self<span class="token punctuation">.</span>_invocations <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span></span>
<span class="highlight-line"></span>
<span class="highlight-line">	<span class="token decorator annotation punctuation">@staticmethod</span></span>
<span class="highlight-line">	<span class="token keyword">def</span> <span class="token function">_select_random_task</span><span class="token punctuation">(</span>task<span class="token punctuation">:</span> dftask<span class="token punctuation">.</span>WhenAnyTask<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="highlight-line">		<span class="token triple-quoted-string string">"""Resolve a WhenAnyTask by selecting a random Task. This is used as the default"""</span></span>
<span class="highlight-line">		<span class="token keyword">return</span> random<span class="token punctuation">.</span>choice<span class="token punctuation">(</span>task<span class="token punctuation">.</span>children<span class="token punctuation">)</span></span>
<span class="highlight-line"></span>
<span class="highlight-line">	<span class="token decorator annotation punctuation">@staticmethod</span></span>
<span class="highlight-line">	<span class="token keyword">def</span> <span class="token function">_collapse_types</span><span class="token punctuation">(</span>type_<span class="token punctuation">:</span> dfactions<span class="token punctuation">.</span>ActionType<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> dfactions<span class="token punctuation">.</span>ActionType<span class="token punctuation">:</span></span>
<span class="highlight-line">		remapped <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="highlight-line">			dfactions<span class="token punctuation">.</span>ActionType<span class="token punctuation">.</span>CALL_ACTIVITY_WITH_RETRY<span class="token punctuation">:</span> dfactions<span class="token punctuation">.</span>ActionType<span class="token punctuation">.</span>CALL_ACTIVITY<span class="token punctuation">,</span></span>
<span class="highlight-line">			dfactions<span class="token punctuation">.</span>ActionType<span class="token punctuation">.</span>CALL_SUB_ORCHESTRATOR_WITH_RETRY<span class="token punctuation">:</span> dfactions<span class="token punctuation">.</span>ActionType<span class="token punctuation">.</span>CALL_SUB_ORCHESTRATOR<span class="token punctuation">,</span></span>
<span class="highlight-line">		<span class="token punctuation">}</span></span>
<span class="highlight-line">		<span class="token keyword">if</span> type_ <span class="token keyword">in</span> remapped<span class="token punctuation">:</span></span>
<span class="highlight-line">			<span class="token keyword">return</span> remapped<span class="token punctuation">[</span><span class="token string">"type"</span><span class="token punctuation">]</span></span>
<span class="highlight-line">		<span class="token keyword">else</span><span class="token punctuation">:</span></span>
<span class="highlight-line">			<span class="token keyword">return</span> type_</span>
<span class="highlight-line"></span>
<span class="highlight-line">	<span class="token decorator annotation punctuation">@classmethod</span></span>
<span class="highlight-line">	<span class="token keyword">def</span> <span class="token function">create</span><span class="token punctuation">(</span>cls<span class="token punctuation">,</span> mocks<span class="token punctuation">:</span> Union<span class="token punctuation">[</span>AZDFMock<span class="token punctuation">,</span> Iterable<span class="token punctuation">[</span>AZDFMock<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token string">"MockExecutor"</span><span class="token punctuation">:</span></span>
<span class="highlight-line">		<span class="token triple-quoted-string string">"""Create an executor with handlers taken from mocks"""</span></span>
<span class="highlight-line">		<span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>mocks<span class="token punctuation">,</span> AZDFMock<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="highlight-line">			mocks <span class="token operator">=</span> <span class="token punctuation">[</span>mocks<span class="token punctuation">]</span></span>
<span class="highlight-line">		<span class="token keyword">return</span> cls<span class="token punctuation">(</span>mocks2handlers<span class="token punctuation">(</span>mocks<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="highlight-line"></span>
<span class="highlight-line">	<span class="token decorator annotation punctuation">@classmethod</span></span>
<span class="highlight-line">	<span class="token keyword">def</span> <span class="token function">lax</span><span class="token punctuation">(</span>cls<span class="token punctuation">,</span> default<span class="token punctuation">:</span> Callable <span class="token operator">=</span> <span class="token keyword">lambda</span> x<span class="token punctuation">:</span> x<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token string">"MockExecutor"</span><span class="token punctuation">:</span></span>
		<span class="token triple-quoted-string string">"""Create an executor where all not-found handlers will be passed to a default.
		If the `default` is not supplied, it defaults to just returning the arguments."""</span>
<span class="highlight-line">		default_by_type <span class="token operator">=</span> defaultdict<span class="token punctuation">(</span><span class="token keyword">lambda</span><span class="token punctuation">:</span> default<span class="token punctuation">)</span></span>
<span class="highlight-line">		default_handler <span class="token operator">=</span> defaultdict<span class="token punctuation">(</span><span class="token keyword">lambda</span><span class="token punctuation">:</span> default_by_type<span class="token punctuation">)</span></span>
<span class="highlight-line">		<span class="token keyword">return</span> cls<span class="token punctuation">(</span>default_handler<span class="token punctuation">)</span></span>
<span class="highlight-line"></span>
<span class="highlight-line">	<span class="token keyword">def</span> <span class="token function">with_handlers</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> handlers<span class="token punctuation">:</span> Handlers<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token string">"MockExecutor"</span><span class="token punctuation">:</span></span>
<span class="highlight-line">		<span class="token triple-quoted-string string">"""Specialise a copy of this executor with another handler tree"""</span></span>
<span class="highlight-line">		<span class="token keyword">return</span> MockExecutor<span class="token punctuation">(</span>combine_handlers<span class="token punctuation">(</span>self<span class="token punctuation">.</span>handlers<span class="token punctuation">,</span> handlers<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="highlight-line"></span>
<span class="highlight-line">	<span class="token keyword">def</span> <span class="token function">with_mock</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> mock<span class="token punctuation">:</span> Union<span class="token punctuation">[</span>AZDFMock<span class="token punctuation">,</span> Iterable<span class="token punctuation">[</span>AZDFMock<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="highlight-line">		<span class="token triple-quoted-string string">"""Specialise a copy of this executor with other mocks"""</span></span>
<span class="highlight-line">		<span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>mock<span class="token punctuation">,</span> AZDFMock<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="highlight-line">			mock <span class="token operator">=</span> <span class="token punctuation">[</span>mock<span class="token punctuation">]</span></span>
<span class="highlight-line">		<span class="token keyword">return</span> MockExecutor<span class="token punctuation">(</span>combine_handlers<span class="token punctuation">(</span>self<span class="token punctuation">.</span>handlers<span class="token punctuation">,</span> mocks2handlers<span class="token punctuation">(</span>mock<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="highlight-line"></span>
<span class="highlight-line">	<span class="token keyword">def</span> <span class="token function">execute</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> fn<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="highlight-line">		<span class="token triple-quoted-string string">"""Execute an orchestrator function with external calls mocked"""</span></span>
<span class="highlight-line">		ctx <span class="token operator">=</span> make_ctx<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="highlight-line">		g <span class="token operator">=</span> fn<span class="token punctuation">(</span>ctx<span class="token punctuation">)</span></span>
<span class="highlight-line">		result <span class="token operator">=</span> <span class="token boolean">None</span></span>
<span class="highlight-line">		<span class="token keyword">try</span><span class="token punctuation">:</span></span>
<span class="highlight-line">			<span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span></span>
<span class="highlight-line">				task <span class="token operator">=</span> g<span class="token punctuation">.</span>send<span class="token punctuation">(</span>result<span class="token punctuation">)</span></span>
<span class="highlight-line">				result <span class="token operator">=</span> self<span class="token punctuation">.</span>_handle<span class="token punctuation">(</span>task<span class="token punctuation">)</span></span>
<span class="highlight-line">		<span class="token keyword">except</span> StopIteration <span class="token keyword">as</span> ret<span class="token punctuation">:</span></span>
<span class="highlight-line">			<span class="token keyword">return</span> ret<span class="token punctuation">.</span>value</span>
<span class="highlight-line"></span>
<span class="highlight-line">	<span class="token keyword">def</span> <span class="token function">_handle</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> task<span class="token punctuation">:</span> dftask<span class="token punctuation">.</span>TaskBase<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="highlight-line">		self<span class="token punctuation">.</span>_invocations<span class="token punctuation">.</span>append<span class="token punctuation">(</span>task<span class="token punctuation">)</span></span>
<span class="highlight-line">		<span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>task<span class="token punctuation">,</span> dftask<span class="token punctuation">.</span>AtomicTask<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="highlight-line">			<span class="token keyword">return</span> self<span class="token punctuation">.</span>_handle_task<span class="token punctuation">(</span>task<span class="token punctuation">)</span></span>
<span class="highlight-line">		<span class="token keyword">elif</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>task<span class="token punctuation">,</span> dftask<span class="token punctuation">.</span>WhenAllTask<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="highlight-line">			<span class="token keyword">return</span> self<span class="token punctuation">.</span>_handle_task_all<span class="token punctuation">(</span>task<span class="token punctuation">)</span></span>
<span class="highlight-line">		<span class="token keyword">elif</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>task<span class="token punctuation">,</span> dftask<span class="token punctuation">.</span>WhenAnyTask<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="highlight-line">			<span class="token keyword">return</span> self<span class="token punctuation">.</span>_handle_task_any<span class="token punctuation">(</span>task<span class="token punctuation">)</span></span>
<span class="highlight-line"></span>
<span class="highlight-line">	<span class="token keyword">def</span> <span class="token function">_handle_task</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> task<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="highlight-line">		self<span class="token punctuation">.</span>_calls<span class="token punctuation">.</span>append<span class="token punctuation">(</span>task<span class="token punctuation">)</span></span>
<span class="highlight-line">		<span class="token keyword">return</span> self<span class="token punctuation">.</span>_handle_action<span class="token punctuation">(</span>task<span class="token punctuation">.</span>_get_action<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="highlight-line"></span>
<span class="highlight-line">	<span class="token keyword">def</span> <span class="token function">_handle_task_all</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> task<span class="token punctuation">:</span> dftask<span class="token punctuation">.</span>WhenAllTask<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="highlight-line">		<span class="token keyword">return</span> <span class="token punctuation">[</span>self<span class="token punctuation">.</span>_handle_task<span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token keyword">for</span> x <span class="token keyword">in</span> task<span class="token punctuation">.</span>children<span class="token punctuation">]</span></span>
<span class="highlight-line"></span>
<span class="highlight-line">	<span class="token keyword">def</span> <span class="token function">_handle_task_any</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> task<span class="token punctuation">:</span> dftask<span class="token punctuation">.</span>WhenAnyTask<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="highlight-line">		winning_task <span class="token operator">=</span> copy<span class="token punctuation">.</span>copy<span class="token punctuation">(</span>self<span class="token punctuation">.</span>_select_winning_task<span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="highlight-line">		result <span class="token operator">=</span> self<span class="token punctuation">.</span>_handle_task<span class="token punctuation">(</span>winning_task<span class="token punctuation">)</span></span>
<span class="highlight-line">		<span class="token builtin">setattr</span><span class="token punctuation">(</span>winning_task<span class="token punctuation">,</span> <span class="token string">"result"</span><span class="token punctuation">,</span> result<span class="token punctuation">)</span></span>
<span class="highlight-line">		<span class="token keyword">return</span> winning_task</span>
<span class="highlight-line"></span>
<span class="highlight-line">	<span class="token keyword">def</span> <span class="token function">_handle_action</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> action<span class="token punctuation">:</span> dfactions<span class="token punctuation">.</span>Action<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="highlight-line">		<span class="token keyword">return</span> self<span class="token punctuation">.</span>handlers<span class="token punctuation">[</span>self<span class="token punctuation">.</span>_collapse_types<span class="token punctuation">(</span>action<span class="token punctuation">.</span>action_type<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">[</span></span>
<span class="highlight-line">			action<span class="token punctuation">.</span>function_name</span>
<span class="highlight-line">		<span class="token punctuation">]</span><span class="token punctuation">(</span>json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>action<span class="token punctuation">.</span>input_<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="highlight-line"></span>
<span class="highlight-line">	<span class="token keyword">def</span> <span class="token function">invocations</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
		<span class="token triple-quoted-string string">"""
<span class="highlight-line">		RMIs that are submitted for execution through `yield` statements.</span>
<span class="highlight-line">		WhenAllTasks will have subcalls nested within it.</span>
<span class="highlight-line">		WhenAnyTasks will have _all_ of their subcalls nested as children</span>
		"""</span>
<span class="highlight-line">		<span class="token keyword">return</span> self<span class="token punctuation">.</span>_invocations</span>
<span class="highlight-line"></span>
<span class="highlight-line">	<span class="token keyword">def</span> <span class="token function">calls</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
		<span class="token triple-quoted-string string">"""
<span class="highlight-line">		RMIs that are actually executed</span>
<span class="highlight-line">		`WhenAllTask`s will not be included, but their children will</span>
<span class="highlight-line">		`WhenAnyTask`s will not be included, and only the "winning" task will be included</span>
		"""</span>
<span class="highlight-line">		<span class="token keyword">return</span> self<span class="token punctuation">.</span>_calls</span>
<span class="highlight-line"></span>
<span class="highlight-line">	<span class="token keyword">def</span> <span class="token function">_find_calls_matching_action</span><span class="token punctuation">(</span></span>
<span class="highlight-line">		self<span class="token punctuation">,</span> predicate<span class="token punctuation">:</span> Callable<span class="token punctuation">[</span><span class="token punctuation">[</span>dftask<span class="token punctuation">.</span>TaskBase<span class="token punctuation">,</span> dfactions<span class="token punctuation">.</span>Action<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token builtin">bool</span><span class="token punctuation">]</span></span>
<span class="highlight-line">	<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> List<span class="token punctuation">[</span>dftask<span class="token punctuation">.</span>TaskBase<span class="token punctuation">]</span><span class="token punctuation">:</span></span>
<span class="highlight-line">		calls_and_actions <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> t<span class="token punctuation">.</span>_get_action<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">for</span> t <span class="token keyword">in</span> self<span class="token punctuation">.</span>calls<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="highlight-line">		<span class="token comment"># matched = next(ca for ca in calls_and_actions if predicate(*ca), (None, None))</span></span>
<span class="highlight-line">		matched <span class="token operator">=</span> <span class="token builtin">filter</span><span class="token punctuation">(</span><span class="token keyword">lambda</span> ca<span class="token punctuation">:</span> predicate<span class="token punctuation">(</span><span class="token operator">*</span>ca<span class="token punctuation">)</span><span class="token punctuation">,</span> calls_and_actions<span class="token punctuation">)</span></span>
<span class="highlight-line">		tasks <span class="token operator">=</span> <span class="token builtin">map</span><span class="token punctuation">(</span><span class="token keyword">lambda</span> ca<span class="token punctuation">:</span> ca<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> matched<span class="token punctuation">)</span></span>
<span class="highlight-line">		<span class="token keyword">return</span> <span class="token builtin">list</span><span class="token punctuation">(</span>tasks<span class="token punctuation">)</span></span>
<span class="highlight-line"></span>
<span class="highlight-line">	<span class="token keyword">def</span> <span class="token function">_find_called</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> action_type<span class="token punctuation">,</span> function_name<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> List<span class="token punctuation">[</span>dftask<span class="token punctuation">.</span>TaskBase<span class="token punctuation">]</span><span class="token punctuation">:</span></span>
<span class="highlight-line">		<span class="token keyword">def</span> <span class="token function">_p</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> a<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="highlight-line">			<span class="token keyword">return</span> a<span class="token punctuation">.</span>action_type <span class="token operator">==</span> action_type <span class="token keyword">and</span> a<span class="token punctuation">.</span>function_name <span class="token operator">==</span> function_name</span>
<span class="highlight-line"></span>
<span class="highlight-line">		<span class="token keyword">return</span> self<span class="token punctuation">.</span>_find_calls_matching_action<span class="token punctuation">(</span>_p<span class="token punctuation">)</span></span>
<span class="highlight-line"></span>
<span class="highlight-line">	<span class="token keyword">def</span> <span class="token function">assert_called</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> action_type<span class="token punctuation">,</span> function_name<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="highlight-line">		<span class="token keyword">assert</span> <span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>_find_called<span class="token punctuation">(</span>action_type<span class="token punctuation">,</span> function_name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span></span>
<span class="highlight-line"></span>
<span class="highlight-line">	<span class="token keyword">def</span> <span class="token function">assert_called_once</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> action_type<span class="token punctuation">,</span> function_name<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="highlight-line">		<span class="token keyword">assert</span> <span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>_find_called<span class="token punctuation">(</span>action_type<span class="token punctuation">,</span> function_name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span></span>
<span class="highlight-line"></span>
<span class="highlight-line">	<span class="token keyword">def</span> <span class="token function">_find_called_with</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> action<span class="token punctuation">:</span> dfactions<span class="token punctuation">.</span>Action<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="highlight-line">		action_as_json <span class="token operator">=</span> action<span class="token punctuation">.</span>to_json<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="highlight-line"></span>
<span class="highlight-line">		<span class="token keyword">def</span> <span class="token function">_p</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> a<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="highlight-line">			<span class="token keyword">return</span> a<span class="token punctuation">.</span>to_json<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> action_as_json</span>
<span class="highlight-line"></span>
<span class="highlight-line">		<span class="token keyword">return</span> self<span class="token punctuation">.</span>_find_calls_matching_action<span class="token punctuation">(</span>_p<span class="token punctuation">)</span></span>
<span class="highlight-line"></span>
<span class="highlight-line">	<span class="token keyword">def</span> <span class="token function">assert_called_with</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> action<span class="token punctuation">:</span> dfactions<span class="token punctuation">.</span>Action<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="highlight-line">		c <span class="token operator">=</span> self<span class="token punctuation">.</span>calls<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span></span>
<span class="highlight-line">		<span class="token keyword">assert</span> c<span class="token punctuation">.</span>_get_action<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>to_json<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> action<span class="token punctuation">.</span>to_json<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="highlight-line"></span>
<span class="highlight-line">	<span class="token keyword">def</span> <span class="token function">assert_called_once_with</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> action<span class="token punctuation">:</span> dfactions<span class="token punctuation">.</span>Action<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="highlight-line">		self<span class="token punctuation">.</span>assert_called_once<span class="token punctuation">(</span>action<span class="token punctuation">.</span>action_type<span class="token punctuation">,</span> action<span class="token punctuation">.</span>function_name<span class="token punctuation">)</span></span>
<span class="highlight-line">		<span class="token keyword">assert</span> <span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>_find_called_with<span class="token punctuation">(</span>action<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span></span>
<span class="highlight-line"></span>
<span class="highlight-line">	<span class="token keyword">def</span> <span class="token function">assert_any_call</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> action<span class="token punctuation">:</span> dfactions<span class="token punctuation">.</span>Action<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="highlight-line">		<span class="token keyword">assert</span> <span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>_find_called_with<span class="token punctuation">(</span>action<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span></span>
<span class="highlight-line"></span>
<span class="highlight-line">	<span class="token keyword">def</span> <span class="token function">assert_has_calls</span><span class="token punctuation">(</span></span>
<span class="highlight-line">		self<span class="token punctuation">,</span> actions<span class="token punctuation">:</span> Iterable<span class="token punctuation">[</span>dfactions<span class="token punctuation">.</span>Action<span class="token punctuation">]</span><span class="token punctuation">,</span> any_order<span class="token punctuation">:</span> <span class="token builtin">bool</span> <span class="token operator">=</span> <span class="token boolean">False</span></span>
<span class="highlight-line">	<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="highlight-line">		<span class="token keyword">if</span> any_order<span class="token punctuation">:</span></span>
<span class="highlight-line">			<span class="token keyword">for</span> action <span class="token keyword">in</span> actions<span class="token punctuation">:</span></span>
<span class="highlight-line">				self<span class="token punctuation">.</span>assert_any_call<span class="token punctuation">(</span>action<span class="token punctuation">)</span></span>
<span class="highlight-line">		<span class="token keyword">else</span><span class="token punctuation">:</span></span>
<span class="highlight-line">			remaining_calls <span class="token operator">=</span> <span class="token builtin">iter</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>calls<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="highlight-line">			remaining_actions <span class="token operator">=</span> <span class="token builtin">iter</span><span class="token punctuation">(</span>actions<span class="token punctuation">)</span></span>
<span class="highlight-line"></span>
<span class="highlight-line">			<span class="token keyword">def</span> <span class="token function">find_next_call_matching</span><span class="token punctuation">(</span>a<span class="token punctuation">:</span> dfactions<span class="token punctuation">.</span>Action<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="highlight-line">				<span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span></span>
<span class="highlight-line">					call <span class="token operator">=</span> <span class="token builtin">next</span><span class="token punctuation">(</span>remaining_calls<span class="token punctuation">)</span></span>
<span class="highlight-line">					<span class="token keyword">if</span> call<span class="token punctuation">.</span>_get_action<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>to_json<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> a<span class="token punctuation">.</span>to_json<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="highlight-line">						<span class="token keyword">return</span></span>
<span class="highlight-line"></span>
<span class="highlight-line">			<span class="token keyword">for</span> action <span class="token keyword">in</span> remaining_actions<span class="token punctuation">:</span></span>
<span class="highlight-line">				<span class="token keyword">try</span><span class="token punctuation">:</span></span>
<span class="highlight-line">					find_next_call_matching<span class="token punctuation">(</span>action<span class="token punctuation">)</span></span>
<span class="highlight-line">				<span class="token keyword">except</span> StopIteration<span class="token punctuation">:</span></span>
<span class="highlight-line">					unmatched <span class="token operator">=</span> <span class="token punctuation">[</span>action<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token builtin">list</span><span class="token punctuation">(</span>remaining_actions<span class="token punctuation">)</span></span>
<span class="highlight-line">					<span class="token keyword">raise</span> AssertionError<span class="token punctuation">(</span><span class="token string">"not all calls matched"</span><span class="token punctuation">,</span> unmatched<span class="token punctuation">)</span></span>
<span class="highlight-line"></span>
<span class="highlight-line">	<span class="token keyword">def</span> <span class="token function">assert_not_called</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> action_type<span class="token punctuation">,</span> function_name<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="highlight-line">		<span class="token keyword">assert</span> <span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>_find_called<span class="token punctuation">(</span>action_type<span class="token punctuation">,</span> function_name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span></span>
<span class="highlight-line">		</span>
<span class="highlight-line"></span></code></pre>

</div>
</article>



<hr>
<ul><li>Next: <a href="/posts/azure-private-endpoint-dns/">The DNS Shenanigans that make Azure Private Endpoints Work</a></li><li>Previous: <a href="/posts/eleventy_include_code_verbatim/">Eleventy Include Code File Verbatim</a></li>
</ul>

		</main>
		<nav class="nav">
			<ul>
				<li class="nav-item"><a
						href="/">Home</a></li>
				<li class="nav-item"><a
						href="/posts/">Archive</a></li>
				<li class="nav-item"><a
						href="/tags/">Tags</a></li>
				<li class="nav-item"><a
						href="/series/">Series</a></li>
				<li class="nav-item"><a
						href="/about/">About Me</a></li>
				<li class="nav-item"><a
						href="/colophon/">Colophon</a></li>
				<li class="nav-item"><a
						href="/feedlist/">Feeds</a></li>
			</ul>
		</nav>
	</div>
</div>
<footer></footer>

<!-- Current page: /posts/azure_function_durable_testing/ -->
</body>
</html>
