<!doctype html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Writing a Filter Plugin in Ansible</title>
	<meta name="description" content="How to write a Filter Plugin in Ansible. These let you process some data">
	<link rel="stylesheet" href="/css/index.css">
	<link rel="stylesheet" href="/css/prism-base16-monokai.dark.css">
	<link rel="alternate" href="/feed/feed.xml" type="application/atom+xml"
		  title="lilatomic">
	<link rel="alternate" href="/feed/feed.json" type="application/json"
		  title="lilatomic">
</head>
<body>
<div class="ctn">
	<header>
		<h1 class="home"><a id="home" href="/">lilatomic</a></h1>
	</header>
	<div id="main">
		<main  class="tmpl-post" >

			
<article>


<h1>Writing a Filter Plugin in Ansible</h1>


<aside id="tagbox">
<p>Tags</p>

  <a href="/tags/ansible/" class="post-tag">ansible</a>
</aside>



<aside id="seriesbox">
<p> Member of series: </p>

  
  <a href="/series/ansible plugins/" class="post-tag">ansible plugins</a>

</aside>


  
  <aside id="toc">
    <nav class="toc" >
        <ol><li><a href="#basic-outline">Basic outline</a></li><li><a href="#documenting-your-plugin">Documenting your plugin</a></li><li><a href="#common-things-you'd-want-to-do">Common things you'd want to do</a><ol><li><a href="#using-an-existing-filter">Using an existing filter</a></li><li><a href="#including-other-parameters-in-your-filter">Including other parameters in your filter</a></li><li><a href="#building-an-extractor">Building an extractor</a></li></ol></li><li><a href="#abusing-filters-as-functions">Abusing filters as functions</a></li></ol>
      </nav>
  </aside>
  
<div class="content">
<h1 id="writing-a-filter-plugin-in-ansible" tabindex="-1">Writing a Filter Plugin in Ansible <a class="direct-link" href="#writing-a-filter-plugin-in-ansible">#</a></h1>
<p>You might find that you're doing the same kind of data-munging in multiple places. There are many cases where you'd want to pull this into a little named package:</p>
<ul>
<li>It requires logic which can't be expressed simply in basic jinja filters</li>
<li>It's common and used in many places, so there's lots of duplication</li>
<li>It's uncommon and you can never remember the requirements</li>
<li>It's actually complicated</li>
<li>You just want to name what these 3 filters do together</li>
</ul>
<h2 id="basic-outline" tabindex="-1">Basic outline <a class="direct-link" href="#basic-outline">#</a></h2>
<p>The basic outline of a plugin is as follows:</p>
<pre class="language-python"><code class="language-python"><span class="highlight-line"><span class="token keyword">import</span> re</span><br><span class="highlight-line"></span><br><span class="highlight-line"></span><br><span class="highlight-line"><span class="token keyword">def</span> <span class="token function">storage_account</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># 3</span></span><br><span class="highlight-line">	<span class="token keyword">return</span> re<span class="token punctuation">.</span>sub<span class="token punctuation">(</span><span class="token string">"[^a-z0-9]"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">24</span><span class="token punctuation">]</span></span><br><span class="highlight-line"></span><br><span class="highlight-line"></span><br><span class="highlight-line"><span class="token keyword">class</span> <span class="token class-name">FilterModule</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># 1</span></span><br><span class="highlight-line">	<span class="token keyword">def</span> <span class="token function">filters</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># 2</span></span><br><span class="highlight-line">		<span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token string">"storage_account"</span><span class="token punctuation">:</span> storage_account<span class="token punctuation">}</span>  <span class="token comment"># 4</span></span><br><span class="highlight-line"></span></code></pre>
<ol>
<li>Create a class FilterModule</li>
<li>Create a function <code>filters</code></li>
<li>Define your function</li>
<li>Return a dict with k-vs of <code>filter_name:function_reference</code></li>
</ol>
<h2 id="documenting-your-plugin" tabindex="-1">Documenting your plugin <a class="direct-link" href="#documenting-your-plugin">#</a></h2>
<p>If you want your documentation to work with the Ansible tooling (showing up nicely in the docs, working with <code>ansible-doc</code>), you can't use the standard ansible documentation, since Filter plugins don't show up as an option you can select documentation for. Go figure. You can still try to use the standard documentation features, though.</p>
<p>You can include only the sections of the documentation that you want to appear. Here's the <a href="https://docs.ansible.com/ansible/2.10/dev_guide/developing_modules_documenting.html">full referece</a> for the version this article was written to. For convenience, here they are:</p>
<ul>
<li>Shebang &amp; encoding</li>
<li>Copyright</li>
<li>DOCUMENTATION (includes module parameters)</li>
<li>EXAMPLES</li>
<li>RETURN</li>
</ul>
<p>These have to be python strings which contain the YAML. This makes it kinda gross to work on, since you have no YAML syntax highlighting to help you. Here's a stub python file (feel free to change the license line):</p>
<p>{% raw %}</p>
<pre class="language-python"><code class="language-python"><span class="highlight-line"><span class="token comment">#!/usr/bin/python</span></span><br><span class="highlight-line"><span class="token comment"># -*- coding: utf-8 -*-</span></span><br><span class="highlight-line"><span class="token comment"># Copyright: (c) {{ year }}, {{ Your Name }} &lt;{{ your email }}></span></span><br><span class="highlight-line"><span class="token comment"># GNU Affero General Public License v3.0+ (see COPYING or https://www.gnu.org/licenses/agpl-3.0.txt)</span></span><br><span class="highlight-line"></span><br>DOCUMENTATION <span class="token operator">=</span> <span class="token triple-quoted-string string">r"""<br><span class="highlight-line">module:</span><br><span class="highlight-line">short_description:</span><br><span class="highlight-line">description:</span><br><span class="highlight-line">  -</span><br><span class="highlight-line">version_added: "0.1.0"</span><br><span class="highlight-line">options:</span><br>"""</span><br><span class="highlight-line"></span><br>EXAMPLES <span class="token operator">=</span> <span class="token triple-quoted-string string">r"""<br>"""</span><br><span class="highlight-line"></span><br>RETURN <span class="token operator">=</span> <span class="token triple-quoted-string string">r"""<br><span class="highlight-line">{{ key }}:</span><br><span class="highlight-line">  desctiption:</span><br><span class="highlight-line">  returned:</span><br><span class="highlight-line">  type:</span><br><span class="highlight-line">  sample:</span><br>"""</span></code></pre>
<p>{% endraw %}</p>
<h2 id="common-things-you'd-want-to-do" tabindex="-1">Common things you'd want to do <a class="direct-link" href="#common-things-you'd-want-to-do">#</a></h2>
<h3 id="using-an-existing-filter" tabindex="-1">Using an existing filter <a class="direct-link" href="#using-an-existing-filter">#</a></h3>
<p>If you want to use an existing filter plugin (perhaps to format your output), you can just import them from the Ansible package:</p>
<pre class="language-python"><code class="language-python"><span class="highlight-line"><span class="token keyword">from</span> ansible<span class="token punctuation">.</span>plugins<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">.</span>core <span class="token keyword">import</span> to_json<span class="token punctuation">,</span> quote</span></code></pre>
<h3 id="including-other-parameters-in-your-filter" tabindex="-1">Including other parameters in your filter <a class="direct-link" href="#including-other-parameters-in-your-filter">#</a></h3>
<p>If you want to have other parameters in your filter, you can just do that</p>
<pre class="language-python"><code class="language-python"><span class="highlight-line"><span class="token keyword">from</span> ipaddress <span class="token keyword">import</span> ip_network</span><br><span class="highlight-line"></span><br><span class="highlight-line"></span><br><span class="highlight-line"><span class="token keyword">def</span> <span class="token function">ip_in_snet</span><span class="token punctuation">(</span>snet<span class="token punctuation">,</span> ip<span class="token punctuation">)</span><span class="token punctuation">:</span></span><br><span class="highlight-line">	_snet <span class="token operator">=</span> ip_network<span class="token punctuation">(</span>snet<span class="token punctuation">)</span></span><br><span class="highlight-line">	_ip <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>ip<span class="token punctuation">)</span></span><br><span class="highlight-line">	<span class="token keyword">return</span> _snet<span class="token punctuation">[</span>_ip<span class="token punctuation">]</span></span><br><span class="highlight-line"></span><br><span class="highlight-line"></span><br><span class="highlight-line"><span class="token keyword">class</span> <span class="token class-name">FilterModule</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span><br><span class="highlight-line">	<span class="token keyword">def</span> <span class="token function">filters</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span></span><br><span class="highlight-line">		<span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token string">"ip_in_snet"</span><span class="token punctuation">:</span> ip_in_snet<span class="token punctuation">}</span></span></code></pre>
<p>and then use that like you'd expect, more or less</p>
<pre class="language-python"><code class="language-python"><span class="highlight-line"> <span class="token string">"{{ '10.0.1.0/24' | ip_in_snet(10) }}"</span> </span></code></pre>
<h3 id="building-an-extractor" tabindex="-1">Building an extractor <a class="direct-link" href="#building-an-extractor">#</a></h3>
<p>Sometimes you can't remember the sequence of keys you need to extract that thing you want from the huge JSON blob. You can write a simple extractor:</p>
<pre class="language-python"><code class="language-python">DOCUMENTATION <span class="token operator">=</span> <span class="token triple-quoted-string string">r"""<br><span class="highlight-line">name: extract_connectionstring</span><br><span class="highlight-line">short_description: extracts the connection stirng from azure_rm_storageaccount_info</span><br><span class="highlight-line">description:</span><br><span class="highlight-line">  - extracts the connection stirng from M(azure_rm_storageaccount_info)</span><br><span class="highlight-line">  - make sure to use the option C(show_connection_string: true) on the M(azure_rm_storageaccount_info) invocation</span><br><span class="highlight-line">options:</span><br><span class="highlight-line">  rm_info:</span><br><span class="highlight-line">  description: </span><br><span class="highlight-line">    - The result of azure_rm_storageaccount_info</span><br><span class="highlight-line">  type: object</span><br><span class="highlight-line">  required: True</span><br><span class="highlight-line">  endpoint:</span><br><span class="highlight-line">  description:</span><br><span class="highlight-line">    - The storageaccount endpoint to get the connectionstring for</span><br><span class="highlight-line">    - if blank, will fetch for blob</span><br><span class="highlight-line">    - use "key" to get the key itself</span><br><span class="highlight-line">  choices: ["blob", "file", "queue", "table", "key"]</span><br><span class="highlight-line">  required: False</span><br><span class="highlight-line">    default: blob</span><br>"""</span><br><span class="highlight-line"></span><br>EXAMPLES <span class="token operator">=</span> <span class="token triple-quoted-string string">r"""<br><span class="highlight-line">- name: get storageaccount info</span><br><span class="highlight-line">  azure_rm_storageaccount_info:</span><br><span class="highlight-line">    name: "{{ storage_acount_name }}"</span><br><span class="highlight-line">    resource_group "{{ rg }}"</span><br><span class="highlight-line">    show_connection_string: true # important !</span><br><span class="highlight-line">  register: storageaccount_raw</span><br><span class="highlight-line"></span><br><span class="highlight-line">- name: get blob connection string</span><br><span class="highlight-line">  set_fact:</span><br><span class="highlight-line">    blob_connectionstring: "{{ storageaccount_raw | extract_connectionstring }}</span><br><span class="highlight-line"></span><br><span class="highlight-line">- name: get connection string for something other than blob</span><br><span class="highlight-line">  set_fact:</span><br><span class="highlight-line">    table_connectionstring: "{{ storageaccount_raw | extract_connectionstring('table') }}</span><br><span class="highlight-line"></span><br><span class="highlight-line">- name: get account key</span><br><span class="highlight-line">  set_fact:</span><br><span class="highlight-line">    connectionstring: "{{ storageaccount_raw | extract_connectionstring('key') }}</span><br>"""</span><br><span class="highlight-line"></span><br><span class="highlight-line"></span><br><span class="highlight-line"><span class="token keyword">def</span> <span class="token function">extract_connectionstring</span><span class="token punctuation">(</span>rm_info<span class="token punctuation">,</span> endpoint<span class="token operator">=</span><span class="token string">"blob"</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span><br><span class="highlight-line">	<span class="token keyword">if</span> endpoint <span class="token operator">==</span> <span class="token string">"key"</span><span class="token punctuation">:</span></span><br><span class="highlight-line">		<span class="token keyword">return</span> rm_info<span class="token punctuation">[</span><span class="token string">"storageaccounts"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"primary_endpoints"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"key"</span><span class="token punctuation">]</span></span><br><span class="highlight-line">	<span class="token keyword">else</span><span class="token punctuation">:</span></span><br><span class="highlight-line">		<span class="token keyword">return</span> rm_info<span class="token punctuation">[</span><span class="token string">"storageaccounts"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"primary_endpoints"</span><span class="token punctuation">]</span><span class="token punctuation">[</span>endpoint<span class="token punctuation">]</span><span class="token punctuation">[</span></span><br><span class="highlight-line">			<span class="token string">"connectionstring"</span></span><br><span class="highlight-line">		<span class="token punctuation">]</span></span><br><span class="highlight-line"></span><br><span class="highlight-line"></span><br><span class="highlight-line"><span class="token keyword">class</span> <span class="token class-name">FilterModule</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span><br><span class="highlight-line">	<span class="token keyword">def</span> <span class="token function">filters</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span></span><br><span class="highlight-line">		<span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token string">"extract_connectionstring"</span><span class="token punctuation">:</span> extract_connectionstring<span class="token punctuation">}</span></span><br><span class="highlight-line"></span></code></pre>
<h2 id="abusing-filters-as-functions" tabindex="-1">Abusing filters as functions <a class="direct-link" href="#abusing-filters-as-functions">#</a></h2>
<p>Let's say that you want to have some functions assemble things, like you would with some proper typed data modelling. I'm not saying this is a <em>good</em> idea, but you can use functions as the closest thing to that (it's not really close). For an example, I always forget the little fiddly bits of assembling an Azure Storageaccount Lifecycle Policy. I could do the following:</p>
<pre class="language-python"><code class="language-python"><span class="highlight-line"><span class="token keyword">from</span> _includes<span class="token punctuation">.</span>resources<span class="token punctuation">.</span>ansible_plugins<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">.</span>extractor <span class="token keyword">import</span> EXAMPLES</span><br><span class="highlight-line"></span><br><span class="highlight-line"></span><br>EXAMPLES <span class="token operator">=</span> <span class="token triple-quoted-string string">r"""<br><span class="highlight-line">- name: format lifecycle policy</span><br><span class="highlight-line">  set_fact:</span><br><span class="highlight-line">    autodelete_rule: "{{ "autodelete" | storageaccount_lifecycle_rule(filters, blob_actions) }}</span><br><span class="highlight-line">  vars:</span><br><span class="highlight-line">    blob_actions:</span><br><span class="highlight-line">      - {"delete":{"daysAfterModificationGreaterThan": 30}}</span><br><span class="highlight-line">    filters:</span><br><span class="highlight-line">      - {"blobTypes":["blockBlob"],"prefixMatch":["my_container"]}</span><br>"""</span><br><span class="highlight-line"></span><br><span class="highlight-line"></span><br><span class="highlight-line"><span class="token keyword">from</span> typing <span class="token keyword">import</span> Dict</span><br><span class="highlight-line"></span><br><span class="highlight-line"></span><br><span class="highlight-line"><span class="token keyword">def</span> <span class="token function">rule</span><span class="token punctuation">(</span></span><br><span class="highlight-line">	name<span class="token punctuation">,</span></span><br><span class="highlight-line">	filters<span class="token punctuation">,</span></span><br><span class="highlight-line">	actions_blob<span class="token punctuation">:</span> Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> Dict<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">,</span></span><br><span class="highlight-line">	actions_version<span class="token punctuation">:</span> Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> Dict<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">,</span></span><br><span class="highlight-line"><span class="token punctuation">)</span><span class="token punctuation">:</span></span><br><span class="highlight-line">	<span class="token keyword">return</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">		<span class="token string">"enabled"</span><span class="token punctuation">:</span> <span class="token boolean">True</span><span class="token punctuation">,</span></span><br><span class="highlight-line">		<span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">,</span></span><br><span class="highlight-line">		<span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"Lifecycle"</span><span class="token punctuation">,</span></span><br><span class="highlight-line">		<span class="token string">"definitions"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">			<span class="token string">"actions"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">"baseBlob"</span><span class="token punctuation">:</span> actions_blob<span class="token punctuation">,</span> <span class="token string">"versions"</span><span class="token punctuation">:</span> actions_version<span class="token punctuation">,</span><span class="token punctuation">}</span><span class="token punctuation">,</span></span><br><span class="highlight-line">			<span class="token string">"filters"</span><span class="token punctuation">:</span> filters<span class="token punctuation">,</span></span><br><span class="highlight-line">		<span class="token punctuation">}</span><span class="token punctuation">,</span></span><br><span class="highlight-line">	<span class="token punctuation">}</span></span><br><span class="highlight-line"></span><br><span class="highlight-line"></span><br><span class="highlight-line"><span class="token keyword">class</span> <span class="token class-name">FilterModule</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span><br><span class="highlight-line">	<span class="token keyword">def</span> <span class="token function">filters</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span></span><br><span class="highlight-line">		<span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token string">"storageaccount_lifecycle_rule"</span><span class="token punctuation">:</span> rule<span class="token punctuation">}</span></span><br><span class="highlight-line"></span></code></pre>
<p>And yes, you can also build filters to construct those <code>filters</code> and <code>blob_actions</code>, and make a terrible filter chain. But maybe don't and just write a one-off plugin.</p>

</div>
</article>



<hr>
<ul><li>Next: <a href="/posts/eleventy_include_code_verbatim/">Eleventy Include Code File Verbatim</a></li><li>Previous: <a href="/posts/ansible_writing_action_plugin/">Writing an Action Plugin in Ansible</a></li>
</ul>

		</main>
		<nav class="nav">
			<ul>
				<li class="nav-item"><a
						href="/">Home</a></li>
				<li class="nav-item"><a
						href="/posts/">Archive</a></li>
				<li class="nav-item"><a
						href="/tags/">Tags</a></li>
				<li class="nav-item"><a
						href="/series/">Series</a></li>
				<li class="nav-item"><a
						href="/about/">About Me</a></li>
				<li class="nav-item"><a
						href="/colophon/">Colophon</a></li>
				<li class="nav-item"><a
						href="/feedlist/">Feeds</a></li>
			</ul>
		</nav>
	</div>
</div>
<footer></footer>

<!-- Current page: /posts/ansible_writing_filter_plugin/ -->
</body>
</html>
