<!doctype html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Common Dhall Tasks for Config Files</title>
	<meta name="description" content="How to do that thing you want to do in Dhall">
	<link rel="stylesheet" href="/css/index.css">
	<link rel="stylesheet" href="/css/prism-base16-monokai.dark.css">
	<link rel="alternate" href="/feed/feed.xml" type="application/atom+xml"
		  title="lilatomic">
	<link rel="alternate" href="/feed/feed.json" type="application/json"
		  title="lilatomic">
</head>
<body>
<div class="ctn">
	<header>
		<h1 class="home"><a id="home" href="/">lilatomic</a></h1>
	</header>
	<div id="main">
		<main  class="tmpl-post" >

			
<article>
<h1>Common Dhall Tasks for Config Files</h1>

<aside id="tagbox">
<p>Tags</p>

  <a href="/tags/dhall/" class="post-tag">dhall</a>
  <a href="/tags/using/" class="post-tag">using</a>
</aside>





<aside id="toc">
	<nav class="toc" >
        <ol><li><a href="#enums-(sum-types)">Enums (Sum Types)</a></li><li><a href="#unions-%7C-complex-sum-types">Unions | Complex Sum Types</a></li><li><a href="#optional-fields-(autoexclusion)">Optional fields (autoexclusion)</a></li><li><a href="#multiple-exports-per-file">Multiple exports per file</a></li></ol>
      </nav>
</aside>

<div class="content">
<h1 id="common-dhall-tasks-for-config-files" tabindex="-1">Common Dhall Tasks for Config Files <a class="direct-link" href="#common-dhall-tasks-for-config-files">#</a></h1>
<p>This page describes common tasks in using Dhall for generating config files. It provides the step-by-step for implementing these common features.</p>
<h2 id="enums-(sum-types)" tabindex="-1">Enums (Sum Types) <a class="direct-link" href="#enums-(sum-types)">#</a></h2>
<ol>
<li>
<p>Define the type. Angle brackets around all the options, pipelines between the options. These are the names which appear in code, so it's alright if they follow your code convention rather than how they appear in the config file. So if you write enums in all capital letters because they're basically constants, you do you.</p>
<p>:/types/ServiceType.dhall</p>
<pre class="language-dhall"><code class="language-dhall"><span class="highlight-line"><span class="token operator">&lt;</span> simple <span class="token operator">|</span> forking <span class="token operator">|</span> oneshot <span class="token operator">|</span> notify <span class="token operator">|</span> dbus <span class="token operator">|</span> idle <span class="token operator">></span></span></code></pre>
</li>
<li>
<p>Register it in the types.dhall file:</p>
<p>:/types.dhall</p>
<pre class="language-dhall"><code class="language-dhall"><span class="highlight-line"><span class="token punctuation">{</span><span class="token punctuation">..</span><span class="token punctuation">.</span></span>
<span class="highlight-line"><span class="token punctuation">,</span> <span class="token class-name">ServiceType</span> <span class="token operator">=</span> <span class="token punctuation">.</span><span class="token punctuation">/</span>types<span class="token punctuation">/</span><span class="token class-name">ServiceType</span><span class="token punctuation">.</span>dhall</span>
<span class="highlight-line"><span class="token punctuation">}</span></span></code></pre>
</li>
<li>
<p>Use it in an example by referencing through the type import:</p>
<pre class="language-dhall"><code class="language-dhall"><span class="highlight-line"><span class="token keyword">let</span> <span class="token class-name">ServiceType</span> <span class="token operator">=</span> <span class="token class-name">Systemd</span><span class="token punctuation">.</span><span class="token class-name">ServiceType</span><span class="token punctuation">.</span>simple</span></code></pre>
</li>
<li>
<p>Make a renderer for the type. Start with the import of the types files. Then we make a function which merges a record with the string equivalents with the input. The only thing which falls out is the correct string equivalent. Neat!</p>
<p>:/render/ServiceType.dhall</p>
<pre class="language-dhall"><code class="language-dhall"><span class="highlight-line"><span class="token keyword">let</span> types <span class="token operator">=</span> <span class="token punctuation">..</span><span class="token punctuation">/</span>types<span class="token punctuation">.</span>dhall</span>
<span class="highlight-line"></span>
<span class="highlight-line"><span class="token keyword">in</span>  <span class="token operator">λ</span><span class="token punctuation">(</span>x <span class="token operator">:</span> types<span class="token punctuation">.</span><span class="token class-name">ServiceType</span><span class="token punctuation">)</span> <span class="token operator">→</span></span>
<span class="highlight-line">	<span class="token keyword">merge</span></span>
<span class="highlight-line">		<span class="token punctuation">{</span> simple <span class="token operator">=</span> <span class="token string">"simple"</span></span>
<span class="highlight-line">		<span class="token punctuation">,</span> forking <span class="token operator">=</span> <span class="token string">"forking"</span></span>
<span class="highlight-line">		<span class="token punctuation">,</span> oneshot <span class="token operator">=</span> <span class="token string">"oneshot"</span></span>
<span class="highlight-line">		<span class="token punctuation">,</span> notify <span class="token operator">=</span> <span class="token string">"notify"</span></span>
<span class="highlight-line">		<span class="token punctuation">,</span> dbus <span class="token operator">=</span> <span class="token string">"dbus"</span></span>
<span class="highlight-line">		<span class="token punctuation">,</span> idle <span class="token operator">=</span> <span class="token string">"idle"</span></span>
<span class="highlight-line">		<span class="token punctuation">}</span></span>
<span class="highlight-line">		x</span></code></pre>
</li>
<li>
<p>Register the renderer with:</p>
<p>:/render.dhall</p>
<pre class="language-dhall"><code class="language-dhall"><span class="highlight-line"><span class="token punctuation">{</span><span class="token punctuation">..</span><span class="token punctuation">.</span></span>
<span class="highlight-line"><span class="token punctuation">,</span> <span class="token class-name">ServiceType</span> <span class="token operator">=</span> <span class="token punctuation">.</span><span class="token punctuation">/</span>render<span class="token punctuation">/</span><span class="token class-name">ServiceType</span><span class="token punctuation">.</span>dhall</span>
<span class="highlight-line"><span class="token punctuation">}</span></span>
<span class="highlight-line"></span></code></pre>
</li>
<li>
<p>Use it in other renderers like normal. Since we're in the 'render' folder, we can just import it with a local import, like <code>./ServiceType.dhall</code></p>
<p>:/render/Service.dhall</p>
<pre class="language-dhall"><code class="language-dhall"><span class="highlight-line"><span class="token keyword">let</span> types <span class="token operator">=</span> <span class="token punctuation">..</span><span class="token punctuation">/</span>types<span class="token punctuation">.</span>dhall</span>
<span class="highlight-line"></span>
<span class="highlight-line"><span class="token keyword">in</span>  <span class="token operator">λ</span><span class="token punctuation">(</span>i <span class="token operator">:</span> types<span class="token punctuation">.</span><span class="token class-name">Service</span><span class="token punctuation">)</span> <span class="token operator">→</span></span>
	<span class="token string">''
<span class="highlight-line">	[Service]</span>
<span class="highlight-line">	User=<span class="token interpolation"><span class="token punctuation">${</span><span class="token expression language-dhall">i<span class="token punctuation">.</span><span class="token class-name">User</span></span><span class="token punctuation">}</span></span></span>
<span class="highlight-line">	ExecStart=<span class="token interpolation"><span class="token punctuation">${</span><span class="token expression language-dhall">i<span class="token punctuation">.</span><span class="token class-name">ExecStart</span></span><span class="token punctuation">}</span></span></span>
<span class="highlight-line">	Type=<span class="token interpolation"><span class="token punctuation">${</span><span class="token expression language-dhall"><span class="token punctuation">.</span><span class="token punctuation">/</span><span class="token class-name">ServiceType</span><span class="token punctuation">.</span>dhall i<span class="token punctuation">.</span><span class="token class-name">ServiceType</span></span><span class="token punctuation">}</span></span></span>
	''</span></code></pre>
</li>
</ol>
<h2 id="unions-%7C-complex-sum-types" tabindex="-1">Unions | Complex Sum Types <a class="direct-link" href="#unions-%7C-complex-sum-types">#</a></h2>
<p>Sometimes you've got a field which is a value of Type a <em>or</em> Type b. A sum type represents that. This example combines an enum and Text, but the same principle holds for any types. Here's a <a href="https://hackage.haskell.org/package/dhall-1.16.1/docs/Dhall-Tutorial.html#g:12">link</a> for the official tutorial</p>
<ol>
<li>
<p>Create the sum type similarly to how you'd create an Enum. Note that each option has both a name and a Type. These also generate the constructors for the Union type.</p>
<p>:/types/Dependency.dhall</p>
<pre class="language-dhall"><code class="language-dhall"><span class="highlight-line"><span class="token operator">&lt;</span> <span class="token class-name">Runlevel</span> <span class="token operator">:</span> <span class="token punctuation">.</span><span class="token punctuation">/</span><span class="token class-name">RunlevelTargets</span><span class="token punctuation">.</span>dhall <span class="token operator">|</span> <span class="token class-name">Service</span> <span class="token operator">:</span> <span class="token class-name">Text</span> <span class="token operator">></span></span></code></pre>
</li>
<li>
<p>Register it in the ':/types.dhall'</p>
</li>
<li>
<p>Make a renderer for the type. You can use merge to select a function and then apply it. You can compose this from other functions you have already. Note that we use <code>=</code> here, since this isn't defining a type signature. Also note that we're using <code>id</code>, <code>Text/show</code> was adding extra quotes.</p>
<p>:/render/Dependency.dhall</p>
<pre class="language-dhall"><code class="language-dhall"><span class="highlight-line"><span class="token keyword">let</span> types <span class="token operator">=</span> <span class="token punctuation">..</span><span class="token punctuation">/</span>types<span class="token punctuation">.</span>dhall</span>
<span class="highlight-line"></span>
<span class="highlight-line"><span class="token keyword">let</span> id <span class="token operator">=</span> <span class="token operator">λ</span><span class="token punctuation">(</span>a <span class="token operator">:</span> <span class="token class-name">Type</span><span class="token punctuation">)</span> <span class="token operator">→</span> <span class="token operator">λ</span><span class="token punctuation">(</span>x <span class="token operator">:</span> a<span class="token punctuation">)</span> <span class="token operator">→</span> x</span>
<span class="highlight-line"></span>
<span class="highlight-line"><span class="token keyword">in</span>  <span class="token operator">λ</span><span class="token punctuation">(</span>x <span class="token operator">:</span> types<span class="token punctuation">.</span><span class="token class-name">Dependency</span><span class="token punctuation">)</span> <span class="token operator">→</span></span>
<span class="highlight-line">	<span class="token keyword">merge</span> <span class="token punctuation">{</span> <span class="token class-name">Runlevel</span> <span class="token operator">=</span> <span class="token punctuation">.</span><span class="token punctuation">/</span><span class="token class-name">RunlevelTargets</span><span class="token punctuation">.</span>dhall<span class="token punctuation">,</span> <span class="token class-name">Service</span> <span class="token operator">=</span> id <span class="token class-name">Text</span> <span class="token punctuation">}</span> x</span></code></pre>
</li>
<li>
<p>Register it in the ':/render.dhall'</p>
</li>
<li>
<p>Use it by accessing the constructor you want. Note that the renderer is the same, since they're ultimately the same type:</p>
<pre class="language-dhall"><code class="language-dhall"><span class="highlight-line"><span class="token keyword">let</span> <span class="token class-name">Systemd</span> <span class="token operator">=</span> <span class="token punctuation">..</span><span class="token punctuation">/</span>types<span class="token punctuation">.</span>dhall</span>
<span class="highlight-line"></span>
<span class="highlight-line"><span class="token keyword">let</span> <span class="token class-name">Render</span> <span class="token operator">=</span> <span class="token punctuation">.</span><span class="token punctuation">/</span>reder<span class="token punctuation">.</span>dhall</span>
<span class="highlight-line"></span>
<span class="token keyword">in</span>  <span class="token string">''
<span class="highlight-line">	<span class="token interpolation"><span class="token punctuation">${</span><span class="token expression language-dhall"><span class="token class-name">Render</span><span class="token punctuation">.</span><span class="token class-name">Dependency</span> <span class="token punctuation">(</span><span class="token class-name">Systemd</span><span class="token punctuation">.</span><span class="token class-name">Dependency</span><span class="token punctuation">.</span><span class="token class-name">Service</span> <span class="token string">"nfs-common.service"</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span></span></span>
	<span class="token interpolation"><span class="token punctuation">${</span><span class="token expression language-dhall"><span class="token class-name">Render</span><span class="token punctuation">.</span><span class="token class-name">Dependency</span>
		<span class="token punctuation">(</span><span class="token class-name">Systemd</span><span class="token punctuation">.</span><span class="token class-name">Dependency</span><span class="token punctuation">.</span><span class="token class-name">Runlevel</span> <span class="token class-name">Systemd</span><span class="token punctuation">.</span><span class="token class-name">Runlevel</span><span class="token punctuation">.</span>multiuser<span class="token punctuation">)</span></span><span class="token punctuation">}</span></span>
	''</span></code></pre>
</li>
</ol>
<h2 id="optional-fields-(autoexclusion)" tabindex="-1">Optional fields (autoexclusion) <a class="direct-link" href="#optional-fields-(autoexclusion)">#</a></h2>
<p>Sometimes you want a field to not appear if there is no value defined.</p>
<p>We'll define a helper function to render optionals. I use it frequently so I gave it a short name. Mine adds a newline automatically, so they don't appear if the option doesn't render.</p>
<p>:/render/ro.dhall</p>
<pre class="language-dhall"><code class="language-dhall"><span class="token comment">{-
<span class="highlight-line">	a: Type parameter</span>
<span class="highlight-line">	f: Renderer</span>
<span class="highlight-line">	opt: Value</span>
-}</span>
<span class="highlight-line"><span class="token operator">λ</span><span class="token punctuation">(</span>a <span class="token operator">:</span> <span class="token class-name">Type</span><span class="token punctuation">)</span> <span class="token operator">→</span></span>
<span class="highlight-line"><span class="token operator">λ</span><span class="token punctuation">(</span>f <span class="token operator">:</span> a <span class="token operator">→</span> <span class="token class-name">Text</span><span class="token punctuation">)</span> <span class="token operator">→</span></span>
<span class="highlight-line"><span class="token operator">λ</span><span class="token punctuation">(</span>opt <span class="token operator">:</span> <span class="token class-name">Optional</span> a<span class="token punctuation">)</span> <span class="token operator">→</span></span>
<span class="highlight-line">	<span class="token keyword">merge</span> <span class="token punctuation">{</span> <span class="token builtin">Some</span> <span class="token operator">=</span> <span class="token operator">λ</span><span class="token punctuation">(</span>x <span class="token operator">:</span> a<span class="token punctuation">)</span> <span class="token operator">→</span> f x <span class="token operator">++</span> <span class="token string">"\n"</span><span class="token punctuation">,</span> <span class="token builtin">None</span> <span class="token operator">=</span> <span class="token string">""</span> <span class="token punctuation">}</span> opt</span></code></pre>
<p>Using that one is a bit clunky:</p>
<pre class="language-dhall"><code class="language-dhall"><span class="highlight-line"><span class="token keyword">in</span>  <span class="token operator">λ</span><span class="token punctuation">(</span>i <span class="token operator">:</span> types<span class="token punctuation">.</span><span class="token class-name">Install</span><span class="token punctuation">)</span> <span class="token operator">→</span></span>
          <span class="token string">''
<span class="highlight-line">          [Install]</span>
          ''</span>
<span class="highlight-line">      <span class="token operator">++</span>  ro</span>
<span class="highlight-line">            types<span class="token punctuation">.</span><span class="token class-name">Dependency</span></span>
<span class="highlight-line">            <span class="token punctuation">(</span><span class="token operator">λ</span><span class="token punctuation">(</span>l <span class="token operator">:</span> types<span class="token punctuation">.</span><span class="token class-name">Dependency</span><span class="token punctuation">)</span> <span class="token operator">→</span> <span class="token string">"WantedBy=<span class="token interpolation"><span class="token punctuation">${</span><span class="token expression language-dhall"><span class="token punctuation">.</span><span class="token punctuation">/</span><span class="token class-name">Dependency</span><span class="token punctuation">.</span>dhall l</span><span class="token punctuation">}</span></span>"</span><span class="token punctuation">)</span></span>
<span class="highlight-line">            i<span class="token punctuation">.</span><span class="token class-name">WantedBy</span></span>
<span class="highlight-line"></span></code></pre>
<p>So I made this following helper, which works better with the config file format:</p>
<p>:/render/ron.dhall</p>
<pre class="language-dhall"><code class="language-dhall"><span class="highlight-line"><span class="token keyword">let</span> ro <span class="token operator">=</span> <span class="token punctuation">.</span><span class="token punctuation">/</span>ro<span class="token punctuation">.</span>dhall</span>
<span class="highlight-line"></span>
<span class="highlight-line"><span class="token keyword">in</span>  <span class="token operator">λ</span><span class="token punctuation">(</span>a <span class="token operator">:</span> <span class="token class-name">Type</span><span class="token punctuation">)</span> <span class="token operator">→</span></span>
<span class="highlight-line">    <span class="token operator">λ</span><span class="token punctuation">(</span>n <span class="token operator">:</span> <span class="token class-name">Text</span><span class="token punctuation">)</span> <span class="token operator">→</span></span>
<span class="highlight-line">    <span class="token operator">λ</span><span class="token punctuation">(</span>f <span class="token operator">:</span> a <span class="token operator">→</span> <span class="token class-name">Text</span><span class="token punctuation">)</span> <span class="token operator">→</span></span>
<span class="highlight-line">    <span class="token operator">λ</span><span class="token punctuation">(</span>opt <span class="token operator">:</span> <span class="token class-name">Optional</span> a<span class="token punctuation">)</span> <span class="token operator">→</span></span>
<span class="highlight-line">      ro a <span class="token punctuation">(</span><span class="token operator">λ</span><span class="token punctuation">(</span>l <span class="token operator">:</span> a<span class="token punctuation">)</span> <span class="token operator">→</span> <span class="token string">"<span class="token interpolation"><span class="token punctuation">${</span><span class="token expression language-dhall">n</span><span class="token punctuation">}</span></span>=<span class="token interpolation"><span class="token punctuation">${</span><span class="token expression language-dhall">f l</span><span class="token punctuation">}</span></span>"</span><span class="token punctuation">)</span> opt</span></code></pre>
<p>And can be used like:</p>
<pre class="language-dhall"><code class="language-dhall"><span class="highlight-line"><span class="token keyword">in</span>  <span class="token operator">λ</span><span class="token punctuation">(</span>i <span class="token operator">:</span> types<span class="token punctuation">.</span><span class="token class-name">Install</span><span class="token punctuation">)</span> <span class="token operator">→</span></span>
          <span class="token string">''
<span class="highlight-line">          [Install]</span>
          ''</span>
<span class="highlight-line">      <span class="token operator">++</span>  ron types<span class="token punctuation">.</span><span class="token class-name">Dependency</span> <span class="token string">"WantedBy"</span> <span class="token punctuation">.</span><span class="token punctuation">/</span><span class="token class-name">Dependency</span><span class="token punctuation">.</span>dhall i<span class="token punctuation">.</span><span class="token class-name">WantedBy</span></span></code></pre>
<p>If you find yourself frequently using the same type (for example, bools), you can make another wrapper for that. The dhall-nethack repo makes significant use of those, see the <a href="https://github.com/dhall-lang/dhall-nethack/blob/2b7ea599ae09c077bd8bda82cfb3c2601925e300/render/Config.dhall">config class</a></p>
<h2 id="multiple-exports-per-file" tabindex="-1">Multiple exports per file <a class="direct-link" href="#multiple-exports-per-file">#</a></h2>
<p>Dhall likes you to have a single type per file. But sometimes you have a group of types which don't make sense separately. Or you have a lot of types which are basically just type aliases for primitive types. You can export them in a file like so</p>
<p>:/ex.dhall</p>
<pre class="language-dhall"><code class="language-dhall"><span class="highlight-line"><span class="token punctuation">{</span> <span class="token class-name">Thing0</span> <span class="token operator">=</span> <span class="token class-name">Text</span><span class="token punctuation">,</span> <span class="token class-name">Thing1</span> <span class="token operator">=</span> <span class="token class-name">Integer</span> <span class="token punctuation">}</span></span></code></pre>
<p>and then use them like</p>
<pre class="language-dhall"><code class="language-dhall"><span class="highlight-line"><span class="token keyword">let</span> ex <span class="token operator">=</span> <span class="token punctuation">.</span><span class="token punctuation">/</span>ex<span class="token punctuation">.</span>dhall</span>
<span class="highlight-line"></span>
<span class="highlight-line"><span class="token keyword">let</span> y</span>
<span class="highlight-line">    <span class="token operator">:</span> ex<span class="token punctuation">.</span><span class="token class-name">Thing0</span></span>
<span class="highlight-line">    <span class="token operator">=</span> <span class="token string">"HELLO"</span></span>
<span class="highlight-line"></span>
<span class="highlight-line"><span class="token keyword">in</span> y</span></code></pre>
<p>If some of your types reference another, you'll need to pull the referenced type into a <code>let</code> higher in the file:</p>
<p>:/ex.dhall</p>
<pre class="language-dhall"><code class="language-dhall"><span class="highlight-line"><span class="token keyword">let</span> <span class="token class-name">T</span></span>
<span class="highlight-line">    <span class="token operator">:</span> <span class="token class-name">Type</span></span>
<span class="highlight-line">    <span class="token operator">=</span> <span class="token class-name">Text</span></span>
<span class="highlight-line"></span>
<span class="highlight-line"><span class="token keyword">in</span>  <span class="token punctuation">{</span> <span class="token class-name">T</span><span class="token punctuation">,</span> <span class="token class-name">ListOfT</span> <span class="token operator">=</span> <span class="token class-name">List</span> <span class="token class-name">T</span> <span class="token punctuation">}</span></span></code></pre>

</div>
</article>



<hr>
<ul><li>Next: <a href="/posts/fun_with_adodotnet/">Fun with ADO.NET</a></li><li>Previous: <a href="/posts/dhall_for_config_files/">Dhall for Config Files</a></li>
</ul>

		</main>
		<nav class="nav">
			<ul>
				<li class="nav-item"><a
						href="/">Home</a></li>
				<li class="nav-item"><a
						href="/posts/">Archive</a></li>
				<li class="nav-item"><a
						href="/tags/">Tags</a></li>
				<li class="nav-item"><a
						href="/series/">Series</a></li>
				<li class="nav-item"><a
						href="/about/">About Me</a></li>
				<li class="nav-item"><a
						href="/colophon/">Colophon</a></li>
				<li class="nav-item"><a
						href="/feedlist/">Feeds</a></li>
			</ul>
		</nav>
	</div>
</div>
<footer></footer>

<!-- Current page: /posts/dhall_common_tasks_for_config_files/ -->
</body>
</html>
