{
  "version": "https://jsonfeed.org/version/1",
  "title": "lilatomic",
  "home_page_url": "https://lilatomic.ca/",
  "feed_url": "https://lilatomic.ca/feed/feed.json",
  "description": "A place for my things",
  "author": {
    "name": "lilatomic",
    "url": "https://lilatomic.ca/about-me/"
  },
  "items": [{
      "id": "https://lilatomic.ca/posts/ansible_writing_facts_plugin/",
      "url": "https://lilatomic.ca/posts/ansible_writing_facts_plugin/",
      "title": "Writing a Vars Plugin in Ansible",
      "content_html": "<h1 id=\"writing-a-vars-plugin-in-ansible\">Writing a Vars Plugin in Ansible <a class=\"direct-link\" href=\"#writing-a-vars-plugin-in-ansible\">#</a></h1>\n<p>Often there are facts you wish were just ambiently available, especially if you are working with cloud infrastructure. For example, you might want to have your subscription id, tenant id, user object id, contents of a resource group, and many other things. You could have tasks which set these as facts, but that severly limits your ability to resume at a task.</p>\n<h2 id=\"basic-outline\">Basic outline <a class=\"direct-link\" href=\"#basic-outline\">#</a></h2>\n<p>The most basic version of a vars plugin is just a reflectable classname and method name.</p>\n<pre class=\"language-python\"><code class=\"language-python\"><span class=\"highlight-line\"><span class=\"token keyword\">from</span> ansible<span class=\"token punctuation\">.</span>plugins<span class=\"token punctuation\">.</span><span class=\"token builtin\">vars</span> <span class=\"token keyword\">import</span> BaseVarsPlugin</span><br><span class=\"highlight-line\"></span><br><span class=\"highlight-line\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">VarsModule</span><span class=\"token punctuation\">(</span>BaseVarsPlugin<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></span><br><span class=\"highlight-line\"></span><br><span class=\"highlight-line\">\t<span class=\"token keyword\">def</span> <span class=\"token function\">get_vars</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> loader<span class=\"token punctuation\">,</span> path<span class=\"token punctuation\">,</span> entities<span class=\"token punctuation\">,</span> cache<span class=\"token operator\">=</span><span class=\"token boolean\">None</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></span><br><span class=\"highlight-line\">\t\t<span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span></span></code></pre>\n<p>Let's get our documentation in order. We want to include this fragment to let people know how to set when the plugin runs (See <a href=\"#execution\">Execution</a> for why)</p>\n<pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"highlight-line\"><span class=\"token key atrule\">vars</span><span class=\"token punctuation\">:</span> gitroot</span><br><span class=\"highlight-line\"><span class=\"token key atrule\">version_added</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"0.2\"</span> <span class=\"token comment\"># for collections, use the collection version, not the Ansible version</span></span><br><span class=\"highlight-line\"><span class=\"token key atrule\">short_description</span><span class=\"token punctuation\">:</span> Finds the git root</span><br><span class=\"highlight-line\"><span class=\"token key atrule\">description</span><span class=\"token punctuation\">:</span> Finds the git root</span><br><span class=\"highlight-line\"><span class=\"token key atrule\">options</span><span class=\"token punctuation\">:</span></span><br><span class=\"highlight-line\">  <span class=\"token key atrule\">stage</span><span class=\"token punctuation\">:</span></span><br><span class=\"highlight-line\">    <span class=\"token key atrule\">ini</span><span class=\"token punctuation\">:</span></span><br><span class=\"highlight-line\">      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">key</span><span class=\"token punctuation\">:</span> stage</span><br><span class=\"highlight-line\">        <span class=\"token key atrule\">section</span><span class=\"token punctuation\">:</span> lilatomic.alpacloud.gitroot</span><br><span class=\"highlight-line\">    <span class=\"token key atrule\">env</span><span class=\"token punctuation\">:</span></span><br><span class=\"highlight-line\">      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> LILATOMIC_ALPACLOUD_GITROOT</span><br><span class=\"highlight-line\"><span class=\"token key atrule\">extends_documentation_fragment</span><span class=\"token punctuation\">:</span></span><br><span class=\"highlight-line\">  <span class=\"token punctuation\">-</span> vars_plugin_staging</span></code></pre>\n<p>Combining we get a sample like:</p>\n<pre class=\"language-python\"><code class=\"language-python\">DOCUMENTATION <span class=\"token operator\">=</span> <span class=\"token triple-quoted-string string\">r\"\"\"<br><span class=\"highlight-line\">vars: gitroot</span><br><span class=\"highlight-line\">version_added: \"0.2\"</span><br><span class=\"highlight-line\">short_description: Finds the git root</span><br><span class=\"highlight-line\">description: Finds the git root</span><br><span class=\"highlight-line\">options:</span><br><span class=\"highlight-line\">  stage:</span><br><span class=\"highlight-line\">    ini:</span><br><span class=\"highlight-line\">      - key: stage</span><br><span class=\"highlight-line\">        section: lilatomic.alpacloud.gitroot</span><br><span class=\"highlight-line\">    env:</span><br><span class=\"highlight-line\">      - name: LILATOMIC_ALPACLOUD_GITROOT</span><br><span class=\"highlight-line\">extends_documentation_fragment:</span><br><span class=\"highlight-line\">  - vars_plugin_staging</span><br>\"\"\"</span><br><span class=\"highlight-line\"></span><br><span class=\"highlight-line\"><span class=\"token keyword\">import</span> subprocess</span><br><span class=\"highlight-line\"></span><br><span class=\"highlight-line\"><span class=\"token keyword\">from</span> ansible<span class=\"token punctuation\">.</span>plugins<span class=\"token punctuation\">.</span><span class=\"token builtin\">vars</span> <span class=\"token keyword\">import</span> BaseVarsPlugin</span><br><span class=\"highlight-line\"></span><br><span class=\"highlight-line\"></span><br><span class=\"highlight-line\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">VarsModule</span><span class=\"token punctuation\">(</span>BaseVarsPlugin<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>  <span class=\"token comment\"># Must be named VarsModule</span></span><br><span class=\"highlight-line\">\t<span class=\"token keyword\">def</span> <span class=\"token function\">__init__</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>  <span class=\"token comment\"># Not necessary if you're just going to call up</span></span><br><span class=\"highlight-line\">\t\t<span class=\"token builtin\">super</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>__init__<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></span><br><span class=\"highlight-line\"></span><br><span class=\"highlight-line\">\t<span class=\"token keyword\">def</span> <span class=\"token function\">get_vars</span><span class=\"token punctuation\">(</span></span><br><span class=\"highlight-line\">\t\tself<span class=\"token punctuation\">,</span> loader<span class=\"token punctuation\">,</span> path<span class=\"token punctuation\">,</span> entities<span class=\"token punctuation\">,</span> cache<span class=\"token operator\">=</span><span class=\"token boolean\">None</span></span><br><span class=\"highlight-line\">\t<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>  <span class=\"token comment\"># the function which actualy does the lookup</span></span><br><span class=\"highlight-line\"></span><br><span class=\"highlight-line\">\t\t<span class=\"token comment\"># call to super. `self._basedir = basedir(path)`</span></span><br><span class=\"highlight-line\">\t\t<span class=\"token builtin\">super</span><span class=\"token punctuation\">(</span>VarsModule<span class=\"token punctuation\">,</span> self<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>get_vars<span class=\"token punctuation\">(</span>loader<span class=\"token punctuation\">,</span> path<span class=\"token punctuation\">,</span> entities<span class=\"token punctuation\">)</span></span><br><span class=\"highlight-line\"></span><br><span class=\"highlight-line\">\t\t<span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span><span class=\"token string\">\"src\"</span><span class=\"token punctuation\">:</span> _get_git_root<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span></span><br><span class=\"highlight-line\"></span><br><span class=\"highlight-line\"></span><br><span class=\"highlight-line\"><span class=\"token keyword\">def</span> <span class=\"token function\">_get_git_root</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></span><br><span class=\"highlight-line\">\tres <span class=\"token operator\">=</span> subprocess<span class=\"token punctuation\">.</span>run<span class=\"token punctuation\">(</span></span><br><span class=\"highlight-line\">\t\t<span class=\"token string\">\"git rev-parse --show-toplevel\"</span><span class=\"token punctuation\">.</span>split<span class=\"token punctuation\">(</span><span class=\"token string\">\" \"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></span><br><span class=\"highlight-line\">\t\tstdout<span class=\"token operator\">=</span>subprocess<span class=\"token punctuation\">.</span>PIPE<span class=\"token punctuation\">,</span></span><br><span class=\"highlight-line\">\t\tuniversal_newlines<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">,</span></span><br><span class=\"highlight-line\">\t<span class=\"token punctuation\">)</span></span><br><span class=\"highlight-line\">\t<span class=\"token keyword\">return</span> res<span class=\"token punctuation\">.</span>stdout</span></code></pre>\n<p>This sample is really bad, because it gets executed <em>a lot</em> (See <a href=\"#execution\">Execution</a>). So we want to build some caching into it. This is patterned off of how host_group_vars does it (the only vars plugin included in base), but other vars plugins do a similar thing:</p>\n<pre class=\"language-python\"><code class=\"language-python\">DOCUMENTATION <span class=\"token operator\">=</span> <span class=\"token triple-quoted-string string\">r\"\"\"<br><span class=\"highlight-line\">vars: gitroot</span><br><span class=\"highlight-line\">version_added: \"0.2\"</span><br><span class=\"highlight-line\">short_description: Finds the git root</span><br><span class=\"highlight-line\">description: Finds the git root</span><br><span class=\"highlight-line\">options:</span><br><span class=\"highlight-line\">  stage:</span><br><span class=\"highlight-line\">    ini:</span><br><span class=\"highlight-line\">      - key: stage</span><br><span class=\"highlight-line\">        section: lilatomic.alpacloud.gitroot</span><br><span class=\"highlight-line\">    env:</span><br><span class=\"highlight-line\">      - name: LILATOMIC_ALPACLOUD_GITROOT</span><br><span class=\"highlight-line\">extends_documentation_fragment:</span><br><span class=\"highlight-line\">  - vars_plugin_staging</span><br>\"\"\"</span><br><span class=\"highlight-line\"></span><br><span class=\"highlight-line\"><span class=\"token keyword\">import</span> subprocess</span><br><span class=\"highlight-line\"></span><br><span class=\"highlight-line\"><span class=\"token keyword\">from</span> ansible<span class=\"token punctuation\">.</span>plugins<span class=\"token punctuation\">.</span><span class=\"token builtin\">vars</span> <span class=\"token keyword\">import</span> BaseVarsPlugin</span><br><span class=\"highlight-line\"></span><br><span class=\"highlight-line\"></span><br><span class=\"highlight-line\">FOUND <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span></span><br><span class=\"highlight-line\"></span><br><span class=\"highlight-line\"></span><br><span class=\"highlight-line\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">VarsModule</span><span class=\"token punctuation\">(</span>BaseVarsPlugin<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></span><br><span class=\"highlight-line\">\t<span class=\"token keyword\">def</span> <span class=\"token function\">get_vars</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> loader<span class=\"token punctuation\">,</span> path<span class=\"token punctuation\">,</span> entities<span class=\"token punctuation\">,</span> cache<span class=\"token operator\">=</span><span class=\"token boolean\">None</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></span><br><span class=\"highlight-line\"></span><br><span class=\"highlight-line\">\t\t<span class=\"token keyword\">if</span> <span class=\"token keyword\">not</span> <span class=\"token builtin\">isinstance</span><span class=\"token punctuation\">(</span>entities<span class=\"token punctuation\">,</span> <span class=\"token builtin\">list</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></span><br><span class=\"highlight-line\">\t\t\tentities <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>entities<span class=\"token punctuation\">]</span></span><br><span class=\"highlight-line\"></span><br><span class=\"highlight-line\">\t\t<span class=\"token builtin\">super</span><span class=\"token punctuation\">(</span>VarsModule<span class=\"token punctuation\">,</span> self<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>get_vars<span class=\"token punctuation\">(</span>loader<span class=\"token punctuation\">,</span> path<span class=\"token punctuation\">,</span> entities<span class=\"token punctuation\">)</span></span><br><span class=\"highlight-line\"></span><br><span class=\"highlight-line\">\t\t<span class=\"token keyword\">if</span> <span class=\"token string\">\"src\"</span> <span class=\"token keyword\">not</span> <span class=\"token keyword\">in</span> FOUND<span class=\"token punctuation\">:</span></span><br><span class=\"highlight-line\">\t\t\tFOUND<span class=\"token punctuation\">[</span><span class=\"token string\">\"src\"</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> _get_git_root<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></span><br><span class=\"highlight-line\"></span><br><span class=\"highlight-line\">\t\t<span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span><span class=\"token string\">\"src\"</span><span class=\"token punctuation\">:</span> FOUND<span class=\"token punctuation\">[</span><span class=\"token string\">\"src\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">}</span></span><br><span class=\"highlight-line\"></span><br><span class=\"highlight-line\"></span><br><span class=\"highlight-line\"><span class=\"token keyword\">def</span> <span class=\"token function\">_get_git_root</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></span><br><span class=\"highlight-line\">\tres <span class=\"token operator\">=</span> subprocess<span class=\"token punctuation\">.</span>run<span class=\"token punctuation\">(</span></span><br><span class=\"highlight-line\">\t\t<span class=\"token string\">\"git rev-parse --show-toplevel\"</span><span class=\"token punctuation\">.</span>split<span class=\"token punctuation\">(</span><span class=\"token string\">\" \"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></span><br><span class=\"highlight-line\">\t\tstdout<span class=\"token operator\">=</span>subprocess<span class=\"token punctuation\">.</span>PIPE<span class=\"token punctuation\">,</span></span><br><span class=\"highlight-line\">\t\tuniversal_newlines<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">,</span></span><br><span class=\"highlight-line\">\t<span class=\"token punctuation\">)</span></span><br><span class=\"highlight-line\">\t<span class=\"token keyword\">return</span> res<span class=\"token punctuation\">.</span>stdout</span></code></pre>\n<h2 id=\"using-hosts-and-groups\">Using hosts and groups <a class=\"direct-link\" href=\"#using-hosts-and-groups\">#</a></h2>\n<p>In the above example, we added a general var (one which isn't attached to a particular host). We may want to add other data associated with each host or group. There are a couple moving pieces detailed in the following:</p>\n<pre class=\"language-python\"><code class=\"language-python\">DOCUMENTATION <span class=\"token operator\">=</span> <span class=\"token triple-quoted-string string\">r\"\"\"<br><span class=\"highlight-line\">vars: knownhostentry</span><br><span class=\"highlight-line\">version_added: \"0.2\"</span><br><span class=\"highlight-line\">short_description: Adds a known-hosts entry for each host, if you have one</span><br><span class=\"highlight-line\">description: </span><br><span class=\"highlight-line\">  - Adds a known-hosts entry for each host, if you have one in you local known-hosts</span><br><span class=\"highlight-line\">  - Useful for not having to construct it every time</span><br><span class=\"highlight-line\">options:</span><br><span class=\"highlight-line\">  stage:</span><br><span class=\"highlight-line\">    ini:</span><br><span class=\"highlight-line\">      - key: stage</span><br><span class=\"highlight-line\">        section: lilatomic.alpacloud.knownhostentry</span><br><span class=\"highlight-line\">    env:</span><br><span class=\"highlight-line\">      - name: LILATOMIC_ALPACLOUD_KNOWNHOSTENTRY</span><br><span class=\"highlight-line\">extends_documentation_fragment:</span><br><span class=\"highlight-line\">  - vars_plugin_staging</span><br>\"\"\"</span><br><span class=\"highlight-line\"><span class=\"token keyword\">import</span> json</span><br><span class=\"highlight-line\"><span class=\"token keyword\">import</span> os</span><br><span class=\"highlight-line\"><span class=\"token keyword\">import</span> subprocess</span><br><span class=\"highlight-line\"></span><br><span class=\"highlight-line\"><span class=\"token keyword\">from</span> ansible<span class=\"token punctuation\">.</span>errors <span class=\"token keyword\">import</span> AnsibleParserError</span><br><span class=\"highlight-line\"><span class=\"token keyword\">from</span> ansible<span class=\"token punctuation\">.</span>module_utils<span class=\"token punctuation\">.</span>_text <span class=\"token keyword\">import</span> to_bytes<span class=\"token punctuation\">,</span> to_native<span class=\"token punctuation\">,</span> to_text</span><br><span class=\"highlight-line\"><span class=\"token keyword\">from</span> ansible<span class=\"token punctuation\">.</span>plugins<span class=\"token punctuation\">.</span><span class=\"token builtin\">vars</span> <span class=\"token keyword\">import</span> BaseVarsPlugin</span><br><span class=\"highlight-line\"><span class=\"token keyword\">from</span> ansible<span class=\"token punctuation\">.</span>inventory<span class=\"token punctuation\">.</span>host <span class=\"token keyword\">import</span> Host</span><br><span class=\"highlight-line\"><span class=\"token keyword\">from</span> ansible<span class=\"token punctuation\">.</span>inventory<span class=\"token punctuation\">.</span>group <span class=\"token keyword\">import</span> Group</span><br><span class=\"highlight-line\"><span class=\"token keyword\">from</span> ansible<span class=\"token punctuation\">.</span>utils<span class=\"token punctuation\">.</span><span class=\"token builtin\">vars</span> <span class=\"token keyword\">import</span> combine_vars</span><br><span class=\"highlight-line\"></span><br><span class=\"highlight-line\"></span><br><span class=\"highlight-line\"><span class=\"token keyword\">from</span> ansible<span class=\"token punctuation\">.</span>utils<span class=\"token punctuation\">.</span>display <span class=\"token keyword\">import</span> Display</span><br><span class=\"highlight-line\"></span><br><span class=\"highlight-line\">display <span class=\"token operator\">=</span> Display<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></span><br><span class=\"highlight-line\"></span><br><span class=\"highlight-line\">FOUND <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span></span><br><span class=\"highlight-line\"></span><br><span class=\"highlight-line\"></span><br><span class=\"highlight-line\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">VarsModule</span><span class=\"token punctuation\">(</span>BaseVarsPlugin<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></span><br><span class=\"highlight-line\">\t<span class=\"token keyword\">def</span> <span class=\"token function\">get_vars</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> loader<span class=\"token punctuation\">,</span> path<span class=\"token punctuation\">,</span> entities<span class=\"token punctuation\">,</span> cache<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></span><br><span class=\"highlight-line\"></span><br><span class=\"highlight-line\">\t\t<span class=\"token comment\"># not sure what this is about, it's not invoked when I run it</span></span><br><span class=\"highlight-line\">\t\t<span class=\"token comment\"># there's probably a compatibility thing</span></span><br><span class=\"highlight-line\">\t\t<span class=\"token keyword\">if</span> <span class=\"token keyword\">not</span> <span class=\"token builtin\">isinstance</span><span class=\"token punctuation\">(</span>entities<span class=\"token punctuation\">,</span> <span class=\"token builtin\">list</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></span><br><span class=\"highlight-line\">\t\t\tentities <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>entities<span class=\"token punctuation\">]</span></span><br><span class=\"highlight-line\"></span><br><span class=\"highlight-line\">\t\t<span class=\"token builtin\">super</span><span class=\"token punctuation\">(</span>VarsModule<span class=\"token punctuation\">,</span> self<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>get_vars<span class=\"token punctuation\">(</span>loader<span class=\"token punctuation\">,</span> path<span class=\"token punctuation\">,</span> entities<span class=\"token punctuation\">)</span></span><br><span class=\"highlight-line\"></span><br><span class=\"highlight-line\">\t\tdata <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span></span><br><span class=\"highlight-line\">\t\t<span class=\"token comment\"># loop through entities</span></span><br><span class=\"highlight-line\">\t\t<span class=\"token keyword\">for</span> entity <span class=\"token keyword\">in</span> entities<span class=\"token punctuation\">:</span></span><br><span class=\"highlight-line\">\t\t\t<span class=\"token comment\"># entities come as either Hosts or Groups. This example ignores groups.</span></span><br><span class=\"highlight-line\">\t\t\t<span class=\"token keyword\">if</span> <span class=\"token builtin\">isinstance</span><span class=\"token punctuation\">(</span>entity<span class=\"token punctuation\">,</span> Host<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></span><br><span class=\"highlight-line\">\t\t\t\t<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span></span><br><span class=\"highlight-line\">\t\t\t<span class=\"token keyword\">elif</span> <span class=\"token builtin\">isinstance</span><span class=\"token punctuation\">(</span>entity<span class=\"token punctuation\">,</span> Group<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></span><br><span class=\"highlight-line\">\t\t\t\t<span class=\"token keyword\">continue</span></span><br><span class=\"highlight-line\">\t\t\t<span class=\"token keyword\">else</span><span class=\"token punctuation\">:</span></span><br><span class=\"highlight-line\">\t\t\t\t<span class=\"token keyword\">raise</span> AnsibleParserError<span class=\"token punctuation\">(</span></span><br><span class=\"highlight-line\">\t\t\t\t\t<span class=\"token string\">\"Supplied entity must be Host or Group, got %s instead\"</span> <span class=\"token operator\">%</span> <span class=\"token punctuation\">(</span><span class=\"token builtin\">type</span><span class=\"token punctuation\">(</span>entity<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></span><br><span class=\"highlight-line\">\t\t\t\t<span class=\"token punctuation\">)</span></span><br><span class=\"highlight-line\"></span><br><span class=\"highlight-line\">\t\t\t<span class=\"token keyword\">if</span> entity<span class=\"token punctuation\">.</span>name<span class=\"token punctuation\">.</span>startswith<span class=\"token punctuation\">(</span>os<span class=\"token punctuation\">.</span>path<span class=\"token punctuation\">.</span>sep<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></span><br><span class=\"highlight-line\">\t\t\t\t<span class=\"token comment\"># avoid 'chroot' type inventory hostnames /path/to/chroot</span></span><br><span class=\"highlight-line\">\t\t\t\t<span class=\"token comment\"># this is from the sample plugin</span></span><br><span class=\"highlight-line\">\t\t\t\t<span class=\"token keyword\">continue</span></span><br><span class=\"highlight-line\"></span><br><span class=\"highlight-line\">\t\t\t<span class=\"token keyword\">try</span><span class=\"token punctuation\">:</span></span><br><span class=\"highlight-line\">\t\t\t\tkey <span class=\"token operator\">=</span> <span class=\"token builtin\">str</span><span class=\"token punctuation\">(</span>entity<span class=\"token punctuation\">.</span>name<span class=\"token punctuation\">)</span></span><br><span class=\"highlight-line\">\t\t\t\t<span class=\"token keyword\">if</span> cache <span class=\"token keyword\">and</span> key <span class=\"token keyword\">in</span> FOUND<span class=\"token punctuation\">:</span></span><br><span class=\"highlight-line\">\t\t\t\t\tknown_hosts <span class=\"token operator\">=</span> FOUND<span class=\"token punctuation\">[</span>key<span class=\"token punctuation\">]</span></span><br><span class=\"highlight-line\">\t\t\t\t<span class=\"token keyword\">else</span><span class=\"token punctuation\">:</span></span><br><span class=\"highlight-line\">\t\t\t\t\tFOUND<span class=\"token punctuation\">[</span>key<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> _get_known_host<span class=\"token punctuation\">(</span>entity<span class=\"token punctuation\">.</span>name<span class=\"token punctuation\">)</span></span><br><span class=\"highlight-line\">\t\t\t\t\tknown_hosts <span class=\"token operator\">=</span> FOUND<span class=\"token punctuation\">[</span>key<span class=\"token punctuation\">]</span></span><br><span class=\"highlight-line\"></span><br><span class=\"highlight-line\">\t\t\t\t<span class=\"token keyword\">if</span> known_hosts<span class=\"token punctuation\">:</span></span><br><span class=\"highlight-line\">\t\t\t\t\tdata<span class=\"token punctuation\">[</span><span class=\"token string\">\"known_hosts\"</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> known_hosts</span><br><span class=\"highlight-line\"></span><br><span class=\"highlight-line\">\t\t\t<span class=\"token keyword\">except</span> Exception <span class=\"token keyword\">as</span> e<span class=\"token punctuation\">:</span></span><br><span class=\"highlight-line\">\t\t\t\tdisplay<span class=\"token punctuation\">.</span>warning<span class=\"token punctuation\">(</span><span class=\"token string\">\"HALP\"</span><span class=\"token punctuation\">)</span></span><br><span class=\"highlight-line\">\t\t\t\t<span class=\"token keyword\">raise</span> AnsibleParserError<span class=\"token punctuation\">(</span>to_native<span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></span><br><span class=\"highlight-line\"></span><br><span class=\"highlight-line\">\t\tdisplay<span class=\"token punctuation\">.</span>v<span class=\"token punctuation\">(</span>json<span class=\"token punctuation\">.</span>dumps<span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></span><br><span class=\"highlight-line\">\t\t<span class=\"token keyword\">return</span> data</span><br><span class=\"highlight-line\"></span><br><span class=\"highlight-line\"></span><br><span class=\"highlight-line\"><span class=\"token keyword\">def</span> <span class=\"token function\">_get_known_host</span><span class=\"token punctuation\">(</span>host<span class=\"token punctuation\">,</span> <span class=\"token builtin\">file</span><span class=\"token operator\">=</span><span class=\"token string\">\"~/.ssh/known_hosts\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></span><br><span class=\"highlight-line\">\t<span class=\"token builtin\">file</span> <span class=\"token operator\">=</span> os<span class=\"token punctuation\">.</span>path<span class=\"token punctuation\">.</span>expanduser<span class=\"token punctuation\">(</span><span class=\"token builtin\">file</span><span class=\"token punctuation\">)</span></span><br><span class=\"highlight-line\"></span><br><span class=\"highlight-line\">\tcmd <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"/usr/bin/ssh-keygen\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"-f\"</span><span class=\"token punctuation\">,</span> <span class=\"token builtin\">file</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"-F\"</span><span class=\"token punctuation\">,</span> host<span class=\"token punctuation\">]</span></span><br><span class=\"highlight-line\"></span><br><span class=\"highlight-line\">\tdisplay<span class=\"token punctuation\">.</span>v<span class=\"token punctuation\">(</span><span class=\"token string-interpolation\"><span class=\"token string\">f\"cmd : </span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>cmd<span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">)</span></span><br><span class=\"highlight-line\">\tres <span class=\"token operator\">=</span> subprocess<span class=\"token punctuation\">.</span>run<span class=\"token punctuation\">(</span></span><br><span class=\"highlight-line\">\t\tcmd<span class=\"token punctuation\">,</span> stdout<span class=\"token operator\">=</span>subprocess<span class=\"token punctuation\">.</span>PIPE<span class=\"token punctuation\">,</span> stderr<span class=\"token operator\">=</span>subprocess<span class=\"token punctuation\">.</span>PIPE<span class=\"token punctuation\">,</span> universal_newlines<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">,</span></span><br><span class=\"highlight-line\">\t<span class=\"token punctuation\">)</span></span><br><span class=\"highlight-line\">\tdisplay<span class=\"token punctuation\">.</span>v<span class=\"token punctuation\">(</span><span class=\"token string-interpolation\"><span class=\"token string\">f\"stdout </span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>res<span class=\"token punctuation\">.</span>stdout<span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">)</span></span><br><span class=\"highlight-line\">\tdisplay<span class=\"token punctuation\">.</span>v<span class=\"token punctuation\">(</span><span class=\"token string-interpolation\"><span class=\"token string\">f\"stderr </span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>res<span class=\"token punctuation\">.</span>stderr<span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">)</span></span><br><span class=\"highlight-line\">\tdisplay<span class=\"token punctuation\">.</span>warning<span class=\"token punctuation\">(</span>res<span class=\"token punctuation\">.</span>stderr<span class=\"token punctuation\">)</span></span><br><span class=\"highlight-line\">\tlines <span class=\"token operator\">=</span> res<span class=\"token punctuation\">.</span>stdout<span class=\"token punctuation\">.</span>split<span class=\"token punctuation\">(</span><span class=\"token string\">\"\\n\"</span><span class=\"token punctuation\">)</span></span><br><span class=\"highlight-line\">\thostlines <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>x <span class=\"token keyword\">for</span> x <span class=\"token keyword\">in</span> lines <span class=\"token keyword\">if</span> x <span class=\"token keyword\">and</span> <span class=\"token keyword\">not</span> x<span class=\"token punctuation\">.</span>startswith<span class=\"token punctuation\">(</span><span class=\"token string\">\"#\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span></span><br><span class=\"highlight-line\">\t<span class=\"token keyword\">return</span> hostlines</span><br><span class=\"highlight-line\"></span></code></pre>\n<h2 id=\"loading-files\">Loading files <a class=\"direct-link\" href=\"#loading-files\">#</a></h2>\n<p>You can probably figure out how to load files by cribbing from the host_group_vars plugin. I've included one here for completeness. The main difference is that <code>loader.load_from_file</code> only supports YAML/JSON, so we write our own little functionlet.</p>\n<pre class=\"language-python\"><code class=\"language-python\">DOCUMENTATION <span class=\"token operator\">=</span> <span class=\"token triple-quoted-string string\">r\"\"\"<br><span class=\"highlight-line\">vars: dhall_vars</span><br><span class=\"highlight-line\">version_added: \"0.2\"</span><br><span class=\"highlight-line\">short_description: Loads vars from a Dhall file</span><br><span class=\"highlight-line\">description: </span><br><span class=\"highlight-line\">  - Loads vars from a Dhall file</span><br><span class=\"highlight-line\">options:</span><br><span class=\"highlight-line\">  stage:</span><br><span class=\"highlight-line\">    ini:</span><br><span class=\"highlight-line\">      - key: stage</span><br><span class=\"highlight-line\">        section: lilatomic.alpacloud.dhall_vars</span><br><span class=\"highlight-line\">    env:</span><br><span class=\"highlight-line\">      - name: LILATOMIC_ALPACLOUD_DHALL_VARS</span><br><span class=\"highlight-line\">extends_documentation_fragment:</span><br><span class=\"highlight-line\">  - vars_plugin_staging</span><br>\"\"\"</span><br><span class=\"highlight-line\"></span><br><span class=\"highlight-line\"><span class=\"token keyword\">import</span> os</span><br><span class=\"highlight-line\"><span class=\"token keyword\">import</span> subprocess</span><br><span class=\"highlight-line\"></span><br><span class=\"highlight-line\"><span class=\"token keyword\">from</span> ansible<span class=\"token punctuation\">.</span>errors <span class=\"token keyword\">import</span> AnsibleParserError</span><br><span class=\"highlight-line\"><span class=\"token keyword\">from</span> ansible<span class=\"token punctuation\">.</span>module_utils<span class=\"token punctuation\">.</span>_text <span class=\"token keyword\">import</span> to_bytes<span class=\"token punctuation\">,</span> to_native<span class=\"token punctuation\">,</span> to_text</span><br><span class=\"highlight-line\"><span class=\"token keyword\">from</span> ansible<span class=\"token punctuation\">.</span>plugins<span class=\"token punctuation\">.</span><span class=\"token builtin\">vars</span> <span class=\"token keyword\">import</span> BaseVarsPlugin</span><br><span class=\"highlight-line\"><span class=\"token keyword\">from</span> ansible<span class=\"token punctuation\">.</span>inventory<span class=\"token punctuation\">.</span>host <span class=\"token keyword\">import</span> Host</span><br><span class=\"highlight-line\"><span class=\"token keyword\">from</span> ansible<span class=\"token punctuation\">.</span>inventory<span class=\"token punctuation\">.</span>group <span class=\"token keyword\">import</span> Group</span><br><span class=\"highlight-line\"><span class=\"token keyword\">from</span> ansible<span class=\"token punctuation\">.</span>utils<span class=\"token punctuation\">.</span><span class=\"token builtin\">vars</span> <span class=\"token keyword\">import</span> combine_vars</span><br><span class=\"highlight-line\"></span><br><span class=\"highlight-line\"><span class=\"token keyword\">import</span> dhall</span><br><span class=\"highlight-line\"></span><br><span class=\"highlight-line\"></span><br><span class=\"highlight-line\">FOUND <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span></span><br><span class=\"highlight-line\"></span><br><span class=\"highlight-line\"></span><br><span class=\"highlight-line\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">VarsModule</span><span class=\"token punctuation\">(</span>BaseVarsPlugin<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></span><br><span class=\"highlight-line\">\t<span class=\"token keyword\">def</span> <span class=\"token function\">get_vars</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> loader<span class=\"token punctuation\">,</span> path<span class=\"token punctuation\">,</span> entities<span class=\"token punctuation\">,</span> cache<span class=\"token operator\">=</span><span class=\"token boolean\">None</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></span><br><span class=\"highlight-line\"></span><br><span class=\"highlight-line\">\t\t<span class=\"token keyword\">if</span> <span class=\"token keyword\">not</span> <span class=\"token builtin\">isinstance</span><span class=\"token punctuation\">(</span>entities<span class=\"token punctuation\">,</span> <span class=\"token builtin\">list</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></span><br><span class=\"highlight-line\">\t\t\tentities <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>entities<span class=\"token punctuation\">]</span></span><br><span class=\"highlight-line\"></span><br><span class=\"highlight-line\">\t\t<span class=\"token builtin\">super</span><span class=\"token punctuation\">(</span>VarsModule<span class=\"token punctuation\">,</span> self<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>get_vars<span class=\"token punctuation\">(</span>loader<span class=\"token punctuation\">,</span> path<span class=\"token punctuation\">,</span> entities<span class=\"token punctuation\">)</span></span><br><span class=\"highlight-line\"></span><br><span class=\"highlight-line\">\t\tdata <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span></span><br><span class=\"highlight-line\"></span><br><span class=\"highlight-line\">\t\t<span class=\"token keyword\">for</span> entity <span class=\"token keyword\">in</span> entities<span class=\"token punctuation\">:</span></span><br><span class=\"highlight-line\">\t\t\t<span class=\"token comment\"># we set the subdir here</span></span><br><span class=\"highlight-line\">\t\t\t<span class=\"token keyword\">if</span> <span class=\"token builtin\">isinstance</span><span class=\"token punctuation\">(</span>entity<span class=\"token punctuation\">,</span> Host<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></span><br><span class=\"highlight-line\">\t\t\t\tsubdir <span class=\"token operator\">=</span> <span class=\"token string\">\"host_vars\"</span></span><br><span class=\"highlight-line\">\t\t\t<span class=\"token keyword\">elif</span> <span class=\"token builtin\">isinstance</span><span class=\"token punctuation\">(</span>entity<span class=\"token punctuation\">,</span> Group<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></span><br><span class=\"highlight-line\">\t\t\t\tsubdir <span class=\"token operator\">=</span> <span class=\"token string\">\"group_vars\"</span></span><br><span class=\"highlight-line\">\t\t\t<span class=\"token keyword\">else</span><span class=\"token punctuation\">:</span></span><br><span class=\"highlight-line\">\t\t\t\t<span class=\"token keyword\">raise</span> AnsibleParserError<span class=\"token punctuation\">(</span></span><br><span class=\"highlight-line\">\t\t\t\t\t<span class=\"token string\">\"Supplied entity must be Host or Group, got %s instead\"</span> <span class=\"token operator\">%</span> <span class=\"token punctuation\">(</span><span class=\"token builtin\">type</span><span class=\"token punctuation\">(</span>entity<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></span><br><span class=\"highlight-line\">\t\t\t\t<span class=\"token punctuation\">)</span></span><br><span class=\"highlight-line\"></span><br><span class=\"highlight-line\">\t\t\t<span class=\"token comment\"># avoid 'chroot' type inventory hostnames /path/to/chroot</span></span><br><span class=\"highlight-line\">\t\t\t<span class=\"token keyword\">if</span> entity<span class=\"token punctuation\">.</span>name<span class=\"token punctuation\">.</span>startswith<span class=\"token punctuation\">(</span>os<span class=\"token punctuation\">.</span>path<span class=\"token punctuation\">.</span>sep<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></span><br><span class=\"highlight-line\">\t\t\t\t<span class=\"token keyword\">continue</span></span><br><span class=\"highlight-line\"></span><br><span class=\"highlight-line\">\t\t\t<span class=\"token keyword\">try</span><span class=\"token punctuation\">:</span></span><br><span class=\"highlight-line\">\t\t\t\t<span class=\"token comment\"># mostly copied from host_group_vars</span></span><br><span class=\"highlight-line\">\t\t\t\tfound_files <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span></span><br><span class=\"highlight-line\">\t\t\t\t<span class=\"token comment\"># load vars</span></span><br><span class=\"highlight-line\">\t\t\t\tb_opath <span class=\"token operator\">=</span> os<span class=\"token punctuation\">.</span>path<span class=\"token punctuation\">.</span>realpath<span class=\"token punctuation\">(</span>to_bytes<span class=\"token punctuation\">(</span>os<span class=\"token punctuation\">.</span>path<span class=\"token punctuation\">.</span>join<span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">.</span>_basedir<span class=\"token punctuation\">,</span> subdir<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></span><br><span class=\"highlight-line\">\t\t\t\topath <span class=\"token operator\">=</span> to_text<span class=\"token punctuation\">(</span>b_opath<span class=\"token punctuation\">)</span></span><br><span class=\"highlight-line\">\t\t\t\tself<span class=\"token punctuation\">.</span>_display<span class=\"token punctuation\">.</span>v<span class=\"token punctuation\">(</span><span class=\"token string\">\"\\tprocessing dir %s\"</span> <span class=\"token operator\">%</span> opath<span class=\"token punctuation\">)</span></span><br><span class=\"highlight-line\"></span><br><span class=\"highlight-line\">\t\t\t\t<span class=\"token comment\"># We set the cache key to be specific to both entity and file</span></span><br><span class=\"highlight-line\">\t\t\t\tkey <span class=\"token operator\">=</span> <span class=\"token string\">\"%s.%s\"</span> <span class=\"token operator\">%</span> <span class=\"token punctuation\">(</span>entity<span class=\"token punctuation\">.</span>name<span class=\"token punctuation\">,</span> opath<span class=\"token punctuation\">)</span></span><br><span class=\"highlight-line\">\t\t\t\t<span class=\"token keyword\">if</span> cache <span class=\"token keyword\">and</span> key <span class=\"token keyword\">in</span> FOUND<span class=\"token punctuation\">:</span></span><br><span class=\"highlight-line\">\t\t\t\t\t<span class=\"token comment\"># cache hit</span></span><br><span class=\"highlight-line\">\t\t\t\t\tfound_files <span class=\"token operator\">=</span> FOUND<span class=\"token punctuation\">[</span>key<span class=\"token punctuation\">]</span></span><br><span class=\"highlight-line\">\t\t\t\t<span class=\"token keyword\">else</span><span class=\"token punctuation\">:</span></span><br><span class=\"highlight-line\">\t\t\t\t\t<span class=\"token keyword\">if</span> os<span class=\"token punctuation\">.</span>path<span class=\"token punctuation\">.</span>exists<span class=\"token punctuation\">(</span>b_opath<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></span><br><span class=\"highlight-line\">\t\t\t\t\t\t<span class=\"token keyword\">if</span> os<span class=\"token punctuation\">.</span>path<span class=\"token punctuation\">.</span>isdir<span class=\"token punctuation\">(</span>b_opath<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></span><br><span class=\"highlight-line\">\t\t\t\t\t\t\tself<span class=\"token punctuation\">.</span>_display<span class=\"token punctuation\">.</span>debug<span class=\"token punctuation\">(</span><span class=\"token string\">\"\\tprocessing dir %s\"</span> <span class=\"token operator\">%</span> opath<span class=\"token punctuation\">)</span></span><br><span class=\"highlight-line\">\t\t\t\t\t\t\t<span class=\"token comment\"># use the file loader to load</span></span><br><span class=\"highlight-line\">\t\t\t\t\t\t\tfound_files <span class=\"token operator\">=</span> loader<span class=\"token punctuation\">.</span>find_vars_files<span class=\"token punctuation\">(</span></span><br><span class=\"highlight-line\">\t\t\t\t\t\t\t\tpath<span class=\"token operator\">=</span>opath<span class=\"token punctuation\">,</span></span><br><span class=\"highlight-line\">\t\t\t\t\t\t\t\tname<span class=\"token operator\">=</span>entity<span class=\"token punctuation\">.</span>name<span class=\"token punctuation\">,</span></span><br><span class=\"highlight-line\">\t\t\t\t\t\t\t\textensions<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span><span class=\"token string\">\"\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\".dhall\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></span><br><span class=\"highlight-line\">\t\t\t\t\t\t\t\t<span class=\"token comment\"># allow_dir=True</span></span><br><span class=\"highlight-line\">\t\t\t\t\t\t\t<span class=\"token punctuation\">)</span></span><br><span class=\"highlight-line\">\t\t\t\t\t\t<span class=\"token keyword\">else</span><span class=\"token punctuation\">:</span></span><br><span class=\"highlight-line\">\t\t\t\t\t\t\tself<span class=\"token punctuation\">.</span>_display<span class=\"token punctuation\">.</span>warning<span class=\"token punctuation\">(</span></span><br><span class=\"highlight-line\">\t\t\t\t\t\t\t\t<span class=\"token string\">\"Found %s that is not a directory, skipping: %s\"</span> <span class=\"token operator\">%</span> <span class=\"token punctuation\">(</span>subdir<span class=\"token punctuation\">,</span> opath<span class=\"token punctuation\">)</span></span><br><span class=\"highlight-line\">\t\t\t\t\t\t\t<span class=\"token punctuation\">)</span></span><br><span class=\"highlight-line\"></span><br><span class=\"highlight-line\">\t\t\t\t<span class=\"token keyword\">for</span> found <span class=\"token keyword\">in</span> found_files<span class=\"token punctuation\">:</span></span><br><span class=\"highlight-line\">\t\t\t\t\tnew_data <span class=\"token operator\">=</span> _read_dhall_file<span class=\"token punctuation\">(</span>found<span class=\"token punctuation\">)</span></span><br><span class=\"highlight-line\">\t\t\t\t\t<span class=\"token keyword\">if</span> new_data<span class=\"token punctuation\">:</span>  <span class=\"token comment\"># ignore empty files</span></span><br><span class=\"highlight-line\">\t\t\t\t\t\tdata <span class=\"token operator\">=</span> combine_vars<span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">,</span> new_data<span class=\"token punctuation\">)</span></span><br><span class=\"highlight-line\"></span><br><span class=\"highlight-line\">\t\t\t<span class=\"token keyword\">except</span> Exception <span class=\"token keyword\">as</span> e<span class=\"token punctuation\">:</span></span><br><span class=\"highlight-line\">\t\t\t\t<span class=\"token keyword\">raise</span> AnsibleParserError<span class=\"token punctuation\">(</span>to_native<span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></span><br><span class=\"highlight-line\"></span><br><span class=\"highlight-line\">\t\t<span class=\"token keyword\">return</span> data</span><br><span class=\"highlight-line\"></span><br><span class=\"highlight-line\"></span><br><span class=\"highlight-line\"><span class=\"token keyword\">def</span> <span class=\"token function\">_read_dhall_file</span><span class=\"token punctuation\">(</span>filename<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></span><br><span class=\"highlight-line\">\t<span class=\"token keyword\">with</span> <span class=\"token builtin\">open</span><span class=\"token punctuation\">(</span>filename<span class=\"token punctuation\">,</span> <span class=\"token string\">\"r\"</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> f<span class=\"token punctuation\">:</span></span><br><span class=\"highlight-line\">\t\tctn <span class=\"token operator\">=</span> f<span class=\"token punctuation\">.</span>read<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></span><br><span class=\"highlight-line\">\t\t<span class=\"token builtin\">vars</span> <span class=\"token operator\">=</span> dhall<span class=\"token punctuation\">.</span>loads<span class=\"token punctuation\">(</span>ctn<span class=\"token punctuation\">)</span></span><br><span class=\"highlight-line\">\t<span class=\"token keyword\">return</span> <span class=\"token builtin\">vars</span></span></code></pre>\n<h2 id=\"execution\">Execution <a class=\"direct-link\" href=\"#execution\">#</a></h2>\n<p>Vars plugins are invoked at 2 stages:</p>\n<ol>\n<li>Inventory : upon initial inventory parsing</li>\n</ol>\n<ul>\n<li>once for every group (including &quot;all&quot; and &quot;ungrouped&quot;)</li>\n<li>once for every host</li>\n</ul>\n<ol>\n<li>Task : every task</li>\n</ol>\n<ul>\n<li>once per cartesian product of:\n<ul>\n<li>entity: hostname or group involved in the play</li>\n<li>path:\n<ul>\n<li>each inventory source path</li>\n<li>the basedir for the play (or the nested play)</li>\n</ul>\n</li>\n</ul>\n</li>\n</ul>\n<p>This can be specified with the option specified in the documentation.</p>\n<p>This is why you want your plugin to implement a load phase and some form of caching!</p>\n",
      "date_published": "2021-03-10T00:00:00+00:00"
    },{
      "id": "https://lilatomic.ca/posts/eleventy_include_code_verbatim/",
      "url": "https://lilatomic.ca/posts/eleventy_include_code_verbatim/",
      "title": "Eleventy Include Code File Verbatim",
      "content_html": "<h1 id=\"eleventy-include-code-file-verbatim\">Eleventy Include Code File Verbatim <a class=\"direct-link\" href=\"#eleventy-include-code-file-verbatim\">#</a></h1>\n<p>I didn't find what I needed, so I wrote it. It was pretty simple. In your &quot;.eleventy.js&quot; file, somewhere in the big <code>module.exports</code> function, add this little snippet:</p>\n<pre class=\"language-js\"><code class=\"language-js\"><span class=\"highlight-line\"><span class=\"token keyword\">const</span> resource_path <span class=\"token operator\">=</span> <span class=\"token string\">\"_includes/resources/\"</span><span class=\"token punctuation\">;</span></span><br><span class=\"highlight-line\">eleventyConfig<span class=\"token punctuation\">.</span><span class=\"token function\">addShortcode</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"include_raw\"</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">path</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span></span><br><span class=\"highlight-line\">\t<span class=\"token keyword\">return</span> fs<span class=\"token punctuation\">.</span><span class=\"token function\">readFileSync</span><span class=\"token punctuation\">(</span>resource_path <span class=\"token operator\">+</span> path<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span><br><span class=\"highlight-line\"><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span></code></pre>\n<p>Then just toss your files into something in the <code>resource_path</code> folder and reference them from your code like so:</p>\n<pre class=\"language-jinja2\"><code class=\"language-jinja2\"><span class=\"highlight-line\">\t```python</span><br><span class=\"highlight-line\">\t<span class=\"token jinja2 language-jinja2\"><span class=\"token delimiter punctuation\">{%</span> <span class=\"token tag keyword\">include_raw</span> <span class=\"token string\">\"ansible_plugins/filter/filter_as_function.py\"</span> <span class=\"token delimiter punctuation\">%}</span></span></span><br><span class=\"highlight-line\">\t```</span></code></pre>\n",
      "date_published": "2021-02-24T00:00:00+00:00"
    },{
      "id": "https://lilatomic.ca/posts/ansible_writing_filter_plugin/",
      "url": "https://lilatomic.ca/posts/ansible_writing_filter_plugin/",
      "title": "Writing a Filter Plugin in Ansible",
      "content_html": "<h1 id=\"writing-a-filter-plugin-in-ansible\">Writing a Filter Plugin in Ansible <a class=\"direct-link\" href=\"#writing-a-filter-plugin-in-ansible\">#</a></h1>\n<p>You might find that you're doing the same kind of data-munging in multiple places. There are many cases where you'd want to pull this into a little named package:</p>\n<ul>\n<li>It requires logic which can't be expressed simply in basic jinja filters</li>\n<li>It's common and used in many places, so there's lots of duplication</li>\n<li>It's uncommon and you can never remember the requirements</li>\n<li>It's actually complicated</li>\n<li>You just want to name what these 3 filters do together</li>\n</ul>\n<h2 id=\"basic-outline\">Basic outline <a class=\"direct-link\" href=\"#basic-outline\">#</a></h2>\n<p>The basic outline of a plugin is as follows:</p>\n<pre class=\"language-python\"><code class=\"language-python\"><span class=\"highlight-line\"><span class=\"token keyword\">import</span> re</span><br><span class=\"highlight-line\"></span><br><span class=\"highlight-line\"></span><br><span class=\"highlight-line\"><span class=\"token keyword\">def</span> <span class=\"token function\">storage_account</span><span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>  <span class=\"token comment\"># 3</span></span><br><span class=\"highlight-line\">\t<span class=\"token keyword\">return</span> re<span class=\"token punctuation\">.</span>sub<span class=\"token punctuation\">(</span><span class=\"token string\">\"[^a-z0-9]\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"\"</span><span class=\"token punctuation\">,</span> name<span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">:</span><span class=\"token number\">24</span><span class=\"token punctuation\">]</span></span><br><span class=\"highlight-line\"></span><br><span class=\"highlight-line\"></span><br><span class=\"highlight-line\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">FilterModule</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">object</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>  <span class=\"token comment\"># 1</span></span><br><span class=\"highlight-line\">\t<span class=\"token keyword\">def</span> <span class=\"token function\">filters</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>  <span class=\"token comment\"># 2</span></span><br><span class=\"highlight-line\">\t\t<span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span><span class=\"token string\">\"storage_account\"</span><span class=\"token punctuation\">:</span> storage_account<span class=\"token punctuation\">}</span>  <span class=\"token comment\"># 4</span></span><br><span class=\"highlight-line\"></span></code></pre>\n<ol>\n<li>Create a class FilterModule</li>\n<li>Create a function <code>filters</code></li>\n<li>Define your function</li>\n<li>Return a dict with k-vs of <code>filter_name:function_reference</code></li>\n</ol>\n<h2 id=\"documenting-your-plugin\">Documenting your plugin <a class=\"direct-link\" href=\"#documenting-your-plugin\">#</a></h2>\n<p>If you want your documentation to work with the Ansible tooling (showing up nicely in the docs, working with <code>ansible-doc</code>), you can't use the standard ansible documentation, since Filter plugins don't show up as an option you can select documentation for. Go figure. You can still try to use the standard documentation features, though.</p>\n<p>You can include only the sections of the documentation that you want to appear. Here's the <a href=\"https://docs.ansible.com/ansible/2.10/dev_guide/developing_modules_documenting.html\">full referece</a> for the version this article was written to. For convenience, here they are:</p>\n<ul>\n<li>Shebang &amp; encoding</li>\n<li>Copyright</li>\n<li>DOCUMENTATION (includes module parameters)</li>\n<li>EXAMPLES</li>\n<li>RETURN</li>\n</ul>\n<p>These have to be python strings which contain the YAML. This makes it kinda gross to work on, since you have no YAML syntax highlighting to help you. Here's a stub python file (feel free to change the license line):</p>\n<pre class=\"language-python\"><code class=\"language-python\"><span class=\"highlight-line\"><span class=\"token comment\">#!/usr/bin/python</span></span><br><span class=\"highlight-line\"><span class=\"token comment\"># -*- coding: utf-8 -*-</span></span><br><span class=\"highlight-line\"></span><br><span class=\"highlight-line\"><span class=\"token comment\"># Copyright: (c) {{ year }}, {{ Your Name }} &lt;{{ your email }}></span></span><br><span class=\"highlight-line\"><span class=\"token comment\"># GNU Affero General Public License v3.0+ (see COPYING or https://www.gnu.org/licenses/agpl-3.0.txt)</span></span><br><span class=\"highlight-line\"></span><br>DOCUMENTATION <span class=\"token operator\">=</span> <span class=\"token triple-quoted-string string\">r\"\"\"<br><span class=\"highlight-line\">module:</span><br><span class=\"highlight-line\">short_description:</span><br><span class=\"highlight-line\">description:</span><br><span class=\"highlight-line\">  -</span><br><span class=\"highlight-line\">version_added: \"0.1.0\"</span><br><span class=\"highlight-line\">options:</span><br>\"\"\"</span><br><span class=\"highlight-line\"></span><br>EXAMPLES <span class=\"token operator\">=</span> <span class=\"token triple-quoted-string string\">r\"\"\"<br>\"\"\"</span><br><span class=\"highlight-line\"></span><br>RETURN <span class=\"token operator\">=</span> <span class=\"token triple-quoted-string string\">r\"\"\"<br><span class=\"highlight-line\">{{ key }}:</span><br><span class=\"highlight-line\">  desctiption:</span><br><span class=\"highlight-line\">  returned:</span><br><span class=\"highlight-line\">  type:</span><br><span class=\"highlight-line\">  sample:</span><br>\"\"\"</span></code></pre>\n<h2 id=\"common-things-you'd-want-to-do\">Common things you'd want to do <a class=\"direct-link\" href=\"#common-things-you'd-want-to-do\">#</a></h2>\n<h3 id=\"using-an-existing-filter\">Using an existing filter <a class=\"direct-link\" href=\"#using-an-existing-filter\">#</a></h3>\n<p>If you want to use an existing filter pluging (perhaps to format your output), you can just import them from the Ansible package:</p>\n<pre class=\"language-python\"><code class=\"language-python\"><span class=\"highlight-line\"><span class=\"token keyword\">from</span> ansible<span class=\"token punctuation\">.</span>plugins<span class=\"token punctuation\">.</span><span class=\"token builtin\">filter</span><span class=\"token punctuation\">.</span>core <span class=\"token keyword\">import</span> to_json<span class=\"token punctuation\">,</span> quote</span></code></pre>\n<h3 id=\"including-other-parameters-in-your-filter\">Including other parameters in your filter <a class=\"direct-link\" href=\"#including-other-parameters-in-your-filter\">#</a></h3>\n<p>If you want to have other parameters in your filter, you can just do that</p>\n<pre class=\"language-python\"><code class=\"language-python\"><span class=\"highlight-line\"><span class=\"token keyword\">from</span> ipaddress <span class=\"token keyword\">import</span> ip_network</span><br><span class=\"highlight-line\"></span><br><span class=\"highlight-line\"></span><br><span class=\"highlight-line\"><span class=\"token keyword\">def</span> <span class=\"token function\">ip_in_snet</span><span class=\"token punctuation\">(</span>snet<span class=\"token punctuation\">,</span> ip<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></span><br><span class=\"highlight-line\">\t_snet <span class=\"token operator\">=</span> ip_network<span class=\"token punctuation\">(</span>snet<span class=\"token punctuation\">)</span></span><br><span class=\"highlight-line\">\t_ip <span class=\"token operator\">=</span> <span class=\"token builtin\">int</span><span class=\"token punctuation\">(</span>ip<span class=\"token punctuation\">)</span></span><br><span class=\"highlight-line\">\t<span class=\"token keyword\">return</span> _snet<span class=\"token punctuation\">[</span>_ip<span class=\"token punctuation\">]</span></span><br><span class=\"highlight-line\"></span><br><span class=\"highlight-line\"></span><br><span class=\"highlight-line\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">FilterModule</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">object</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></span><br><span class=\"highlight-line\">\t<span class=\"token keyword\">def</span> <span class=\"token function\">filters</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></span><br><span class=\"highlight-line\">\t\t<span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span><span class=\"token string\">\"ip_in_snet\"</span><span class=\"token punctuation\">:</span> ip_in_snet<span class=\"token punctuation\">}</span></span></code></pre>\n<p>and then use that like you'd expect, more or less</p>\n<pre class=\"language-python\"><code class=\"language-python\"><span class=\"highlight-line\"> <span class=\"token string\">\"{{ '10.0.1.0/24' | ip_in_snet(10) }}\"</span> </span></code></pre>\n<h3 id=\"building-an-extractor\">Building an extractor <a class=\"direct-link\" href=\"#building-an-extractor\">#</a></h3>\n<p>Sometimes you can't remember the sequence of keys you need to extract that thing you want from the huge JSON blob. You can write a simple extractor:</p>\n<pre class=\"language-python\"><code class=\"language-python\">DOCUMENTATION <span class=\"token operator\">=</span> <span class=\"token triple-quoted-string string\">r\"\"\"<br><span class=\"highlight-line\">name: extract_connectionstring</span><br><span class=\"highlight-line\">short_description: extracts the connection stirng from azure_rm_storageaccount_info</span><br><span class=\"highlight-line\">description:</span><br><span class=\"highlight-line\">  - extracts the connection stirng from M(azure_rm_storageaccount_info)</span><br><span class=\"highlight-line\">  - make sure to use the option C(show_connection_string: true) on the M(azure_rm_storageaccount_info) invocation</span><br><span class=\"highlight-line\">options:</span><br><span class=\"highlight-line\">  rm_info:</span><br><span class=\"highlight-line\">  description: </span><br><span class=\"highlight-line\">    - The result of azure_rm_storageaccount_info</span><br><span class=\"highlight-line\">  type: object</span><br><span class=\"highlight-line\">  required: True</span><br><span class=\"highlight-line\">  endpoint:</span><br><span class=\"highlight-line\">  description:</span><br><span class=\"highlight-line\">    - The storageaccount endpoint to get the connectionstring for</span><br><span class=\"highlight-line\">    - if blank, will fetch for blob</span><br><span class=\"highlight-line\">    - use \"key\" to get the key itself</span><br><span class=\"highlight-line\">  choices: [\"blob\", \"file\", \"queue\", \"table\", \"key\"]</span><br><span class=\"highlight-line\">  required: False</span><br><span class=\"highlight-line\">    default: blob</span><br>\"\"\"</span><br><span class=\"highlight-line\"></span><br>EXAMPLES <span class=\"token operator\">=</span> <span class=\"token triple-quoted-string string\">r\"\"\"<br><span class=\"highlight-line\">- name: get storageaccount info</span><br><span class=\"highlight-line\">  azure_rm_storageaccount_info:</span><br><span class=\"highlight-line\">    name: \"{{ storage_acount_name }}\"</span><br><span class=\"highlight-line\">    resource_group \"{{ rg }}\"</span><br><span class=\"highlight-line\">    show_connection_string: true # important !</span><br><span class=\"highlight-line\">  register: storageaccount_raw</span><br><span class=\"highlight-line\"></span><br><span class=\"highlight-line\">- name: get blob connection string</span><br><span class=\"highlight-line\">  set_fact:</span><br><span class=\"highlight-line\">    blob_connectionstring: \"{{ storageaccount_raw | extract_connectionstring }}</span><br><span class=\"highlight-line\"></span><br><span class=\"highlight-line\">- name: get connection string for something other than blob</span><br><span class=\"highlight-line\">  set_fact:</span><br><span class=\"highlight-line\">    table_connectionstring: \"{{ storageaccount_raw | extract_connectionstring('table') }}</span><br><span class=\"highlight-line\"></span><br><span class=\"highlight-line\">- name: get account key</span><br><span class=\"highlight-line\">  set_fact:</span><br><span class=\"highlight-line\">    connectionstring: \"{{ storageaccount_raw | extract_connectionstring('key') }}</span><br>\"\"\"</span><br><span class=\"highlight-line\"></span><br><span class=\"highlight-line\"></span><br><span class=\"highlight-line\"><span class=\"token keyword\">def</span> <span class=\"token function\">extract_connectionstring</span><span class=\"token punctuation\">(</span>rm_info<span class=\"token punctuation\">,</span> endpoint<span class=\"token operator\">=</span><span class=\"token string\">\"blob\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></span><br><span class=\"highlight-line\">\t<span class=\"token keyword\">if</span> endpoint <span class=\"token operator\">==</span> <span class=\"token string\">\"key\"</span><span class=\"token punctuation\">:</span></span><br><span class=\"highlight-line\">\t\t<span class=\"token keyword\">return</span> rm_info<span class=\"token punctuation\">[</span><span class=\"token string\">\"storageaccounts\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token string\">\"primary_endpoints\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token string\">\"key\"</span><span class=\"token punctuation\">]</span></span><br><span class=\"highlight-line\">\t<span class=\"token keyword\">else</span><span class=\"token punctuation\">:</span></span><br><span class=\"highlight-line\">\t\t<span class=\"token keyword\">return</span> rm_info<span class=\"token punctuation\">[</span><span class=\"token string\">\"storageaccounts\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token string\">\"primary_endpoints\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span>endpoint<span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span></span><br><span class=\"highlight-line\">\t\t\t<span class=\"token string\">\"connectionstring\"</span></span><br><span class=\"highlight-line\">\t\t<span class=\"token punctuation\">]</span></span><br><span class=\"highlight-line\"></span><br><span class=\"highlight-line\"></span><br><span class=\"highlight-line\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">FilterModule</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">object</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></span><br><span class=\"highlight-line\">\t<span class=\"token keyword\">def</span> <span class=\"token function\">filters</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></span><br><span class=\"highlight-line\">\t\t<span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span><span class=\"token string\">\"extract_connectionstring\"</span><span class=\"token punctuation\">:</span> extract_connectionstring<span class=\"token punctuation\">}</span></span><br><span class=\"highlight-line\"></span></code></pre>\n<h2 id=\"abusing-filters-as-functions\">Abusing filters as functions <a class=\"direct-link\" href=\"#abusing-filters-as-functions\">#</a></h2>\n<p>Let's say that you want to have some functions assemble things, like you would with some proper typed data modelling. I'm not saying this is a <em>good</em> idea, but you can use functions as the closest thing to that (it's not really close). For an example, I always forget the little fiddly bits of assembling an Azure Storageaccount Lifecycle Policy. I could do the following:</p>\n<pre class=\"language-python\"><code class=\"language-python\"><span class=\"highlight-line\"><span class=\"token keyword\">from</span> _includes<span class=\"token punctuation\">.</span>resources<span class=\"token punctuation\">.</span>ansible_plugins<span class=\"token punctuation\">.</span><span class=\"token builtin\">filter</span><span class=\"token punctuation\">.</span>extractor <span class=\"token keyword\">import</span> EXAMPLES</span><br><span class=\"highlight-line\"></span><br><span class=\"highlight-line\"></span><br>EXAMPLES <span class=\"token operator\">=</span> <span class=\"token triple-quoted-string string\">r\"\"\"<br><span class=\"highlight-line\">- name: format lifecycle policy</span><br><span class=\"highlight-line\">  set_fact:</span><br><span class=\"highlight-line\">    autodelete_rule: \"{{ \"autodelete\" | storageaccount_lifecycle_rule(filters, blob_actions) }}</span><br><span class=\"highlight-line\">  vars:</span><br><span class=\"highlight-line\">    blob_actions:</span><br><span class=\"highlight-line\">      - {\"delete\":{\"daysAfterModificationGreaterThan\": 30}}</span><br><span class=\"highlight-line\">    filters:</span><br><span class=\"highlight-line\">      - {\"blobTypes\":[\"blockBlob\"],\"prefixMatch\":[\"my_container\"]}</span><br>\"\"\"</span><br><span class=\"highlight-line\"></span><br><span class=\"highlight-line\"></span><br><span class=\"highlight-line\"><span class=\"token keyword\">from</span> typing <span class=\"token keyword\">import</span> Dict</span><br><span class=\"highlight-line\"></span><br><span class=\"highlight-line\"></span><br><span class=\"highlight-line\"><span class=\"token keyword\">def</span> <span class=\"token function\">rule</span><span class=\"token punctuation\">(</span></span><br><span class=\"highlight-line\">\tname<span class=\"token punctuation\">,</span></span><br><span class=\"highlight-line\">\tfilters<span class=\"token punctuation\">,</span></span><br><span class=\"highlight-line\">\tactions_blob<span class=\"token punctuation\">:</span> Dict<span class=\"token punctuation\">[</span><span class=\"token builtin\">str</span><span class=\"token punctuation\">,</span> Dict<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token boolean\">None</span><span class=\"token punctuation\">,</span></span><br><span class=\"highlight-line\">\tactions_version<span class=\"token punctuation\">:</span> Dict<span class=\"token punctuation\">[</span><span class=\"token builtin\">str</span><span class=\"token punctuation\">,</span> Dict<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token boolean\">None</span><span class=\"token punctuation\">,</span></span><br><span class=\"highlight-line\"><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></span><br><span class=\"highlight-line\">\t<span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span></span><br><span class=\"highlight-line\">\t\t<span class=\"token string\">\"enabled\"</span><span class=\"token punctuation\">:</span> <span class=\"token boolean\">True</span><span class=\"token punctuation\">,</span></span><br><span class=\"highlight-line\">\t\t<span class=\"token string\">\"name\"</span><span class=\"token punctuation\">:</span> <span class=\"token builtin\">str</span><span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></span><br><span class=\"highlight-line\">\t\t<span class=\"token string\">\"type\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"Lifecycle\"</span><span class=\"token punctuation\">,</span></span><br><span class=\"highlight-line\">\t\t<span class=\"token string\">\"definitions\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span></span><br><span class=\"highlight-line\">\t\t\t<span class=\"token string\">\"actions\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span><span class=\"token string\">\"baseBlob\"</span><span class=\"token punctuation\">:</span> actions_blob<span class=\"token punctuation\">,</span> <span class=\"token string\">\"versions\"</span><span class=\"token punctuation\">:</span> actions_version<span class=\"token punctuation\">,</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span></span><br><span class=\"highlight-line\">\t\t\t<span class=\"token string\">\"filters\"</span><span class=\"token punctuation\">:</span> filters<span class=\"token punctuation\">,</span></span><br><span class=\"highlight-line\">\t\t<span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span></span><br><span class=\"highlight-line\">\t<span class=\"token punctuation\">}</span></span><br><span class=\"highlight-line\"></span><br><span class=\"highlight-line\"></span><br><span class=\"highlight-line\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">FilterModule</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">object</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></span><br><span class=\"highlight-line\">\t<span class=\"token keyword\">def</span> <span class=\"token function\">filters</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></span><br><span class=\"highlight-line\">\t\t<span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span><span class=\"token string\">\"storageaccount_lifecycle_rule\"</span><span class=\"token punctuation\">:</span> rule<span class=\"token punctuation\">}</span></span><br><span class=\"highlight-line\"></span></code></pre>\n<p>And yes, you can also build filters to construct those <code>filters</code> and <code>blob_actions</code>, and make a terrible filter chain. But maybe don't and just write a one-off plugin.</p>\n",
      "date_published": "2021-02-24T00:00:00+00:00"
    },{
      "id": "https://lilatomic.ca/posts/ansible_writing_action_plugin/",
      "url": "https://lilatomic.ca/posts/ansible_writing_action_plugin/",
      "title": "Writing an Action Plugin in Ansible",
      "content_html": "<h1 id=\"writing-an-action-plugin-in-ansible\">Writing an Action Plugin in Ansible <a class=\"direct-link\" href=\"#writing-an-action-plugin-in-ansible\">#</a></h1>\n<p>It's common to want to wrap up a task in Ansible into a reusable unit. This is especially common with common shell commands. Ansible has a few ways to do that.</p>\n<ol>\n<li>Including a task list</li>\n<li>Module plugin</li>\n<li>Action plugin</li>\n</ol>\n<p>Including a task list is the most straightforward: just have an <code>import_tasks</code> directive. You can set variables for that task with an attached <code>vars</code> attribute. There are several downsides to this method. The most obvious is that there isn't a good way of distributing task lists, either with Ansible-Galaxy or without it. Another downside is that there is a lack of documentation. Yet another is that it can be complicated to provide some basic defaults, formatting, validation, and debugging.</p>\n<p>Ansible Module plugins might sound like the right thing, especially since the Ansible documentation says that if you use the <code>command</code> module a lot you might want to write one of these. When you look into the documentation, the difference between these and an Action plugin becomes murky. The capabilities of each aren't clearly outlined, despite them being practically welded to each other. You may also find documentation which says that when resolving what action to take from a task in a playbook, Ansible will first look for a match for the task action in the Action plugins and, if one isn't found, in the Modules.</p>\n<p>The short distinction is that Modules are the code which will get uploaded to the target machine and then launched, and Action modules run on the controller. Action plugins have access to useful Ansible function, like <code>_execute_module</code>, which allows you to wrap an existing directive (or launch a specially-built <code>command</code>). Note that these executed modules function like you'd expect: on the remote machine.</p>\n<p>So, most likely, you'll want to use an Action plugin.</p>\n<h2 id=\"basic-outline\">Basic outline <a class=\"direct-link\" href=\"#basic-outline\">#</a></h2>\n<p>The basic outline of a plugin is as follows:</p>\n<pre class=\"language-python\"><code class=\"language-python\"><span class=\"highlight-line\"><span class=\"token keyword\">from</span> ansible<span class=\"token punctuation\">.</span>plugins<span class=\"token punctuation\">.</span>action <span class=\"token keyword\">import</span> ActionBase  <span class=\"token comment\"># 1</span></span><br><span class=\"highlight-line\"></span><br><span class=\"highlight-line\"></span><br><span class=\"highlight-line\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">ActionModule</span><span class=\"token punctuation\">(</span>ActionBase<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>  <span class=\"token comment\"># 2</span></span><br><span class=\"highlight-line\">\t<span class=\"token keyword\">def</span> <span class=\"token function\">run</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> tmp<span class=\"token operator\">=</span><span class=\"token boolean\">None</span><span class=\"token punctuation\">,</span> task_vars<span class=\"token operator\">=</span><span class=\"token boolean\">None</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>  <span class=\"token comment\"># 3</span></span><br><span class=\"highlight-line\">\t\t<span class=\"token builtin\">super</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>run<span class=\"token punctuation\">(</span>tmp<span class=\"token operator\">=</span>tmp<span class=\"token punctuation\">,</span> task_vars<span class=\"token operator\">=</span>task_vars<span class=\"token punctuation\">)</span>  <span class=\"token comment\"># 4</span></span><br><span class=\"highlight-line\">\t\t<span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>  <span class=\"token comment\"># 5</span></span><br><span class=\"highlight-line\"></span></code></pre>\n<ol>\n<li>Import the plugin base</li>\n<li>Create a class called ActionModule. To name the plugin, put it in a file with that name.</li>\n<li>Make the <code>run</code> method</li>\n<li>Invoke the <code>super().run</code> method</li>\n<li>Return results as a dict</li>\n</ol>\n<h2 id=\"documenting-your-plugin\">Documenting your plugin <a class=\"direct-link\" href=\"#documenting-your-plugin\">#</a></h2>\n<p>If you want your documentation to work with the Ansible tooling (showing up nicely in the docs, working with <code>ansible-doc</code>), you have to create an Ansible Module for that as well. The module can contain only documentation.</p>\n<p>You can include only the sections of the documentation that you want to appear. Here's the <a href=\"https://docs.ansible.com/ansible/2.10/dev_guide/developing_modules_documenting.html\">full referece</a> for the version this article was written to. For convenience, here they are:</p>\n<ul>\n<li>Shebang &amp; encoding</li>\n<li>Copyright</li>\n<li>DOCUMENTATION (includes module parameters)</li>\n<li>EXAMPLES</li>\n<li>RETURN</li>\n</ul>\n<p>These have to be python strings which contain the YAML. This makes it kinda gross to work on, since you have no YAML syntax highlighting to help you. Here's a stub python file (feel free to change the license line):</p>\n<pre class=\"language-python\"><code class=\"language-python\"><span class=\"highlight-line\"><span class=\"token comment\">#!/usr/bin/python</span></span><br><span class=\"highlight-line\"><span class=\"token comment\"># -*- coding: utf-8 -*-</span></span><br><span class=\"highlight-line\"></span><br><span class=\"highlight-line\"><span class=\"token comment\"># Copyright: (c) ,  &lt;></span></span><br><span class=\"highlight-line\"><span class=\"token comment\"># GNU Affero General Public License v3.0+ (see COPYING or https://www.gnu.org/licenses/agpl-3.0.txt)</span></span><br><span class=\"highlight-line\"></span><br>DOCUMENTATION <span class=\"token operator\">=</span> <span class=\"token triple-quoted-string string\">r\"\"\"<br><span class=\"highlight-line\">module:</span><br><span class=\"highlight-line\">short_description:</span><br><span class=\"highlight-line\">description:</span><br><span class=\"highlight-line\">  -</span><br><span class=\"highlight-line\">version_added: \"0.1.0\"</span><br><span class=\"highlight-line\">options:</span><br>\"\"\"</span><br><span class=\"highlight-line\"></span><br>EXAMPLES <span class=\"token operator\">=</span> <span class=\"token triple-quoted-string string\">r\"\"\"<br>\"\"\"</span><br><span class=\"highlight-line\"></span><br>RETURN <span class=\"token operator\">=</span> <span class=\"token triple-quoted-string string\">r\"\"\"<br><span class=\"highlight-line\">:</span><br><span class=\"highlight-line\">  desctiption:</span><br><span class=\"highlight-line\">  returned:</span><br><span class=\"highlight-line\">  type:</span><br><span class=\"highlight-line\">  sample:</span><br>\"\"\"</span></code></pre>\n<h2 id=\"common-things-you'd-want-to-do\">Common things you'd want to do <a class=\"direct-link\" href=\"#common-things-you'd-want-to-do\">#</a></h2>\n<h3 id=\"run-another-module%2Faction-plugin\">Run another module/action plugin <a class=\"direct-link\" href=\"#run-another-module%2Faction-plugin\">#</a></h3>\n<p>Inside of your <code>run</code> method:</p>\n<pre class=\"language-python\"><code class=\"language-python\"><span class=\"highlight-line\">module_name <span class=\"token operator\">=</span> <span class=\"token string\">\"???\"</span></span><br><span class=\"highlight-line\">module_args<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span><span class=\"token string\">\"???\"</span><span class=\"token punctuation\">:</span><span class=\"token string\">\"???\"</span><span class=\"token punctuation\">}</span></span><br><span class=\"highlight-line\"></span><br><span class=\"highlight-line\">result <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span>_execute_module<span class=\"token punctuation\">(</span> <span class=\"token comment\">#1</span></span><br><span class=\"highlight-line\">\tmodule_name<span class=\"token operator\">=</span>module_name<span class=\"token punctuation\">,</span></span><br><span class=\"highlight-line\">\tmodule_args<span class=\"token operator\">=</span>module_args<span class=\"token punctuation\">,</span></span><br><span class=\"highlight-line\">\ttask_vars<span class=\"token operator\">=</span>task_vars<span class=\"token punctuation\">,</span> <span class=\"token comment\">#2</span></span><br><span class=\"highlight-line\">\t<span class=\"token comment\">#3</span></span><br><span class=\"highlight-line\"><span class=\"token punctuation\">)</span></span></code></pre>\n<ol>\n<li>use the <code>self._execute_module</code> method</li>\n<li>generally pass these forward, don't forget to provide them</li>\n<li>tmp no longer has any effect, if the comments are to be believed, so we don't need to forward it.</li>\n</ol>\n<h3 id=\"run-a-freeform-command\">Run a freeform command <a class=\"direct-link\" href=\"#run-a-freeform-command\">#</a></h3>\n<p>If you just want to wrap a task like</p>\n<pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"highlight-line\"><span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Run thing</span><br><span class=\"highlight-line\">  <span class=\"token key atrule\">command</span><span class=\"token punctuation\">:</span></span><br><span class=\"highlight-line\">    <span class=\"token key atrule\">cmd</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"Some freeform text\"</span></span></code></pre>\n<p>You will need to provide the <code>cmd</code> arg as the value of &quot;_raw_params&quot; to the module_args.</p>\n<pre class=\"language-python\"><code class=\"language-python\"><span class=\"highlight-line\">cmd<span class=\"token operator\">=</span><span class=\"token string\">\"ls -la\"</span></span><br><span class=\"highlight-line\"></span><br><span class=\"highlight-line\">result <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span>_execute_module<span class=\"token punctuation\">(</span></span><br><span class=\"highlight-line\">\tmodule_name<span class=\"token operator\">=</span>module_name<span class=\"token punctuation\">,</span></span><br><span class=\"highlight-line\">\tmodule_args<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span><span class=\"token string\">\"_raw_params\"</span><span class=\"token punctuation\">:</span> cmd<span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span></span><br><span class=\"highlight-line\">\ttask_vars<span class=\"token operator\">=</span>task_vars<span class=\"token punctuation\">,</span></span><br><span class=\"highlight-line\">\ttmp<span class=\"token operator\">=</span>tmp</span><br><span class=\"highlight-line\"><span class=\"token punctuation\">)</span></span></code></pre>\n<h3 id=\"adding-a-fact\">Adding a fact <a class=\"direct-link\" href=\"#adding-a-fact\">#</a></h3>\n<p>Ansible wants you to use a Fact plugin for these, but sometimes a fact only makes sense mid-playbook. Simply set the &quot;ansible_facts&quot; key with a dictionary of the facts you want to add:</p>\n<pre class=\"language-python\"><code class=\"language-python\"><span class=\"highlight-line\"><span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span><span class=\"token string\">\"ansible_facts\"</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">{</span><span class=\"token string\">\"FACT\"</span><span class=\"token punctuation\">:</span><span class=\"token number\">1</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span></span></code></pre>\n<h3 id=\"using-an-existing-filter\">Using an existing filter <a class=\"direct-link\" href=\"#using-an-existing-filter\">#</a></h3>\n<p>If you want to use an existing filter pluging (perhaps to format your output), you can just import them from the Ansible package:</p>\n<pre class=\"language-python\"><code class=\"language-python\"><span class=\"highlight-line\"><span class=\"token keyword\">from</span> ansible<span class=\"token punctuation\">.</span>plugins<span class=\"token punctuation\">.</span><span class=\"token builtin\">filter</span><span class=\"token punctuation\">.</span>core <span class=\"token keyword\">import</span> to_json<span class=\"token punctuation\">,</span> quote</span></code></pre>\n",
      "date_published": "2021-02-22T00:00:00+00:00"
    },{
      "id": "https://lilatomic.ca/posts/microstack/",
      "url": "https://lilatomic.ca/posts/microstack/",
      "title": "SSL with Microstack",
      "content_html": "<h1 id=\"ssl-with-microstack\">SSL with Microstack <a class=\"direct-link\" href=\"#ssl-with-microstack\">#</a></h1>\n<h2 id=\"setting-up-https-on-horizon-(the-dashboard)\">Setting up HTTPS on Horizon (the dashboard) <a class=\"direct-link\" href=\"#setting-up-https-on-horizon-(the-dashboard)\">#</a></h2>\n<p>Let's follow the docs <a href=\"https://docs.openstack.org/horizon/latest/admin/customize-configure.html#configure-dashboard\">here</a></p>\n<p>The config files for microstack are all in the snap directory, so look in <code>/var/snap/microstack/common/etc</code>. We want to change the hostname by replacing the relevant lines:</p>\n<p>:/common/etc/local_settings.d/_05_snap_tweaks.py</p>\n<pre class=\"language-python\"><code class=\"language-python\"><span class=\"highlight-line\">OPENSTACK_HOST <span class=\"token operator\">=</span> <span class=\"token string\">\"\"</span></span><br><span class=\"highlight-line\">ALLOWED_HOSTS <span class=\"token operator\">=</span> <span class=\"token string\">\"\"</span></span></code></pre>\n<h2 id=\"ssl-cert\">SSL Cert <a class=\"direct-link\" href=\"#ssl-cert\">#</a></h2>\n<p>I tossed my cert and key into :/common/etc/ssl/private . Make sure to give it appropriate permissions</p>\n<h2 id=\"nginx\">Nginx <a class=\"direct-link\" href=\"#nginx\">#</a></h2>\n<p>The config for horizon lives in :/common/etc/nginx/snap/sites-enabled/horizon.conf . I replaced the <code>listen</code> directive, gave it a <code>server_name</code>, and added the <code>ssl_certificate</code> and <code>ssl_certificate_key</code>. I found that giving the absolute path to the SSL folder worked. That gives us:</p>\n<pre class=\"language-nginx\"><code class=\"language-nginx\"><span class=\"highlight-line\"><span class=\"token keyword\">server</span> <span class=\"token punctuation\">{</span></span><br><span class=\"highlight-line\">\t<span class=\"token keyword\">listen</span> <span class=\"token number\">443</span> <span class=\"token keyword\">ssl</span><span class=\"token punctuation\">;</span></span><br><span class=\"highlight-line\">\t<span class=\"token keyword\">server_name</span> alpacloud<span class=\"token punctuation\">.</span>lilatomic<span class=\"token punctuation\">.</span>ca<span class=\"token punctuation\">;</span></span><br><span class=\"highlight-line\"></span><br><span class=\"highlight-line\">\t<span class=\"token keyword\">ssl_certificate</span> <span class=\"token operator\">/</span>var<span class=\"token operator\">/</span>snap<span class=\"token operator\">/</span>microstack<span class=\"token operator\">/</span>common<span class=\"token operator\">/</span>etc<span class=\"token operator\">/</span><span class=\"token keyword\">ssl</span><span class=\"token operator\">/</span>private<span class=\"token operator\">/</span>certificate<span class=\"token punctuation\">.</span>pem<span class=\"token punctuation\">;</span></span><br><span class=\"highlight-line\">\t<span class=\"token keyword\">ssl_certificate_key</span> <span class=\"token operator\">/</span>var<span class=\"token operator\">/</span>snap<span class=\"token operator\">/</span>microstack<span class=\"token operator\">/</span>common<span class=\"token operator\">/</span>etc<span class=\"token operator\">/</span><span class=\"token keyword\">ssl</span><span class=\"token operator\">/</span>private<span class=\"token operator\">/</span>private<span class=\"token operator\">-</span>key<span class=\"token punctuation\">.</span>pem<span class=\"token punctuation\">;</span></span><br><span class=\"highlight-line\"></span><br><span class=\"highlight-line\">\t<span class=\"token keyword\">client_max_body_size</span> <span class=\"token number\">16</span>G<span class=\"token punctuation\">;</span></span><br><span class=\"highlight-line\"></span><br><span class=\"highlight-line\">\t<span class=\"token keyword\">error_log</span> syslog<span class=\"token punctuation\">:</span><span class=\"token keyword\">server</span><span class=\"token operator\">=</span>unix<span class=\"token punctuation\">:</span><span class=\"token operator\">/</span>dev<span class=\"token operator\">/</span>log<span class=\"token punctuation\">;</span></span><br><span class=\"highlight-line\">\t<span class=\"token keyword\">access_log</span> syslog<span class=\"token punctuation\">:</span><span class=\"token keyword\">server</span><span class=\"token operator\">=</span>unix<span class=\"token punctuation\">:</span><span class=\"token operator\">/</span>dev<span class=\"token operator\">/</span>log<span class=\"token punctuation\">;</span></span><br><span class=\"highlight-line\">\t<span class=\"token keyword\">location</span> <span class=\"token operator\">/</span> <span class=\"token punctuation\">{</span></span><br><span class=\"highlight-line\">\t\t<span class=\"token keyword\">include</span> <span class=\"token operator\">/</span>snap<span class=\"token operator\">/</span>microstack<span class=\"token operator\">/</span><span class=\"token number\">222</span><span class=\"token operator\">/</span>usr<span class=\"token operator\">/</span>conf<span class=\"token operator\">/</span>uwsgi_params<span class=\"token punctuation\">;</span></span><br><span class=\"highlight-line\">\t\tuwsgi_param SCRIPT_NAME <span class=\"token string\">''</span><span class=\"token punctuation\">;</span></span><br><span class=\"highlight-line\">\t\tuwsgi_pass unix<span class=\"token punctuation\">:</span><span class=\"token operator\">/</span><span class=\"token operator\">/</span><span class=\"token operator\">/</span>var<span class=\"token operator\">/</span>snap<span class=\"token operator\">/</span>microstack<span class=\"token operator\">/</span>common<span class=\"token operator\">/</span>run<span class=\"token operator\">/</span>horizon<span class=\"token punctuation\">.</span>sock<span class=\"token punctuation\">;</span></span><br><span class=\"highlight-line\">\t<span class=\"token punctuation\">}</span></span><br><span class=\"highlight-line\"><span class=\"token punctuation\">}</span></span><br><span class=\"highlight-line\"></span></code></pre>\n",
      "date_published": "2021-02-17T00:00:00+00:00"
    },{
      "id": "https://lilatomic.ca/posts/changing_password_on_kartoza_osm/",
      "url": "https://lilatomic.ca/posts/changing_password_on_kartoza_osm/",
      "title": "Changing the password on kartoza/docker-osm",
      "content_html": "<p>Default credentials are not acceptable. <a href=\"https://owasp.org/www-project-web-security-testing-guide/latest/4-Web_Application_Security_Testing/04-Authentication_Testing/02-Testing_for_Default_Credentials\">OWASP link</a></p>\n<p>I made my changes on commit <a href=\"https://github.com/kartoza/docker-osm/commit/90735fae170a18bb1c288c0503cf9905561c973d\">90735fae170a18bb1c288c0503cf9905561c973d</a>.</p>\n<p>There are several places the username and password must be changed:</p>\n<ol>\n<li>Docker compose:\n<ol>\n<li>services.db.environment.POSTGRES_USER</li>\n<li>services.db.environment.POSTGRES_PASS</li>\n<li>services.db.environment.POSTGRES_DBNAME</li>\n<li>services.imposm.environment.POSTGRES_USER</li>\n<li>services.imposm.environment.POSTGRES_PASS</li>\n<li>services.imposm.environment.POSTGRES_DBNAME</li>\n<li>services.osmenrich.environment.POSTGRES_USER</li>\n<li>services.osmenrich.environment.POSTGRES_PASS</li>\n<li>services.osmenrich.environment.POSTGRES_DBNAME</li>\n</ol>\n</li>\n<li>settings/qgis_style.sql\n<ol>\n<li>l40 change OWNER</li>\n<li>l54 change OWNER</li>\n<li>l814 change docker to osm</li>\n<li>l1589 change docker to osm</li>\n<li>l1860 change docker to osm</li>\n<li>l2154 change docker to osm</li>\n<li>l2423 change docker to osm</li>\n<li>l3027 change docker to osm</li>\n<li>l3297 change docker to osm</li>\n</ol>\n</li>\n</ol>\n",
      "date_published": "2021-02-10T00:00:00+00:00"
    },{
      "id": "https://lilatomic.ca/posts/pytest_for_functional_tests/",
      "url": "https://lilatomic.ca/posts/pytest_for_functional_tests/",
      "title": "Using Pytest for Testing Deployments",
      "content_html": "<h1 id=\"using-pytest-for-testing-deployments\">Using Pytest for Testing Deployments <a class=\"direct-link\" href=\"#using-pytest-for-testing-deployments\">#</a></h1>\n<p><a href=\"#full-solution\">Jump to example solution</a></p>\n<h2 id=\"why\">Why <a class=\"direct-link\" href=\"#why\">#</a></h2>\n<p>Functional tests are tests against the whole application, as deployed. And if you're doing stuff in the Cloud :tm:, the Infrastructure is the Application, in many cases. So you <em>should</em> be doing functional tests, to ensure that you are using the <abbr title=\"Software as a Service\">SaaS</abbr> offerings correctly, and you may need to be in order to test the application at all. Also, if you're doing <abbr title=\"Continuous deliivery\">CD</abbr> or if people are deploying/installing your application, you might want to test that process.</p>\n<p>One of the problems with testing deployments is that the process can be fairly lengthy (maybe it needs to spin up a <abbr title=\"Database\">DB</abbr> or <abbr title=\"Kubernetes\">K8s</abbr> cluster). Tests will require the same Deployment step, though might have different setups. For example, you might have an application which can receive events from a messagequeue, a storage account, or from HTTP requests through an API Gateway. You would want to test that it consumes from all 3 sources, and would need to set up those test resources individually; but it's the same application under test.</p>\n<p>This type of setup can be generalised to any sort of batch process. For example, you might be testing infrastructure compliance tooling, where you trigger the &quot;evaluate&quot; function and <em>all</em> resources will be scanned and remediated. Triggering the &quot;evaluate&quot; multiple times is time-prohibitive and unecessary, since each compliance rule will be evaluated individually. Another example would be a service which needs to be submitted to a job processor. It might be impractical to submit individual jobs for every test, because of per-job overhead.</p>\n<h2 id=\"what\">What <a class=\"direct-link\" href=\"#what\">#</a></h2>\n<p>In this situation, we'd like to have:<br>\n1. several tests : It is critical that these tests are independent and look like normal tests. Solutions which will involve collecting a pile of assertions (or worse, asserting them sequentially so you only get the first failure)<br>\n2. with individual setup steps (as stated above, they may have different requirements)<br>\n3. sharing a common setup step (this is the big, time-consuming step)<br>\n4. which occurs after the individual setups (if the setups occur after big deploy step, it is actually pretty easy to do with pytest, since their failure wouldn't count as a failed prerequisite)<br>\n5. which will not be impacted by the failure of any individual test setup (obviously, the failure of the messagequeue input should not impact testing the storage account)</p>\n<h2 id=\"how\">How <a class=\"direct-link\" href=\"#how\">#</a></h2>\n<p>This is my &quot;reasonable&quot; solution to the problem. I walk through each step to explain it. Skip ahead to the <a href=\"#full-solution\">full solution</a></p>\n<ol>\n<li>Several tests : Nothing complicated. The <code>order</code> fixture lets us see the execution order of fixtures. It has a <code>session</code> scope so it lasts accross all of our tests. It also stands in for other common dependencies, like credentials or whatever.</li>\n</ol>\n<pre class=\"language-python\"><code class=\"language-python\"><span class=\"highlight-line\"><span class=\"token keyword\">import</span> pytest</span><br><span class=\"highlight-line\"></span><br><span class=\"highlight-line\"><span class=\"token decorator annotation punctuation\">@pytest<span class=\"token punctuation\">.</span>fixture</span><span class=\"token punctuation\">(</span>scope<span class=\"token operator\">=</span><span class=\"token string\">\"session\"</span><span class=\"token punctuation\">)</span></span><br><span class=\"highlight-line\"><span class=\"token keyword\">def</span> <span class=\"token function\">order</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></span><br><span class=\"highlight-line\">\tx <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span></span><br><span class=\"highlight-line\">\t<span class=\"token keyword\">yield</span> x</span><br><span class=\"highlight-line\">\t<span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span></span><br><span class=\"highlight-line\"></span><br><span class=\"highlight-line\"><span class=\"token keyword\">def</span> <span class=\"token function\">test_0</span><span class=\"token punctuation\">(</span>order<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></span><br><span class=\"highlight-line\">\torder<span class=\"token punctuation\">.</span>append<span class=\"token punctuation\">(</span><span class=\"token string\">\"test_0\"</span><span class=\"token punctuation\">)</span></span><br><span class=\"highlight-line\"><span class=\"token keyword\">def</span> <span class=\"token function\">test_1</span><span class=\"token punctuation\">(</span>order<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></span><br><span class=\"highlight-line\">\torder<span class=\"token punctuation\">.</span>append<span class=\"token punctuation\">(</span><span class=\"token string\">\"test_1\"</span><span class=\"token punctuation\">)</span>\t</span></code></pre>\n<ol start=\"2\">\n<li>With individual fixtures : these are our setup filters. They're straightforward for now, but we'll need to make some modifications to them later. The first thing we'll do is to mark them with a <code>class</code> scope, which will be used to make them run only once. It might not be necessary because of pytest's fun fixture scoping rules, but I just mark them this way since it doesn't really make a difference to me.</li>\n</ol>\n<pre class=\"language-python\"><code class=\"language-python\"><span class=\"highlight-line\"><span class=\"token keyword\">import</span> pytest</span><br><span class=\"highlight-line\"><span class=\"token decorator annotation punctuation\">@pytest<span class=\"token punctuation\">.</span>fixture</span><span class=\"token punctuation\">(</span>scope<span class=\"token operator\">=</span><span class=\"token string\">\"class\"</span><span class=\"token punctuation\">)</span></span><br><span class=\"highlight-line\"><span class=\"token keyword\">def</span> <span class=\"token function\">setup_0</span><span class=\"token punctuation\">(</span>order<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></span><br><span class=\"highlight-line\">\torder<span class=\"token punctuation\">.</span>append<span class=\"token punctuation\">(</span><span class=\"token string\">\"setup_0\"</span><span class=\"token punctuation\">)</span></span><br><span class=\"highlight-line\"></span><br><span class=\"highlight-line\"><span class=\"token decorator annotation punctuation\">@pytest<span class=\"token punctuation\">.</span>fixture</span><span class=\"token punctuation\">(</span>scope<span class=\"token operator\">=</span><span class=\"token string\">\"class\"</span><span class=\"token punctuation\">)</span></span><br><span class=\"highlight-line\"><span class=\"token keyword\">def</span> <span class=\"token function\">setup_1</span><span class=\"token punctuation\">(</span>order<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></span><br><span class=\"highlight-line\">\torder<span class=\"token punctuation\">.</span>append<span class=\"token punctuation\">(</span><span class=\"token string\">\"setup_1\"</span><span class=\"token punctuation\">)</span></span></code></pre>\n<ol start=\"3\">\n<li>Sharing a common setup step : This is our Big Thing. I've taken inspiration from the pytest page for <a href=\"https://docs.pytest.org/en/latest/fixture.html#running-multiple-assert-statements-safely\">running multiple asserts safely</a>. We make a Test Class to hold all the tests which depend on the big setup. This allows us to create the Big Thing as a class-scoped fixture. The important thing about this fixture is that it is <code>autouse</code>, so it will automatically occur before all the tests. This does force us to put all the tests in this class, but that doesn't seem to be a really hard thing to do.</li>\n</ol>\n<pre class=\"language-python\"><code class=\"language-python\"><span class=\"highlight-line\"><span class=\"token keyword\">import</span> pytest</span><br><span class=\"highlight-line\"></span><br><span class=\"highlight-line\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">TestBatch</span><span class=\"token punctuation\">:</span></span><br><span class=\"highlight-line\">\t<span class=\"token decorator annotation punctuation\">@pytest<span class=\"token punctuation\">.</span>fixture</span><span class=\"token punctuation\">(</span>scope<span class=\"token operator\">=</span><span class=\"token string\">\"class\"</span><span class=\"token punctuation\">,</span> autouse<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">)</span></span><br><span class=\"highlight-line\">\t<span class=\"token keyword\">def</span> <span class=\"token function\">deploy</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> order<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></span><br><span class=\"highlight-line\">\t\torder<span class=\"token punctuation\">.</span>append<span class=\"token punctuation\">(</span><span class=\"token string\">\"deploy\"</span><span class=\"token punctuation\">)</span></span><br><span class=\"highlight-line\"></span><br><span class=\"highlight-line\">\t<span class=\"token keyword\">def</span> <span class=\"token function\">test_0</span><span class=\"token punctuation\">(</span>order<span class=\"token punctuation\">,</span> setup_0<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></span><br><span class=\"highlight-line\">\t\torder<span class=\"token punctuation\">.</span>append<span class=\"token punctuation\">(</span><span class=\"token string\">\"test_0\"</span><span class=\"token punctuation\">)</span></span><br><span class=\"highlight-line\">\t<span class=\"token keyword\">def</span> <span class=\"token function\">test_1</span><span class=\"token punctuation\">(</span>order<span class=\"token punctuation\">,</span> setup_1<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></span><br><span class=\"highlight-line\">\t\torder<span class=\"token punctuation\">.</span>append<span class=\"token punctuation\">(</span><span class=\"token string\">\"test_1\"</span><span class=\"token punctuation\">)</span>\t</span></code></pre>\n<ol start=\"4\">\n<li>Which occurs after the individual setups : Unfortunatly, this doesn't <em>quite</em> work, since the <code>setup</code> operations don't have to occur before the <code>deploy</code>. So we need to add them as dependencies to the <code>deploy</code> operation. The duplication of these setups is a bit not great. If I figure something better out I'll let you know. I think it's still reasonably fine to say that there's an extra step to register something as needing to happend before the deploy</li>\n</ol>\n<pre class=\"language-python\"><code class=\"language-python\"><span class=\"highlight-line\"><span class=\"token keyword\">import</span> pytest</span><br><span class=\"highlight-line\"></span><br><span class=\"highlight-line\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">TestBatch</span><span class=\"token punctuation\">:</span></span><br><span class=\"highlight-line\">\t<span class=\"token decorator annotation punctuation\">@pytest<span class=\"token punctuation\">.</span>fixture</span><span class=\"token punctuation\">(</span>scope<span class=\"token operator\">=</span><span class=\"token string\">\"class\"</span><span class=\"token punctuation\">,</span> autouse<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">)</span></span><br><span class=\"highlight-line\">\t<span class=\"token keyword\">def</span> <span class=\"token function\">deploy</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> order<span class=\"token punctuation\">,</span> setup_0<span class=\"token punctuation\">,</span> setup_1<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></span><br><span class=\"highlight-line\">\t\torder<span class=\"token punctuation\">.</span>append<span class=\"token punctuation\">(</span><span class=\"token string\">\"deploy\"</span><span class=\"token punctuation\">)</span></span><br><span class=\"highlight-line\"></span><br><span class=\"highlight-line\">\t<span class=\"token keyword\">def</span> <span class=\"token function\">test_0</span><span class=\"token punctuation\">(</span>order<span class=\"token punctuation\">,</span> setup_0<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></span><br><span class=\"highlight-line\">\t\torder<span class=\"token punctuation\">.</span>append<span class=\"token punctuation\">(</span><span class=\"token string\">\"test_0\"</span><span class=\"token punctuation\">)</span></span><br><span class=\"highlight-line\">\t<span class=\"token keyword\">def</span> <span class=\"token function\">test_1</span><span class=\"token punctuation\">(</span>order<span class=\"token punctuation\">,</span> setup_1<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></span><br><span class=\"highlight-line\">\t\torder<span class=\"token punctuation\">.</span>append<span class=\"token punctuation\">(</span><span class=\"token string\">\"test_1\"</span><span class=\"token punctuation\">)</span>\t</span></code></pre>\n<ol start=\"5\">\n<li>Which will not be impacted by the failure of any individual test setup : You may have notices that since the <code>setup</code> are fixture dependencies of <code>deploy</code>, their failure will cause the whole <code>deploy</code> to not start and all the tests to fail. So we'll have a fun way of catching those exceptions, and we'll explode them in the relevant test, so that only that test fails. It's not the greatest that you have to do this for all the setups.</li>\n</ol>\n<p>:/conftest.py</p>\n<pre class=\"language-python\"><code class=\"language-python\"><span class=\"highlight-line\"><span class=\"token keyword\">import</span> pytest</span><br><span class=\"highlight-line\"><span class=\"token keyword\">from</span> decorator <span class=\"token keyword\">import</span> deorate</span><br><span class=\"highlight-line\"></span><br><span class=\"highlight-line\"><span class=\"token keyword\">def</span> <span class=\"token function\">shroud</span><span class=\"token punctuation\">(</span>f<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></span><br><span class=\"highlight-line\">\t<span class=\"token keyword\">def</span> <span class=\"token function\">_shroud</span><span class=\"token punctuation\">(</span>func<span class=\"token punctuation\">,</span> <span class=\"token operator\">*</span>args<span class=\"token punctuation\">,</span> <span class=\"token operator\">**</span>kwargs<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></span><br><span class=\"highlight-line\">\t\t<span class=\"token keyword\">try</span><span class=\"token punctuation\">:</span></span><br><span class=\"highlight-line\">\t\t\t<span class=\"token keyword\">return</span> func<span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>args<span class=\"token punctuation\">,</span> <span class=\"token operator\">**</span>kwargs<span class=\"token punctuation\">)</span></span><br><span class=\"highlight-line\">\t\t<span class=\"token keyword\">except</span><span class=\"token punctuation\">:</span></span><br><span class=\"highlight-line\">\t\t\t<span class=\"token keyword\">return</span> e</span><br><span class=\"highlight-line\">\t<span class=\"token keyword\">return</span> decorate<span class=\"token punctuation\">(</span>f<span class=\"token punctuation\">,</span> _belt<span class=\"token punctuation\">)</span></span><br><span class=\"highlight-line\"></span><br><span class=\"highlight-line\"><span class=\"token keyword\">def</span> <span class=\"token function\">unshroud</span><span class=\"token punctuation\">(</span>a<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></span><br><span class=\"highlight-line\">\t<span class=\"token keyword\">if</span> <span class=\"token builtin\">isinstance</span><span class=\"token punctuation\">(</span>a<span class=\"token punctuation\">,</span> Exception<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></span><br><span class=\"highlight-line\">\t\t<span class=\"token keyword\">raise</span> a</span><br><span class=\"highlight-line\">\t<span class=\"token keyword\">return</span> a</span></code></pre>\n<p>:/test.py</p>\n<pre class=\"language-python\"><code class=\"language-python\"><span class=\"highlight-line\"><span class=\"token keyword\">import</span> pytest</span><br><span class=\"highlight-line\"><span class=\"token keyword\">from</span> conftest <span class=\"token keyword\">import</span> shroud<span class=\"token punctuation\">,</span> unshroud</span><br><span class=\"highlight-line\"></span><br><span class=\"highlight-line\"></span><br><span class=\"highlight-line\"><span class=\"token keyword\">import</span> pytest</span><br><span class=\"highlight-line\"><span class=\"token decorator annotation punctuation\">@pytest<span class=\"token punctuation\">.</span>fixture</span><span class=\"token punctuation\">(</span>scope<span class=\"token operator\">=</span><span class=\"token string\">\"class\"</span><span class=\"token punctuation\">)</span></span><br><span class=\"highlight-line\"><span class=\"token decorator annotation punctuation\">@shroud</span></span><br><span class=\"highlight-line\"><span class=\"token keyword\">def</span> <span class=\"token function\">setup_0</span><span class=\"token punctuation\">(</span>order<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></span><br><span class=\"highlight-line\">\torder<span class=\"token punctuation\">.</span>append<span class=\"token punctuation\">(</span><span class=\"token string\">\"setup_0\"</span><span class=\"token punctuation\">)</span></span><br><span class=\"highlight-line\"></span><br><span class=\"highlight-line\"><span class=\"token decorator annotation punctuation\">@pytest<span class=\"token punctuation\">.</span>fixture</span><span class=\"token punctuation\">(</span>scope<span class=\"token operator\">=</span><span class=\"token string\">\"class\"</span><span class=\"token punctuation\">)</span></span><br><span class=\"highlight-line\"><span class=\"token decorator annotation punctuation\">@shroud</span></span><br><span class=\"highlight-line\"><span class=\"token keyword\">def</span> <span class=\"token function\">setup_1</span><span class=\"token punctuation\">(</span>order<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></span><br><span class=\"highlight-line\">\torder<span class=\"token punctuation\">.</span>append<span class=\"token punctuation\">(</span><span class=\"token string\">\"setup_1\"</span><span class=\"token punctuation\">)</span></span><br><span class=\"highlight-line\"></span><br><span class=\"highlight-line\"></span><br><span class=\"highlight-line\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">TestBatch</span><span class=\"token punctuation\">:</span></span><br><span class=\"highlight-line\">\t<span class=\"token decorator annotation punctuation\">@pytest<span class=\"token punctuation\">.</span>fixture</span><span class=\"token punctuation\">(</span>scope<span class=\"token operator\">=</span><span class=\"token string\">\"class\"</span><span class=\"token punctuation\">,</span> autouse<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">)</span></span><br><span class=\"highlight-line\">\t<span class=\"token keyword\">def</span> <span class=\"token function\">deploy</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> order<span class=\"token punctuation\">,</span> setup_0<span class=\"token punctuation\">,</span> setup_1<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></span><br><span class=\"highlight-line\">\t\torder<span class=\"token punctuation\">.</span>append<span class=\"token punctuation\">(</span><span class=\"token string\">\"deploy\"</span><span class=\"token punctuation\">)</span></span><br><span class=\"highlight-line\"></span><br><span class=\"highlight-line\">\t<span class=\"token keyword\">def</span> <span class=\"token function\">test_0</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> order<span class=\"token punctuation\">,</span> setup_0<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></span><br><span class=\"highlight-line\">\t\tunshroud<span class=\"token punctuation\">(</span>setup_0<span class=\"token punctuation\">)</span></span><br><span class=\"highlight-line\">\t\torder<span class=\"token punctuation\">.</span>append<span class=\"token punctuation\">(</span><span class=\"token string\">\"test_0\"</span><span class=\"token punctuation\">)</span></span><br><span class=\"highlight-line\">\t<span class=\"token keyword\">def</span> <span class=\"token function\">test_1</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> order<span class=\"token punctuation\">,</span> setup_1<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></span><br><span class=\"highlight-line\">\t\tunshroud<span class=\"token punctuation\">(</span>setup_1<span class=\"token punctuation\">)</span></span><br><span class=\"highlight-line\">\t\torder<span class=\"token punctuation\">.</span>append<span class=\"token punctuation\">(</span><span class=\"token string\">\"test_1\"</span><span class=\"token punctuation\">)</span>\t</span></code></pre>\n<h2 id=\"full-solution\">Full Solution <a class=\"direct-link\" href=\"#full-solution\">#</a></h2>\n<p>:/conftest.py</p>\n<pre class=\"language-python\"><code class=\"language-python\"><span class=\"highlight-line\"><span class=\"token keyword\">import</span> pytest</span><br><span class=\"highlight-line\"><span class=\"token keyword\">from</span> decorator <span class=\"token keyword\">import</span> deorate</span><br><span class=\"highlight-line\"></span><br><span class=\"highlight-line\"><span class=\"token keyword\">def</span> <span class=\"token function\">shroud</span><span class=\"token punctuation\">(</span>f<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></span><br><span class=\"highlight-line\">\t<span class=\"token keyword\">def</span> <span class=\"token function\">_shroud</span><span class=\"token punctuation\">(</span>func<span class=\"token punctuation\">,</span> <span class=\"token operator\">*</span>args<span class=\"token punctuation\">,</span> <span class=\"token operator\">**</span>kwargs<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></span><br><span class=\"highlight-line\">\t\t<span class=\"token keyword\">try</span><span class=\"token punctuation\">:</span></span><br><span class=\"highlight-line\">\t\t\t<span class=\"token keyword\">return</span> func<span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>args<span class=\"token punctuation\">,</span> <span class=\"token operator\">**</span>kwargs<span class=\"token punctuation\">)</span></span><br><span class=\"highlight-line\">\t\t<span class=\"token keyword\">except</span><span class=\"token punctuation\">:</span></span><br><span class=\"highlight-line\">\t\t\t<span class=\"token keyword\">return</span> e</span><br><span class=\"highlight-line\">\t<span class=\"token keyword\">return</span> decorate<span class=\"token punctuation\">(</span>f<span class=\"token punctuation\">,</span> _belt<span class=\"token punctuation\">)</span></span><br><span class=\"highlight-line\"></span><br><span class=\"highlight-line\"><span class=\"token keyword\">def</span> <span class=\"token function\">unshroud</span><span class=\"token punctuation\">(</span>a<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></span><br><span class=\"highlight-line\">\t<span class=\"token keyword\">if</span> <span class=\"token builtin\">isinstance</span><span class=\"token punctuation\">(</span>a<span class=\"token punctuation\">,</span> Exception<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></span><br><span class=\"highlight-line\">\t\t<span class=\"token keyword\">raise</span> a</span><br><span class=\"highlight-line\">\t<span class=\"token keyword\">return</span> a</span></code></pre>\n<p>:/test.py</p>\n<pre class=\"language-python\"><code class=\"language-python\"><span class=\"highlight-line\"><span class=\"token keyword\">import</span> pytest</span><br><span class=\"highlight-line\"><span class=\"token keyword\">from</span> conftest <span class=\"token keyword\">import</span> shroud<span class=\"token punctuation\">,</span> unshroud</span><br><span class=\"highlight-line\"></span><br><span class=\"highlight-line\"></span><br><span class=\"highlight-line\"><span class=\"token keyword\">import</span> pytest</span><br><span class=\"highlight-line\"><span class=\"token decorator annotation punctuation\">@pytest<span class=\"token punctuation\">.</span>fixture</span><span class=\"token punctuation\">(</span>scope<span class=\"token operator\">=</span><span class=\"token string\">\"class\"</span><span class=\"token punctuation\">)</span></span><br><span class=\"highlight-line\"><span class=\"token decorator annotation punctuation\">@shroud</span></span><br><span class=\"highlight-line\"><span class=\"token keyword\">def</span> <span class=\"token function\">setup_0</span><span class=\"token punctuation\">(</span>order<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></span><br><span class=\"highlight-line\">\torder<span class=\"token punctuation\">.</span>append<span class=\"token punctuation\">(</span><span class=\"token string\">\"setup_0\"</span><span class=\"token punctuation\">)</span></span><br><span class=\"highlight-line\"></span><br><span class=\"highlight-line\"><span class=\"token decorator annotation punctuation\">@pytest<span class=\"token punctuation\">.</span>fixture</span><span class=\"token punctuation\">(</span>scope<span class=\"token operator\">=</span><span class=\"token string\">\"class\"</span><span class=\"token punctuation\">)</span></span><br><span class=\"highlight-line\"><span class=\"token decorator annotation punctuation\">@shroud</span></span><br><span class=\"highlight-line\"><span class=\"token keyword\">def</span> <span class=\"token function\">setup_1</span><span class=\"token punctuation\">(</span>order<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></span><br><span class=\"highlight-line\">\torder<span class=\"token punctuation\">.</span>append<span class=\"token punctuation\">(</span><span class=\"token string\">\"setup_1\"</span><span class=\"token punctuation\">)</span></span><br><span class=\"highlight-line\"></span><br><span class=\"highlight-line\"><span class=\"token decorator annotation punctuation\">@pytest<span class=\"token punctuation\">.</span>fixture</span><span class=\"token punctuation\">(</span>scope<span class=\"token operator\">=</span><span class=\"token string\">\"class\"</span><span class=\"token punctuation\">)</span></span><br><span class=\"highlight-line\"><span class=\"token decorator annotation punctuation\">@shroud</span></span><br><span class=\"highlight-line\"><span class=\"token keyword\">def</span> <span class=\"token function\">setup_failing</span><span class=\"token punctuation\">(</span>order<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></span><br><span class=\"highlight-line\">\t<span class=\"token triple-quoted-string string\">\"\"\" This setup fails, but only test_failing will fail \"\"\"</span></span><br><span class=\"highlight-line\">\torder<span class=\"token punctuation\">.</span>append<span class=\"token punctuation\">(</span><span class=\"token string\">\"setup_failing\"</span><span class=\"token punctuation\">)</span></span><br><span class=\"highlight-line\">\traisse Exception<span class=\"token punctuation\">(</span><span class=\"token string\">\"setup failure\"</span><span class=\"token punctuation\">)</span></span><br><span class=\"highlight-line\"></span><br><span class=\"highlight-line\"></span><br><span class=\"highlight-line\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">TestBatch</span><span class=\"token punctuation\">:</span></span><br><span class=\"highlight-line\">\t<span class=\"token decorator annotation punctuation\">@pytest<span class=\"token punctuation\">.</span>fixture</span><span class=\"token punctuation\">(</span>scope<span class=\"token operator\">=</span><span class=\"token string\">\"class\"</span><span class=\"token punctuation\">,</span> autouse<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">)</span></span><br><span class=\"highlight-line\">\t<span class=\"token keyword\">def</span> <span class=\"token function\">deploy</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> order<span class=\"token punctuation\">,</span> setup_0<span class=\"token punctuation\">,</span> setup_1<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></span><br><span class=\"highlight-line\">\t\torder<span class=\"token punctuation\">.</span>append<span class=\"token punctuation\">(</span><span class=\"token string\">\"deploy\"</span><span class=\"token punctuation\">)</span></span><br><span class=\"highlight-line\"></span><br><span class=\"highlight-line\">\t<span class=\"token keyword\">def</span> <span class=\"token function\">test_0</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> order<span class=\"token punctuation\">,</span> setup_0<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></span><br><span class=\"highlight-line\">\t\tunshroud<span class=\"token punctuation\">(</span>setup_0<span class=\"token punctuation\">)</span></span><br><span class=\"highlight-line\">\t\torder<span class=\"token punctuation\">.</span>append<span class=\"token punctuation\">(</span><span class=\"token string\">\"test_0\"</span><span class=\"token punctuation\">)</span></span><br><span class=\"highlight-line\">\t<span class=\"token keyword\">def</span> <span class=\"token function\">test_1</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> order<span class=\"token punctuation\">,</span> setup_1<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></span><br><span class=\"highlight-line\">\t\tunshroud<span class=\"token punctuation\">(</span>setup_1<span class=\"token punctuation\">)</span></span><br><span class=\"highlight-line\">\t\torder<span class=\"token punctuation\">.</span>append<span class=\"token punctuation\">(</span><span class=\"token string\">\"test_1\"</span><span class=\"token punctuation\">)</span></span><br><span class=\"highlight-line\"></span><br><span class=\"highlight-line\">\t<span class=\"token decorator annotation punctuation\">@pytest<span class=\"token punctuation\">.</span>mark<span class=\"token punctuation\">.</span>xfail</span></span><br><span class=\"highlight-line\">\t<span class=\"token keyword\">def</span> <span class=\"token function\">test_failing</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> setup_failing<span class=\"token punctuation\">,</span> order<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></span><br><span class=\"highlight-line\">\t\torder<span class=\"token punctuation\">.</span>append<span class=\"token punctuation\">(</span><span class=\"token string\">\"test_failing_begin\"</span><span class=\"token punctuation\">)</span></span><br><span class=\"highlight-line\">\t\tunshroud<span class=\"token punctuation\">(</span>setup_failing<span class=\"token punctuation\">)</span></span><br><span class=\"highlight-line\">\t\torder<span class=\"token punctuation\">.</span>append<span class=\"token punctuation\">(</span><span class=\"token string\">\"unshrouding will cause this not to appear\"</span><span class=\"token punctuation\">)</span></span></code></pre>\n",
      "date_published": "2020-12-30T00:00:00+00:00"
    },{
      "id": "https://lilatomic.ca/posts/fun_with_adodotnet/",
      "url": "https://lilatomic.ca/posts/fun_with_adodotnet/",
      "title": "Fun with ADO.NET",
      "content_html": "<h1 id=\"fun-with-ado.net\">Fun with <a href=\"http://ADO.NET\">ADO.NET</a> <a class=\"direct-link\" href=\"#fun-with-ado.net\">#</a></h1>\n<h2 id=\"column-is-not-in-table%2C-but-it-definitely-is\">Column is not in Table, but it definitely is <a class=\"direct-link\" href=\"#column-is-not-in-table%2C-but-it-definitely-is\">#</a></h2>\n<h3 id=\"problem\">Problem <a class=\"direct-link\" href=\"#problem\">#</a></h3>\n<p>Maybe you've got some code which is like the following, which accesses a field by a column reference. This particular snippet converts DBNull to Nothing (null), which is kinda useful I guess.</p>\n<pre class=\"language-vb\"><code class=\"language-vb\"><span class=\"highlight-line\"><span class=\"token keyword\">Public</span> <span class=\"token keyword\">Shared</span> <span class=\"token keyword\">Function</span> GetField<span class=\"token punctuation\">(</span><span class=\"token keyword\">ByVal</span> row <span class=\"token keyword\">As</span> EntityBase<span class=\"token punctuation\">,</span> <span class=\"token keyword\">ByVal</span> field <span class=\"token keyword\">As</span> DataColumn<span class=\"token punctuation\">)</span> <span class=\"token keyword\">As</span> <span class=\"token keyword\">Object</span></span><br><span class=\"highlight-line\">\t<span class=\"token keyword\">Dim</span> obj <span class=\"token keyword\">As</span> <span class=\"token keyword\">Object</span> <span class=\"token operator\">=</span> row<span class=\"token punctuation\">.</span>DataRow<span class=\"token punctuation\">.</span>Item<span class=\"token punctuation\">(</span>field<span class=\"token punctuation\">)</span></span><br><span class=\"highlight-line\">\t<span class=\"token keyword\">If</span> <span class=\"token keyword\">TypeOf</span> obj <span class=\"token keyword\">Is</span> DBNull <span class=\"token keyword\">Then</span></span><br><span class=\"highlight-line\">\t\t<span class=\"token keyword\">Return</span> <span class=\"token boolean\">Nothing</span></span><br><span class=\"highlight-line\">\t<span class=\"token keyword\">End</span> <span class=\"token keyword\">If</span></span><br><span class=\"highlight-line\">\t<span class=\"token keyword\">Return</span> obj</span><br><span class=\"highlight-line\"><span class=\"token keyword\">End</span> <span class=\"token keyword\">Function</span></span></code></pre>\n<p>You might find that you're getting some error about <code>&quot;Column '' does not belong to table .&quot;</code>, but you are 100% sure that the column actually is there. Maybe you've even cracked it open in the debugger and checked that the Table definitely has that column.</p>\n<h3 id=\"possible-cause\">Possible Cause <a class=\"direct-link\" href=\"#possible-cause\">#</a></h3>\n<p>One possibility is that the Columns are actually checked by reference equality, not value equality. So if you somehow have a new or different instance of the Table, the Column from one will not be found in the other. This could happen if you've recreated the DB but haven't updated things which reference columns. For example, maybe the application has a handy &quot;reload data&quot; button which recreates the tables and reloads from the DB, but doesn't purge an in-memory list (maybe it's even tightly bound in a UI component). Another way you could end up with different DBs is in tests. You might create and seed a Table, and separately reference columns from a Table inside your test.</p>\n<p>For extra fun, this doesn't seem to be a problem in the .Net Framework 2, but <em>is</em> in the .Net Framework 4. So that's exciting.</p>\n",
      "date_published": "2020-12-09T00:00:00+00:00"
    },{
      "id": "https://lilatomic.ca/posts/dhall_common_tasks_for_config_files/",
      "url": "https://lilatomic.ca/posts/dhall_common_tasks_for_config_files/",
      "title": "Common Dhall Tasks for Config Files",
      "content_html": "<h1 id=\"common-dhall-tasks-for-config-files\">Common Dhall Tasks for Config Files <a class=\"direct-link\" href=\"#common-dhall-tasks-for-config-files\">#</a></h1>\n<p>This page describes common tasks in using Dhall for generating config files. It provides the step-by-step for implementing these common features.</p>\n<h2 id=\"enums-(sum-types)\">Enums (Sum Types) <a class=\"direct-link\" href=\"#enums-(sum-types)\">#</a></h2>\n<ol>\n<li>\n<p>Define the type. Angle brackets around all the options, pipelines between the options. These are the names which appear in code, so it's alright if they follow your code convention rather than how they appear in the config file. So if you write enums in all capital letters because they're basically constants, you do you.</p>\n<p>:/types/ServiceType.dhall</p>\n<pre class=\"language-dhall\"><code class=\"language-dhall\"><span class=\"highlight-line\"><span class=\"token operator\">&lt;</span> simple <span class=\"token operator\">|</span> forking <span class=\"token operator\">|</span> oneshot <span class=\"token operator\">|</span> notify <span class=\"token operator\">|</span> dbus <span class=\"token operator\">|</span> idle <span class=\"token operator\">></span></span></code></pre>\n</li>\n<li>\n<p>Register it in the types.dhall file:</p>\n<p>:/types.dhall</p>\n<pre class=\"language-dhall\"><code class=\"language-dhall\"><span class=\"highlight-line\"><span class=\"token punctuation\">{</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">.</span></span><br><span class=\"highlight-line\"><span class=\"token punctuation\">,</span> <span class=\"token class-name\">ServiceType</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">.</span><span class=\"token punctuation\">/</span>types<span class=\"token punctuation\">/</span><span class=\"token class-name\">ServiceType</span><span class=\"token punctuation\">.</span>dhall</span><br><span class=\"highlight-line\"><span class=\"token punctuation\">}</span></span></code></pre>\n</li>\n<li>\n<p>Use it in an example by referencing through the type import:</p>\n<pre class=\"language-dhall\"><code class=\"language-dhall\"><span class=\"highlight-line\"><span class=\"token keyword\">let</span> <span class=\"token class-name\">ServiceType</span> <span class=\"token operator\">=</span> <span class=\"token class-name\">Systemd</span><span class=\"token punctuation\">.</span><span class=\"token class-name\">ServiceType</span><span class=\"token punctuation\">.</span>simple</span></code></pre>\n</li>\n<li>\n<p>Make a renderer for the type. Start with the import of the types files. Then we make a function which merges a record with the string equivalents with the input. The only thing which falls out is the correct string equivalent. Neat!</p>\n<p>:/render/ServiceType.dhall</p>\n<pre class=\"language-dhall\"><code class=\"language-dhall\"><span class=\"highlight-line\"><span class=\"token keyword\">let</span> types <span class=\"token operator\">=</span> <span class=\"token punctuation\">..</span><span class=\"token punctuation\">/</span>types<span class=\"token punctuation\">.</span>dhall</span><br><span class=\"highlight-line\"></span><br><span class=\"highlight-line\"><span class=\"token keyword\">in</span>  <span class=\"token operator\">λ</span><span class=\"token punctuation\">(</span>x <span class=\"token operator\">:</span> types<span class=\"token punctuation\">.</span><span class=\"token class-name\">ServiceType</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">→</span></span><br><span class=\"highlight-line\">\t<span class=\"token keyword\">merge</span></span><br><span class=\"highlight-line\">\t\t<span class=\"token punctuation\">{</span> simple <span class=\"token operator\">=</span> <span class=\"token string\">\"simple\"</span></span><br><span class=\"highlight-line\">\t\t<span class=\"token punctuation\">,</span> forking <span class=\"token operator\">=</span> <span class=\"token string\">\"forking\"</span></span><br><span class=\"highlight-line\">\t\t<span class=\"token punctuation\">,</span> oneshot <span class=\"token operator\">=</span> <span class=\"token string\">\"oneshot\"</span></span><br><span class=\"highlight-line\">\t\t<span class=\"token punctuation\">,</span> notify <span class=\"token operator\">=</span> <span class=\"token string\">\"notify\"</span></span><br><span class=\"highlight-line\">\t\t<span class=\"token punctuation\">,</span> dbus <span class=\"token operator\">=</span> <span class=\"token string\">\"dbus\"</span></span><br><span class=\"highlight-line\">\t\t<span class=\"token punctuation\">,</span> idle <span class=\"token operator\">=</span> <span class=\"token string\">\"idle\"</span></span><br><span class=\"highlight-line\">\t\t<span class=\"token punctuation\">}</span></span><br><span class=\"highlight-line\">\t\tx</span></code></pre>\n</li>\n<li>\n<p>Register the renderer with:</p>\n<p>:/render.dhall</p>\n<pre class=\"language-dhall\"><code class=\"language-dhall\"><span class=\"highlight-line\"><span class=\"token punctuation\">{</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">.</span></span><br><span class=\"highlight-line\"><span class=\"token punctuation\">,</span> <span class=\"token class-name\">ServiceType</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">.</span><span class=\"token punctuation\">/</span>render<span class=\"token punctuation\">/</span><span class=\"token class-name\">ServiceType</span><span class=\"token punctuation\">.</span>dhall</span><br><span class=\"highlight-line\"><span class=\"token punctuation\">}</span></span><br><span class=\"highlight-line\"></span></code></pre>\n</li>\n<li>\n<p>Use it in other renderers like normal. Since we're in the 'render' folder, we can just import it with a local import, like <code>./ServiceType.dhall</code></p>\n<p>:/render/Service.dhall</p>\n<pre class=\"language-dhall\"><code class=\"language-dhall\"><span class=\"highlight-line\"><span class=\"token keyword\">let</span> types <span class=\"token operator\">=</span> <span class=\"token punctuation\">..</span><span class=\"token punctuation\">/</span>types<span class=\"token punctuation\">.</span>dhall</span><br><span class=\"highlight-line\"></span><br><span class=\"highlight-line\"><span class=\"token keyword\">in</span>  <span class=\"token operator\">λ</span><span class=\"token punctuation\">(</span>i <span class=\"token operator\">:</span> types<span class=\"token punctuation\">.</span><span class=\"token class-name\">Service</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">→</span></span><br>\t<span class=\"token string\">''<br><span class=\"highlight-line\">\t[Service]</span><br><span class=\"highlight-line\">\tUser=<span class=\"token interpolation\"><span class=\"token punctuation\">${</span><span class=\"token expression language-dhall\">i<span class=\"token punctuation\">.</span><span class=\"token class-name\">User</span></span><span class=\"token punctuation\">}</span></span></span><br><span class=\"highlight-line\">\tExecStart=<span class=\"token interpolation\"><span class=\"token punctuation\">${</span><span class=\"token expression language-dhall\">i<span class=\"token punctuation\">.</span><span class=\"token class-name\">ExecStart</span></span><span class=\"token punctuation\">}</span></span></span><br><span class=\"highlight-line\">\tType=<span class=\"token interpolation\"><span class=\"token punctuation\">${</span><span class=\"token expression language-dhall\"><span class=\"token punctuation\">.</span><span class=\"token punctuation\">/</span><span class=\"token class-name\">ServiceType</span><span class=\"token punctuation\">.</span>dhall i<span class=\"token punctuation\">.</span><span class=\"token class-name\">ServiceType</span></span><span class=\"token punctuation\">}</span></span></span><br>\t''</span></code></pre>\n</li>\n</ol>\n<h2 id=\"unions-%7C-complex-sum-types\">Unions | Complex Sum Types <a class=\"direct-link\" href=\"#unions-%7C-complex-sum-types\">#</a></h2>\n<p>Sometimes you've got a field which is a value of Type a <em>or</em> Type b. A sum type represents that. This example combines an enum and Text, but the same principle holds for any types. Here's a <a href=\"https://hackage.haskell.org/package/dhall-1.16.1/docs/Dhall-Tutorial.html#g:12\">link</a> for the official tutorial</p>\n<ol>\n<li>\n<p>Create the sum type similarly to how you'd create an Enum. Note that each option has both a name and a Type. These also generate the constructors for the Union type.</p>\n<p>:/types/Dependency.dhall</p>\n<pre class=\"language-dhall\"><code class=\"language-dhall\"><span class=\"highlight-line\"><span class=\"token operator\">&lt;</span> <span class=\"token class-name\">Runlevel</span> <span class=\"token operator\">:</span> <span class=\"token punctuation\">.</span><span class=\"token punctuation\">/</span><span class=\"token class-name\">RunlevelTargets</span><span class=\"token punctuation\">.</span>dhall <span class=\"token operator\">|</span> <span class=\"token class-name\">Service</span> <span class=\"token operator\">:</span> <span class=\"token class-name\">Text</span> <span class=\"token operator\">></span></span></code></pre>\n</li>\n<li>\n<p>Register it in the ':/types.dhall'</p>\n</li>\n<li>\n<p>Make a renderer for the type. You can use merge to select a function and then apply it. You can compose this from other functions you have already. Note that we use <code>=</code> here, since this isn't defining a type signature. Also note that we're using <code>id</code>, <code>Text/show</code> was adding extra quotes.</p>\n<p>:/render/Dependency.dhall</p>\n<pre class=\"language-dhall\"><code class=\"language-dhall\"><span class=\"highlight-line\"><span class=\"token keyword\">let</span> types <span class=\"token operator\">=</span> <span class=\"token punctuation\">..</span><span class=\"token punctuation\">/</span>types<span class=\"token punctuation\">.</span>dhall</span><br><span class=\"highlight-line\"></span><br><span class=\"highlight-line\"><span class=\"token keyword\">let</span> id <span class=\"token operator\">=</span> <span class=\"token operator\">λ</span><span class=\"token punctuation\">(</span>a <span class=\"token operator\">:</span> <span class=\"token class-name\">Type</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">→</span> <span class=\"token operator\">λ</span><span class=\"token punctuation\">(</span>x <span class=\"token operator\">:</span> a<span class=\"token punctuation\">)</span> <span class=\"token operator\">→</span> x</span><br><span class=\"highlight-line\"></span><br><span class=\"highlight-line\"><span class=\"token keyword\">in</span>  <span class=\"token operator\">λ</span><span class=\"token punctuation\">(</span>x <span class=\"token operator\">:</span> types<span class=\"token punctuation\">.</span><span class=\"token class-name\">Dependency</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">→</span></span><br><span class=\"highlight-line\">\t<span class=\"token keyword\">merge</span> <span class=\"token punctuation\">{</span> <span class=\"token class-name\">Runlevel</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">.</span><span class=\"token punctuation\">/</span><span class=\"token class-name\">RunlevelTargets</span><span class=\"token punctuation\">.</span>dhall<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Service</span> <span class=\"token operator\">=</span> id <span class=\"token class-name\">Text</span> <span class=\"token punctuation\">}</span> x</span></code></pre>\n</li>\n<li>\n<p>Register it in the ':/render.dhall'</p>\n</li>\n<li>\n<p>Use it by accessing the constructor you want. Note that the renderer is the same, since they're ultimatly the same type:</p>\n<pre class=\"language-dhall\"><code class=\"language-dhall\"><span class=\"highlight-line\"><span class=\"token keyword\">let</span> <span class=\"token class-name\">Systemd</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">..</span><span class=\"token punctuation\">/</span>types<span class=\"token punctuation\">.</span>dhall</span><br><span class=\"highlight-line\"></span><br><span class=\"highlight-line\"><span class=\"token keyword\">let</span> <span class=\"token class-name\">Render</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">.</span><span class=\"token punctuation\">/</span>reder<span class=\"token punctuation\">.</span>dhall</span><br><span class=\"highlight-line\"></span><br><span class=\"token keyword\">in</span>  <span class=\"token string\">''<br><span class=\"highlight-line\">\t<span class=\"token interpolation\"><span class=\"token punctuation\">${</span><span class=\"token expression language-dhall\"><span class=\"token class-name\">Render</span><span class=\"token punctuation\">.</span><span class=\"token class-name\">Dependency</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Systemd</span><span class=\"token punctuation\">.</span><span class=\"token class-name\">Dependency</span><span class=\"token punctuation\">.</span><span class=\"token class-name\">Service</span> <span class=\"token string\">\"nfs-common.service\"</span><span class=\"token punctuation\">)</span></span><span class=\"token punctuation\">}</span></span></span><br>\t<span class=\"token interpolation\"><span class=\"token punctuation\">${</span><span class=\"token expression language-dhall\"><span class=\"token class-name\">Render</span><span class=\"token punctuation\">.</span><span class=\"token class-name\">Dependency</span><br>\t\t<span class=\"token punctuation\">(</span><span class=\"token class-name\">Systemd</span><span class=\"token punctuation\">.</span><span class=\"token class-name\">Dependency</span><span class=\"token punctuation\">.</span><span class=\"token class-name\">Runlevel</span> <span class=\"token class-name\">Systemd</span><span class=\"token punctuation\">.</span><span class=\"token class-name\">Runlevel</span><span class=\"token punctuation\">.</span>multiuser<span class=\"token punctuation\">)</span></span><span class=\"token punctuation\">}</span></span><br>\t''</span></code></pre>\n</li>\n</ol>\n<h2 id=\"optional-fields-(autoexclusion)\">Optional fields (autoexclusion) <a class=\"direct-link\" href=\"#optional-fields-(autoexclusion)\">#</a></h2>\n<p>Sometimes you want a field to not appear if there is no value defined.</p>\n<p>We'll define a helper function to render optionals. I use it frequently so I gave it a short name. Mine adds a newline automatically, so they don't appear if the option doesn't render.</p>\n<p>:/render/ro.dhall</p>\n<pre class=\"language-dhall\"><code class=\"language-dhall\"><span class=\"token comment\">{-<br><span class=\"highlight-line\">\ta: Type parameter</span><br><span class=\"highlight-line\">\tf: Renderer</span><br><span class=\"highlight-line\">\topt: Value</span><br>-}</span><br><span class=\"highlight-line\"><span class=\"token operator\">λ</span><span class=\"token punctuation\">(</span>a <span class=\"token operator\">:</span> <span class=\"token class-name\">Type</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">→</span></span><br><span class=\"highlight-line\"><span class=\"token operator\">λ</span><span class=\"token punctuation\">(</span>f <span class=\"token operator\">:</span> a <span class=\"token operator\">→</span> <span class=\"token class-name\">Text</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">→</span></span><br><span class=\"highlight-line\"><span class=\"token operator\">λ</span><span class=\"token punctuation\">(</span>opt <span class=\"token operator\">:</span> <span class=\"token class-name\">Optional</span> a<span class=\"token punctuation\">)</span> <span class=\"token operator\">→</span></span><br><span class=\"highlight-line\">\t<span class=\"token keyword\">merge</span> <span class=\"token punctuation\">{</span> <span class=\"token builtin\">Some</span> <span class=\"token operator\">=</span> <span class=\"token operator\">λ</span><span class=\"token punctuation\">(</span>x <span class=\"token operator\">:</span> a<span class=\"token punctuation\">)</span> <span class=\"token operator\">→</span> f x <span class=\"token operator\">++</span> <span class=\"token string\">\"\\n\"</span><span class=\"token punctuation\">,</span> <span class=\"token builtin\">None</span> <span class=\"token operator\">=</span> <span class=\"token string\">\"\"</span> <span class=\"token punctuation\">}</span> opt</span></code></pre>\n<p>Using that one is a bit clunky:</p>\n<pre class=\"language-dhall\"><code class=\"language-dhall\"><span class=\"highlight-line\"><span class=\"token keyword\">in</span>  <span class=\"token operator\">λ</span><span class=\"token punctuation\">(</span>i <span class=\"token operator\">:</span> types<span class=\"token punctuation\">.</span><span class=\"token class-name\">Install</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">→</span></span><br>          <span class=\"token string\">''<br><span class=\"highlight-line\">          [Install]</span><br>          ''</span><br><span class=\"highlight-line\">      <span class=\"token operator\">++</span>  ro</span><br><span class=\"highlight-line\">            types<span class=\"token punctuation\">.</span><span class=\"token class-name\">Dependency</span></span><br><span class=\"highlight-line\">            <span class=\"token punctuation\">(</span><span class=\"token operator\">λ</span><span class=\"token punctuation\">(</span>l <span class=\"token operator\">:</span> types<span class=\"token punctuation\">.</span><span class=\"token class-name\">Dependency</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">→</span> <span class=\"token string\">\"WantedBy=<span class=\"token interpolation\"><span class=\"token punctuation\">${</span><span class=\"token expression language-dhall\"><span class=\"token punctuation\">.</span><span class=\"token punctuation\">/</span><span class=\"token class-name\">Dependency</span><span class=\"token punctuation\">.</span>dhall l</span><span class=\"token punctuation\">}</span></span>\"</span><span class=\"token punctuation\">)</span></span><br><span class=\"highlight-line\">            i<span class=\"token punctuation\">.</span><span class=\"token class-name\">WantedBy</span></span><br><span class=\"highlight-line\"></span></code></pre>\n<p>So I made this following helper, which works better with the config file format:</p>\n<p>:/render/ron.dhall</p>\n<pre class=\"language-dhall\"><code class=\"language-dhall\"><span class=\"highlight-line\"><span class=\"token keyword\">let</span> ro <span class=\"token operator\">=</span> <span class=\"token punctuation\">.</span><span class=\"token punctuation\">/</span>ro<span class=\"token punctuation\">.</span>dhall</span><br><span class=\"highlight-line\"></span><br><span class=\"highlight-line\"><span class=\"token keyword\">in</span>  <span class=\"token operator\">λ</span><span class=\"token punctuation\">(</span>a <span class=\"token operator\">:</span> <span class=\"token class-name\">Type</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">→</span></span><br><span class=\"highlight-line\">    <span class=\"token operator\">λ</span><span class=\"token punctuation\">(</span>n <span class=\"token operator\">:</span> <span class=\"token class-name\">Text</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">→</span></span><br><span class=\"highlight-line\">    <span class=\"token operator\">λ</span><span class=\"token punctuation\">(</span>f <span class=\"token operator\">:</span> a <span class=\"token operator\">→</span> <span class=\"token class-name\">Text</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">→</span></span><br><span class=\"highlight-line\">    <span class=\"token operator\">λ</span><span class=\"token punctuation\">(</span>opt <span class=\"token operator\">:</span> <span class=\"token class-name\">Optional</span> a<span class=\"token punctuation\">)</span> <span class=\"token operator\">→</span></span><br><span class=\"highlight-line\">      ro a <span class=\"token punctuation\">(</span><span class=\"token operator\">λ</span><span class=\"token punctuation\">(</span>l <span class=\"token operator\">:</span> a<span class=\"token punctuation\">)</span> <span class=\"token operator\">→</span> <span class=\"token string\">\"<span class=\"token interpolation\"><span class=\"token punctuation\">${</span><span class=\"token expression language-dhall\">n</span><span class=\"token punctuation\">}</span></span>=<span class=\"token interpolation\"><span class=\"token punctuation\">${</span><span class=\"token expression language-dhall\">f l</span><span class=\"token punctuation\">}</span></span>\"</span><span class=\"token punctuation\">)</span> opt</span></code></pre>\n<p>And can be used like:</p>\n<pre class=\"language-dhall\"><code class=\"language-dhall\"><span class=\"highlight-line\"><span class=\"token keyword\">in</span>  <span class=\"token operator\">λ</span><span class=\"token punctuation\">(</span>i <span class=\"token operator\">:</span> types<span class=\"token punctuation\">.</span><span class=\"token class-name\">Install</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">→</span></span><br>          <span class=\"token string\">''<br><span class=\"highlight-line\">          [Install]</span><br>          ''</span><br><span class=\"highlight-line\">      <span class=\"token operator\">++</span>  ron types<span class=\"token punctuation\">.</span><span class=\"token class-name\">Dependency</span> <span class=\"token string\">\"WantedBy\"</span> <span class=\"token punctuation\">.</span><span class=\"token punctuation\">/</span><span class=\"token class-name\">Dependency</span><span class=\"token punctuation\">.</span>dhall i<span class=\"token punctuation\">.</span><span class=\"token class-name\">WantedBy</span></span></code></pre>\n<p>If you find yourself frequently using the same type (for example, bools), you can make another wrapper for that. The dhall-nethack repo makes significant use of those, see the <a href=\"https://github.com/dhall-lang/dhall-nethack/blob/2b7ea599ae09c077bd8bda82cfb3c2601925e300/render/Config.dhall\">config class</a></p>\n<h2 id=\"multiple-exports-per-file\">Multiple exports per file <a class=\"direct-link\" href=\"#multiple-exports-per-file\">#</a></h2>\n<p>Dhall likes you to have a single type per file. But sometimes you have a group of types which don't make sense separately. Or you have a lot of types which are basically just type aliases for primitive types. You can export them in a file like so</p>\n<p>:/ex.dhall</p>\n<pre class=\"language-dhall\"><code class=\"language-dhall\"><span class=\"highlight-line\"><span class=\"token punctuation\">{</span> <span class=\"token class-name\">Thing0</span> <span class=\"token operator\">=</span> <span class=\"token class-name\">Text</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Thing1</span> <span class=\"token operator\">=</span> <span class=\"token class-name\">Integer</span> <span class=\"token punctuation\">}</span></span></code></pre>\n<p>and then use them like</p>\n<pre class=\"language-dhall\"><code class=\"language-dhall\"><span class=\"highlight-line\"><span class=\"token keyword\">let</span> ex <span class=\"token operator\">=</span> <span class=\"token punctuation\">.</span><span class=\"token punctuation\">/</span>ex<span class=\"token punctuation\">.</span>dhall</span><br><span class=\"highlight-line\"></span><br><span class=\"highlight-line\"><span class=\"token keyword\">let</span> y</span><br><span class=\"highlight-line\">    <span class=\"token operator\">:</span> ex<span class=\"token punctuation\">.</span><span class=\"token class-name\">Thing0</span></span><br><span class=\"highlight-line\">    <span class=\"token operator\">=</span> <span class=\"token string\">\"HELLO\"</span></span><br><span class=\"highlight-line\"></span><br><span class=\"highlight-line\"><span class=\"token keyword\">in</span> y</span></code></pre>\n<p>If some of your types reference another, you'll need to pull the referenced type into a <code>let</code> higher in the file:</p>\n<p>:/ex.dhall</p>\n<pre class=\"language-dhall\"><code class=\"language-dhall\"><span class=\"highlight-line\"><span class=\"token keyword\">let</span> <span class=\"token class-name\">T</span></span><br><span class=\"highlight-line\">    <span class=\"token operator\">:</span> <span class=\"token class-name\">Type</span></span><br><span class=\"highlight-line\">    <span class=\"token operator\">=</span> <span class=\"token class-name\">Text</span></span><br><span class=\"highlight-line\"></span><br><span class=\"highlight-line\"><span class=\"token keyword\">in</span>  <span class=\"token punctuation\">{</span> <span class=\"token class-name\">T</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">ListOfT</span> <span class=\"token operator\">=</span> <span class=\"token class-name\">List</span> <span class=\"token class-name\">T</span> <span class=\"token punctuation\">}</span></span></code></pre>\n",
      "date_published": "2020-12-09T00:00:00+00:00"
    },{
      "id": "https://lilatomic.ca/posts/dhall_for_config_files/",
      "url": "https://lilatomic.ca/posts/dhall_for_config_files/",
      "title": "Dhall for Config Files",
      "content_html": "<h1 id=\"dhall-for-config-files\">Dhall for Config Files <a class=\"direct-link\" href=\"#dhall-for-config-files\">#</a></h1>\n<h2 id=\"setting-up-a-dhall-project\">Setting up a Dhall project <a class=\"direct-link\" href=\"#setting-up-a-dhall-project\">#</a></h2>\n<p>Let's start with the standard directory used in the <a href=\"https://github.com/dhall-lang/dhall-nethack/blob/master/types.dhall\">dhall-nethack repo</a></p>\n<ul>\n<li>types.dhall : this file is a convenient import of all the types</li>\n<li>types/ : this is where we put all of our type definitions</li>\n<li>render.dhall : this is a convenient way of importing all the render functions</li>\n<li>render/ : this is where we put all of our render functions</li>\n</ul>\n<p>Neat!</p>\n<h2 id=\"adding-a-type\">Adding a type <a class=\"direct-link\" href=\"#adding-a-type\">#</a></h2>\n<ol>\n<li>\n<p>Add your type as a record in a file under the :/types/ directory.</p>\n<p>:/types/Install.dhall</p>\n<pre class=\"language-dhall\"><code class=\"language-dhall\"><span class=\"highlight-line\"><span class=\"token punctuation\">{</span> <span class=\"token class-name\">WantedBy</span> <span class=\"token operator\">:</span> <span class=\"token class-name\">Text</span> <span class=\"token punctuation\">}</span></span></code></pre>\n<p>If you need to reference another type in this type, you can use an import, like <code>./TypeName.dhall</code>. Since we're in the folder with all of our types, we can just use access to the local directory.<br>\n:/types/SystemdUnit.dhall</p>\n<pre class=\"language-dhall\"><code class=\"language-dhall\"><span class=\"highlight-line\"><span class=\"token punctuation\">{</span> <span class=\"token class-name\">Unit</span> <span class=\"token operator\">:</span> <span class=\"token punctuation\">.</span><span class=\"token punctuation\">/</span><span class=\"token class-name\">Unit</span><span class=\"token punctuation\">.</span>dhall<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Service</span> <span class=\"token operator\">:</span> <span class=\"token punctuation\">.</span><span class=\"token punctuation\">/</span><span class=\"token class-name\">Service</span><span class=\"token punctuation\">.</span>dhall<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Install</span> <span class=\"token operator\">:</span> <span class=\"token punctuation\">.</span><span class=\"token punctuation\">/</span><span class=\"token class-name\">Install</span><span class=\"token punctuation\">.</span>dhall <span class=\"token punctuation\">}</span></span></code></pre>\n</li>\n<li>\n<p>Register your type in :/types.</p>\n<p>:/types.dhall</p>\n<pre class=\"language-dhall\"><code class=\"language-dhall\"><span class=\"highlight-line\"><span class=\"token punctuation\">{</span> <span class=\"token class-name\">Unit</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">.</span><span class=\"token punctuation\">/</span>types<span class=\"token punctuation\">/</span><span class=\"token class-name\">Unit</span><span class=\"token punctuation\">.</span>dhall</span><br><span class=\"highlight-line\">  <span class=\"token punctuation\">,</span> <span class=\"token class-name\">Service</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">.</span><span class=\"token punctuation\">/</span>types<span class=\"token punctuation\">/</span><span class=\"token class-name\">Service</span><span class=\"token punctuation\">.</span>dhall</span><br><span class=\"highlight-line\">  <span class=\"token punctuation\">,</span> <span class=\"token class-name\">Install</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">.</span><span class=\"token punctuation\">/</span>types<span class=\"token punctuation\">/</span><span class=\"token class-name\">Install</span><span class=\"token punctuation\">.</span>dhall</span><br><span class=\"highlight-line\">  <span class=\"token punctuation\">,</span> <span class=\"token class-name\">SystemdUnit</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">.</span><span class=\"token punctuation\">/</span>types<span class=\"token punctuation\">/</span><span class=\"token class-name\">SystemdUnit</span><span class=\"token punctuation\">.</span>dhall</span><br><span class=\"highlight-line\"><span class=\"token punctuation\">}</span></span></code></pre>\n</li>\n<li>\n<p>You can now use your type by importing the :/types.dhall file:</p>\n<pre class=\"language-dhall\"><code class=\"language-dhall\"><span class=\"highlight-line\"><span class=\"token keyword\">let</span> <span class=\"token class-name\">Systemd</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">.</span><span class=\"token punctuation\">/</span>types<span class=\"token punctuation\">.</span>dhall</span><br><span class=\"highlight-line\"></span><br><span class=\"highlight-line\"><span class=\"token keyword\">let</span> t</span><br><span class=\"highlight-line\">    <span class=\"token operator\">:</span> <span class=\"token class-name\">Systemd</span><span class=\"token punctuation\">.</span><span class=\"token class-name\">SystemdUnit</span></span><br><span class=\"highlight-line\">    <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span> <span class=\"token class-name\">Unit</span><span class=\"token punctuation\">.</span><span class=\"token class-name\">Description</span> <span class=\"token operator\">=</span> <span class=\"token string\">\"hello\"</span></span><br><span class=\"highlight-line\">      <span class=\"token punctuation\">,</span> <span class=\"token class-name\">Service</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span> <span class=\"token class-name\">User</span> <span class=\"token operator\">=</span> <span class=\"token string\">\"me\"</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">ExecStart</span> <span class=\"token operator\">=</span> <span class=\"token string\">\"/usr/bin/bash pwd\"</span> <span class=\"token punctuation\">}</span></span><br><span class=\"highlight-line\">      <span class=\"token punctuation\">,</span> <span class=\"token class-name\">Install</span><span class=\"token punctuation\">.</span><span class=\"token class-name\">WantedBy</span> <span class=\"token operator\">=</span> <span class=\"token string\">\"multi_user.target\"</span></span><br><span class=\"highlight-line\">      <span class=\"token punctuation\">}</span></span><br><span class=\"highlight-line\"></span><br><span class=\"highlight-line\"><span class=\"token keyword\">in</span>  <span class=\"token punctuation\">{</span> <span class=\"token class-name\">Unit</span><span class=\"token punctuation\">.</span><span class=\"token class-name\">Description</span> <span class=\"token operator\">=</span> <span class=\"token string\">\"hello\"</span></span><br><span class=\"highlight-line\">    <span class=\"token punctuation\">,</span> <span class=\"token class-name\">Service</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span> <span class=\"token class-name\">User</span> <span class=\"token operator\">=</span> <span class=\"token string\">\"me\"</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">ExecStart</span> <span class=\"token operator\">=</span> <span class=\"token string\">\"/usr/bin/bash pwd\"</span> <span class=\"token punctuation\">}</span></span><br><span class=\"highlight-line\">    <span class=\"token punctuation\">,</span> <span class=\"token class-name\">Install</span><span class=\"token punctuation\">.</span><span class=\"token class-name\">WantedBy</span> <span class=\"token operator\">=</span> <span class=\"token string\">\"multi_user.target\"</span></span><br><span class=\"highlight-line\">    <span class=\"token punctuation\">}</span></span></code></pre>\n</li>\n</ol>\n<h2 id=\"adding-a-renderer-for-a-type\">Adding a renderer for a type <a class=\"direct-link\" href=\"#adding-a-renderer-for-a-type\">#</a></h2>\n<p>If you need to output to a format other than JSON or YAML, you'll need to write your renderers and pass it through <code>dhall text</code></p>\n<ol>\n<li>\n<p>Add a renderer for your type in a file under the :/render/ directory. This is a function which takes one of your type and returns Text. You can import your type with all types through the phrase <code>let types = ../types.dhall</code>, or you can use a direct import with <code>../types/YourType.dhall</code>.</p>\n<p>:/render/Install.dhall</p>\n<pre class=\"language-dhall\"><code class=\"language-dhall\"><span class=\"highlight-line\"><span class=\"token keyword\">let</span> types <span class=\"token operator\">=</span> <span class=\"token punctuation\">..</span><span class=\"token punctuation\">/</span>types<span class=\"token punctuation\">.</span>dhall</span><br><span class=\"highlight-line\"></span><br><span class=\"highlight-line\"><span class=\"token keyword\">in</span>  <span class=\"token operator\">λ</span><span class=\"token punctuation\">(</span>i <span class=\"token operator\">:</span> types<span class=\"token punctuation\">.</span><span class=\"token class-name\">Install</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">→</span></span><br>      <span class=\"token string\">''<br><span class=\"highlight-line\">      [Install]</span><br><span class=\"highlight-line\">      WantedBy=<span class=\"token interpolation\"><span class=\"token punctuation\">${</span><span class=\"token expression language-dhall\">i<span class=\"token punctuation\">.</span><span class=\"token class-name\">WantedBy</span></span><span class=\"token punctuation\">}</span></span></span><br>      ''</span></code></pre>\n<p>If you need to reference another renderer in this renderer, you can do that with a simple import, like <code>./Service.dhall</code></p>\n</li>\n<li>\n<p>Register the renderer in the :/render.dhall file</p>\n<p>:/reder.dhall</p>\n<pre class=\"language-dhall\"><code class=\"language-dhall\"><span class=\"highlight-line\"><span class=\"token punctuation\">{</span> <span class=\"token class-name\">Unit</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">.</span><span class=\"token punctuation\">/</span>render<span class=\"token punctuation\">/</span><span class=\"token class-name\">Unit</span><span class=\"token punctuation\">.</span>dhall</span><br><span class=\"highlight-line\"><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Service</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">.</span><span class=\"token punctuation\">/</span>render<span class=\"token punctuation\">/</span><span class=\"token class-name\">Service</span><span class=\"token punctuation\">.</span>dhall</span><br><span class=\"highlight-line\"><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Install</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">.</span><span class=\"token punctuation\">/</span>render<span class=\"token punctuation\">/</span><span class=\"token class-name\">Install</span><span class=\"token punctuation\">.</span>dhall</span><br><span class=\"highlight-line\"><span class=\"token punctuation\">,</span> <span class=\"token class-name\">SystemdUnit</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">.</span><span class=\"token punctuation\">/</span>render<span class=\"token punctuation\">/</span><span class=\"token class-name\">SystemdUnit</span><span class=\"token punctuation\">.</span>dhall</span><br><span class=\"highlight-line\"><span class=\"token punctuation\">}</span></span><br><span class=\"highlight-line\"></span></code></pre>\n</li>\n<li>\n<p>You can now use your renderers by importing them with <code>./render.dhall</code></p>\n<pre class=\"language-dhall\"><code class=\"language-dhall\"><span class=\"highlight-line\"><span class=\"token keyword\">let</span> <span class=\"token class-name\">Systemd</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">.</span><span class=\"token punctuation\">/</span>types<span class=\"token punctuation\">.</span>dhall</span><br><span class=\"highlight-line\"></span><br><span class=\"highlight-line\"><span class=\"token keyword\">let</span> <span class=\"token class-name\">Render</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">.</span><span class=\"token punctuation\">/</span>reder<span class=\"token punctuation\">.</span>dhall</span><br><span class=\"highlight-line\"></span><br><span class=\"highlight-line\"><span class=\"token keyword\">let</span> t</span><br><span class=\"highlight-line\">    <span class=\"token operator\">:</span> <span class=\"token class-name\">Systemd</span><span class=\"token punctuation\">.</span><span class=\"token class-name\">SystemdUnit</span></span><br><span class=\"highlight-line\">    <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span> <span class=\"token class-name\">Unit</span><span class=\"token punctuation\">.</span><span class=\"token class-name\">Description</span> <span class=\"token operator\">=</span> <span class=\"token string\">\"hello\"</span></span><br><span class=\"highlight-line\">      <span class=\"token punctuation\">,</span> <span class=\"token class-name\">Service</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span> <span class=\"token class-name\">User</span> <span class=\"token operator\">=</span> <span class=\"token string\">\"me\"</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">ExecStart</span> <span class=\"token operator\">=</span> <span class=\"token string\">\"/usr/bin/bash pwd\"</span> <span class=\"token punctuation\">}</span></span><br><span class=\"highlight-line\">      <span class=\"token punctuation\">,</span> <span class=\"token class-name\">Install</span><span class=\"token punctuation\">.</span><span class=\"token class-name\">WantedBy</span> <span class=\"token operator\">=</span> <span class=\"token string\">\"multi_user.target\"</span></span><br><span class=\"highlight-line\">      <span class=\"token punctuation\">}</span></span><br><span class=\"highlight-line\"></span><br><span class=\"highlight-line\"><span class=\"token keyword\">in</span>  <span class=\"token class-name\">Render</span><span class=\"token punctuation\">.</span><span class=\"token class-name\">SystemdUnit</span> t</span></code></pre>\n</li>\n<li>\n<p>And you can run the dhall with <code>dhall text</code></p>\n<pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"highlight-line\"><span class=\"token operator\">></span> dhall text --file f.dhall</span><br><span class=\"highlight-line\"><span class=\"token punctuation\">[</span>Unit<span class=\"token punctuation\">]</span></span><br><span class=\"highlight-line\"><span class=\"token assign-left variable\">Description</span><span class=\"token operator\">=</span>hello</span><br><span class=\"highlight-line\"><span class=\"token punctuation\">[</span>Service<span class=\"token punctuation\">]</span></span><br><span class=\"highlight-line\"><span class=\"token assign-left variable\">User</span><span class=\"token operator\">=</span>me</span><br><span class=\"highlight-line\"><span class=\"token assign-left variable\">ExecStart</span><span class=\"token operator\">=</span>/usr/bin/bash <span class=\"token builtin class-name\">pwd</span></span><br><span class=\"highlight-line\"><span class=\"token punctuation\">[</span>Install<span class=\"token punctuation\">]</span></span><br><span class=\"highlight-line\"><span class=\"token assign-left variable\">WantedBy</span><span class=\"token operator\">=</span>multi_user.target</span></code></pre>\n</li>\n</ol>\n<p>If you have a standard format you're building to, you can create a helper for easier importing. The example builds systemd unit files, so we might create one like</p>\n<p>:/toSystemdUnit</p>\n<pre class=\"language-dhall\"><code class=\"language-dhall\"><span class=\"highlight-line\"><span class=\"token punctuation\">.</span><span class=\"token punctuation\">/</span>render<span class=\"token punctuation\">/</span><span class=\"token class-name\">SystemdUnit</span><span class=\"token punctuation\">.</span>dhall</span></code></pre>\n<h2 id=\"adding-examples\">Adding examples <a class=\"direct-link\" href=\"#adding-examples\">#</a></h2>\n<p>Everyone loves seeing examples of how to use your stuff, so let's add those. They're just a file located in the expected directory :/examples</p>\n<p>:/examples/templated_unit.dhall</p>\n<pre class=\"language-dhall\"><code class=\"language-dhall\"><span class=\"highlight-line\"><span class=\"token keyword\">let</span> <span class=\"token class-name\">Systemd</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">..</span><span class=\"token punctuation\">/</span>types<span class=\"token punctuation\">.</span>dhall</span><br><span class=\"highlight-line\"></span><br><span class=\"highlight-line\"><span class=\"token keyword\">let</span> jupyterhub_unit</span><br><span class=\"highlight-line\">    <span class=\"token operator\">:</span> <span class=\"token class-name\">Text</span> <span class=\"token operator\">→</span> <span class=\"token class-name\">Systemd</span><span class=\"token punctuation\">.</span><span class=\"token class-name\">SystemdUnit</span></span><br><span class=\"highlight-line\">    <span class=\"token operator\">=</span> <span class=\"token operator\">λ</span><span class=\"token punctuation\">(</span>config_location <span class=\"token operator\">:</span> <span class=\"token class-name\">Text</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">→</span></span><br><span class=\"highlight-line\">        <span class=\"token punctuation\">{</span> <span class=\"token class-name\">Unit</span><span class=\"token punctuation\">.</span><span class=\"token class-name\">Description</span> <span class=\"token operator\">=</span> <span class=\"token string\">\"JupyterHub\"</span></span><br><span class=\"highlight-line\">        <span class=\"token punctuation\">,</span> <span class=\"token class-name\">Service</span> <span class=\"token operator\">=</span></span><br><span class=\"highlight-line\">          <span class=\"token punctuation\">{</span> <span class=\"token class-name\">User</span> <span class=\"token operator\">=</span> <span class=\"token string\">\"jupyterhub\"</span></span><br><span class=\"highlight-line\">          <span class=\"token punctuation\">,</span> <span class=\"token class-name\">ExecStart</span> <span class=\"token operator\">=</span> <span class=\"token string\">\"/opt/jupyterhub/bin/jupyterhub -f <span class=\"token interpolation\"><span class=\"token punctuation\">${</span><span class=\"token expression language-dhall\">config_location</span><span class=\"token punctuation\">}</span></span>\"</span></span><br><span class=\"highlight-line\">          <span class=\"token punctuation\">}</span></span><br><span class=\"highlight-line\">        <span class=\"token punctuation\">,</span> <span class=\"token class-name\">Install</span><span class=\"token punctuation\">.</span><span class=\"token class-name\">WantedBy</span> <span class=\"token operator\">=</span> <span class=\"token string\">\"multi_user.target\"</span></span><br><span class=\"highlight-line\">        <span class=\"token punctuation\">}</span></span><br><span class=\"highlight-line\"></span><br><span class=\"highlight-line\"><span class=\"token keyword\">in</span>  jupyterhub_unit</span></code></pre>\n<p>And then we can invoke this from the command line, with something like:</p>\n<pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"highlight-line\"><span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"./render/SystemdUnit.dhall (./examples/templated_unit.dhall <span class=\"token entity\" title=\"\\&quot;\">\\\"</span>/opt/jupyterhub/etc/jupyterhub/jupyterhub_config.py<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>)\"</span> <span class=\"token operator\">|</span> dhall text</span></code></pre>\n<p>or with our helper renderer:</p>\n<pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"highlight-line\"><span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"./toSystemdUnit.dhall (./examples/templated_unit.dhall <span class=\"token entity\" title=\"\\&quot;\">\\\"</span>/opt/jupyterhub/etc/jupyterhub/jupyterhub_config.py<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>)\"</span> <span class=\"token operator\">|</span> dhall text</span></code></pre>\n",
      "date_published": "2020-11-04T00:00:00+00:00"
    },{
      "id": "https://lilatomic.ca/posts/firstpost/",
      "url": "https://lilatomic.ca/posts/firstpost/",
      "title": "This is my first post.",
      "content_html": "<h2 id=\"what's-happening-here\">What's happening here <a class=\"direct-link\" href=\"#what's-happening-here\">#</a></h2>\n<p>Couple things I'll be doing:</p>\n<ul>\n<li>Filling in practical documentation : sometimes you want to know how to use a technology to <em>solve a problem</em>, not just in the abstract. As I solve problems, I'll be putting the solution here</li>\n<li>Getting into the air howtos : there are a lot of tutorials which are the most basic of &quot;How to use technology X&quot;. But often there's a significant gap to actually using that effectively. So these Howto articles will go through using a tool more indepth.</li>\n<li>Reading reports : Mostly so I don't forget the things I've read, and maybe they'll be useful for you too.</li>\n<li>Ideas (mostly about software) : I have ideas, and while they're not all good, some of them might be interesting.</li>\n</ul>\n",
      "date_published": "2020-09-30T00:00:00+00:00"
    }
  ]
}
