<!doctype html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Faking a better HttpApi plugin</title>
	<meta name="description" content="How I faked a new class of plugins in Ansible, in this case for HTTP API connections">
	<link rel="stylesheet" href="/css/index.css">
	<link rel="stylesheet" href="/css/prism-base16-monokai.dark.css">
	<link rel="alternate" href="/feed/feed.xml" type="application/atom+xml"
		  title="lilatomic">
	<link rel="alternate" href="/feed/feed.json" type="application/json"
		  title="lilatomic">
</head>
<body>
<div class="ctn">
	<header>
		<h1 class="home"><a id="home" href="/">lilatomic</a></h1>
	</header>
	<div id="main">
		<main  class="tmpl-post" >

			
<article>
<h1>Faking a better HttpApi plugin</h1>

<aside id="tagbox">
<p>Tags</p>

  <a href="/tags/ansible/" class="post-tag">ansible</a>
</aside>



<aside id="seriesbox">
<p> Member of series: </p>

  
  <a href="/series/ansible plugins/" class="post-tag">ansible plugins</a>

</aside>



<aside id="toc">
	<nav class="toc" >
        <ol><li><a href="#development">Development</a><ol><li><a href="#the-goal">The goal</a></li><li><a href="#supplying-connection-information">Supplying connection information</a></li><li><a href="#basic-requests">Basic requests</a></li><li><a href="#more-methods">More methods</a></li><li><a href="#more-parameters">More parameters</a></li><li><a href="#simple-auths">Simple Auths</a></li><li><a href="#better-returns">Better returns</a></li><li><a href="#friendlier-api">Friendlier API</a></li><li><a href="#documentation">Documentation</a></li></ol></li><li><a href="#final-version">Final Version</a></li></ol>
      </nav>
</aside>

<div class="content">
<h1 id="faking-a-better-httpapi-plugin" tabindex="-1"><a class="direct-link" href="#faking-a-better-httpapi-plugin">Faking a better HttpApi plugin</a></h1>
<p>The builtin HttpApi plugins are not great, as <a href="/posts/ansible_httpapi_plugins/">I wrote about before</a>. This makes interacting with HTTP APIs kind of a pain. It also means that all the collections which make heavy use of HTTP APIs write their frameworks on top of the bad one to make it less bad. Instead of that, we're just going to bypass the connection plugin stack, and the Ansible Plugin situation entirely.</p>
<p><a href="#final-version">TLDR</a></p>
<h2 id="development" tabindex="-1"><a class="direct-link" href="#development">Development</a></h2>
<h3 id="the-goal" tabindex="-1"><a class="direct-link" href="#the-goal">The goal</a></h3>
<p>Let's start by sketching out what we want the API to look like. Remember that this is a low-level action plugin. We'll be able to wrap this later to build more specific APIs. Here's an example for upserting a dashboard to Grafana:</p>
<pre class="language-yaml"><code class="language-yaml"><span class="highlight-line"><span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> add grafana dashboard</span>
<span class="highlight-line">  <span class="token key atrule">lilatomic.api.http</span><span class="token punctuation">:</span></span>
<span class="highlight-line">    <span class="token key atrule">connection</span><span class="token punctuation">:</span> grafana</span>
<span class="highlight-line">    <span class="token key atrule">method</span><span class="token punctuation">:</span> POST</span>
<span class="highlight-line">    <span class="token key atrule">path</span><span class="token punctuation">:</span> <span class="token string">"/dashboards/db"</span></span>
<span class="highlight-line"></span>
<span class="highlight-line">    <span class="token key atrule">body</span><span class="token punctuation">:</span></span>
<span class="highlight-line">      <span class="token key atrule">dashboard</span><span class="token punctuation">:</span> <span class="token string">"{{ lookup('file', dashboard_file) | from_json }}"</span></span>
<span class="highlight-line">      <span class="token key atrule">message</span><span class="token punctuation">:</span> <span class="token string">"redeploy"</span></span>
<span class="highlight-line">      <span class="token key atrule">overwrite</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></span></code></pre>
<h3 id="supplying-connection-information" tabindex="-1"><a class="direct-link" href="#supplying-connection-information">Supplying connection information</a></h3>
<p>You can just use normal variables for this, but I'm going to use the Inventory file. To my mind, most HTTP APIs are like nodes and actions targeting them are configuring them, so they're just another type of thing you can run Ansible tasks against. I therefore think it's natural to have them fit into the Inventory file.</p>
<p>We'd like for them to <em>not</em> show up in the conventional hosts list (for example, when targeting <em>all</em>). Fortunately the <code>yaml</code> inventory plugin lets us add vars which get passed to all hosts. This is just about what we want. Note also that you can template these. I'm going to namespace the connections, so they don't conflict with other variables. So my inventory will be structured like this:</p>
<pre class="language-yaml"><code class="language-yaml"><span class="highlight-line"><span class="token key atrule">all</span><span class="token punctuation">:</span></span>
<span class="highlight-line">  <span class="token key atrule">vars</span><span class="token punctuation">:</span></span>
<span class="highlight-line">    <span class="token key atrule">lilatomic_api_http</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span>
<span class="highlight-line">  <span class="token key atrule">hosts</span><span class="token punctuation">:</span></span>
<span class="highlight-line">  <span class="token key atrule">children</span><span class="token punctuation">:</span></span></code></pre>
<p>You could also write a <a href="/posts/ansible_writing_facts_plugin/">Vars Plugin</a>. I didn't think it was necessary, and I wanted to keep these connections with the Hosts.</p>
<h3 id="basic-requests" tabindex="-1"><a class="direct-link" href="#basic-requests">Basic requests</a></h3>
<p>We're going to start with a basic <a href="/posts/ansible_writing_action_plugin/">Action Plugin</a>.</p>
<p>The first thing we'll want to do is retrieve the connection information for the specified connection. That's easily done by just accessing the vars. The vars above actually are injected as hostvars common to all hosts, so accessing them is pretty easy. <code>task_vars[&quot;lilatomic_api_http&quot;][connection_name]</code></p>
<p>This first pass at the plugin is already much nicer for making GET requests.</p>
<pre class="language-python"><code class="language-python"><span class="highlight-line"><span class="token keyword">from</span> urllib<span class="token punctuation">.</span>parse <span class="token keyword">import</span> urljoin</span>
<span class="highlight-line"></span>
<span class="highlight-line"><span class="token keyword">import</span> requests</span>
<span class="highlight-line"><span class="token keyword">from</span> ansible<span class="token punctuation">.</span>plugins<span class="token punctuation">.</span>action <span class="token keyword">import</span> ActionBase</span>
<span class="highlight-line"></span>
<span class="highlight-line">NS <span class="token operator">=</span> <span class="token string">"lilatomic_api_http"</span></span>
<span class="highlight-line"></span>
<span class="highlight-line"></span>
<span class="highlight-line"><span class="token keyword">class</span> <span class="token class-name">ConnectionInfo</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="highlight-line">	<span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> base<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="highlight-line">		self<span class="token punctuation">.</span>base <span class="token operator">=</span> base</span>
<span class="highlight-line"></span>
<span class="highlight-line"></span>
<span class="highlight-line"><span class="token keyword">class</span> <span class="token class-name">ActionModule</span><span class="token punctuation">(</span>ActionBase<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="highlight-line">	<span class="token keyword">def</span> <span class="token function">run</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> tmp<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> task_vars<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="highlight-line">		<span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>run<span class="token punctuation">(</span>tmp<span class="token operator">=</span>tmp<span class="token punctuation">,</span> task_vars<span class="token operator">=</span>task_vars<span class="token punctuation">)</span></span>
<span class="highlight-line">		connection_name <span class="token operator">=</span> self<span class="token punctuation">.</span>arg<span class="token punctuation">(</span><span class="token string">"connection"</span><span class="token punctuation">)</span></span>
<span class="highlight-line">		connection_info <span class="token operator">=</span> ConnectionInfo<span class="token punctuation">(</span><span class="token operator">**</span>task_vars<span class="token punctuation">[</span>NS<span class="token punctuation">]</span><span class="token punctuation">[</span>connection_name<span class="token punctuation">]</span><span class="token punctuation">)</span></span>
<span class="highlight-line">		r <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>urljoin<span class="token punctuation">(</span>connection_info<span class="token punctuation">.</span>base <span class="token operator">+</span> <span class="token string">'/'</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>arg<span class="token punctuation">(</span><span class="token string">"path"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="highlight-line">		<span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token string">"result"</span><span class="token punctuation">:</span> r<span class="token punctuation">.</span>json<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span>
<span class="highlight-line"></span>
<span class="highlight-line">	<span class="token keyword">def</span> <span class="token function">arg</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> arg<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="highlight-line">		<span class="token keyword">return</span> self<span class="token punctuation">.</span>_task<span class="token punctuation">.</span>args<span class="token punctuation">[</span>arg<span class="token punctuation">]</span></span>
<span class="highlight-line"></span></code></pre>
<p>We can then use this with a playbook with a task like:</p>
<pre class="language-yaml"><code class="language-yaml"><span class="highlight-line"><span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> get alerts</span>
<span class="highlight-line">  <span class="token key atrule">lilatomic.api.http</span><span class="token punctuation">:</span></span>
<span class="highlight-line">    <span class="token key atrule">connection</span><span class="token punctuation">:</span> grafana</span>
<span class="highlight-line">    <span class="token key atrule">path</span><span class="token punctuation">:</span> /alerts</span></code></pre>
<h3 id="more-methods" tabindex="-1"><a class="direct-link" href="#more-methods">More methods</a></h3>
<p>One way of supporting more methods would be to make a plugin for each method type. I intend to do this, for convenience. But it would also be convenient to reduce duplication with a single low-level module. This would also more easily allow parametrising the method (which could be useful for things where using PUT vs PATCH is something known at runtime only). Implementing this is as simple as using the requests library, which is pretty nice.</p>
<pre class="language-python"><code class="language-python"><span class="highlight-line"><span class="token keyword">from</span> urllib<span class="token punctuation">.</span>parse <span class="token keyword">import</span> urljoin</span>
<span class="highlight-line"></span>
<span class="highlight-line"><span class="token keyword">import</span> requests</span>
<span class="highlight-line"><span class="token keyword">from</span> ansible<span class="token punctuation">.</span>plugins<span class="token punctuation">.</span>action <span class="token keyword">import</span> ActionBase</span>
<span class="highlight-line"></span>
<span class="highlight-line">NS <span class="token operator">=</span> <span class="token string">"lilatomic_api_http"</span></span>
<span class="highlight-line"></span>
<span class="highlight-line"></span>
<span class="highlight-line"><span class="token keyword">class</span> <span class="token class-name">ConnectionInfo</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="highlight-line">	<span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> base<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="highlight-line">		self<span class="token punctuation">.</span>base <span class="token operator">=</span> base</span>
<span class="highlight-line"></span>
<span class="highlight-line"></span>
<span class="highlight-line"><span class="token keyword">class</span> <span class="token class-name">ActionModule</span><span class="token punctuation">(</span>ActionBase<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="highlight-line">	<span class="token keyword">def</span> <span class="token function">run</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> tmp<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> task_vars<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="highlight-line">		<span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>run<span class="token punctuation">(</span>tmp<span class="token operator">=</span>tmp<span class="token punctuation">,</span> task_vars<span class="token operator">=</span>task_vars<span class="token punctuation">)</span></span>
<span class="highlight-line"></span>
<span class="highlight-line">		connection_name <span class="token operator">=</span> self<span class="token punctuation">.</span>arg<span class="token punctuation">(</span><span class="token string">"connection"</span><span class="token punctuation">)</span></span>
<span class="highlight-line">		connection_info <span class="token operator">=</span> ConnectionInfo<span class="token punctuation">(</span><span class="token operator">**</span>task_vars<span class="token punctuation">[</span>NS<span class="token punctuation">]</span><span class="token punctuation">[</span>connection_name<span class="token punctuation">]</span><span class="token punctuation">)</span></span>
<span class="highlight-line"></span>
<span class="highlight-line">		method <span class="token operator">=</span> self<span class="token punctuation">.</span>arg_or<span class="token punctuation">(</span><span class="token string">"method"</span><span class="token punctuation">,</span> <span class="token string">"GET"</span><span class="token punctuation">)</span></span>
<span class="highlight-line">		data <span class="token operator">=</span> self<span class="token punctuation">.</span>arg_or<span class="token punctuation">(</span><span class="token string">"data"</span><span class="token punctuation">)</span></span>
<span class="highlight-line">		json <span class="token operator">=</span> self<span class="token punctuation">.</span>arg_or<span class="token punctuation">(</span><span class="token string">"json"</span><span class="token punctuation">)</span></span>
<span class="highlight-line"></span>
<span class="highlight-line">		r <span class="token operator">=</span> requests<span class="token punctuation">.</span>request<span class="token punctuation">(</span>method<span class="token punctuation">,</span> urljoin<span class="token punctuation">(</span>connection_info<span class="token punctuation">.</span>base <span class="token operator">+</span> <span class="token string">'/'</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>arg<span class="token punctuation">(</span><span class="token string">"path"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="highlight-line">			data<span class="token operator">=</span>data<span class="token punctuation">,</span> json<span class="token operator">=</span>json<span class="token punctuation">)</span></span>
<span class="highlight-line"></span>
<span class="highlight-line">		<span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token string">"result"</span><span class="token punctuation">:</span> r<span class="token punctuation">.</span>json<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span>
<span class="highlight-line"></span>
<span class="highlight-line">	<span class="token keyword">def</span> <span class="token function">arg</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> arg<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="highlight-line">		<span class="token keyword">return</span> self<span class="token punctuation">.</span>_task<span class="token punctuation">.</span>args<span class="token punctuation">[</span>arg<span class="token punctuation">]</span></span>
<span class="highlight-line"></span>
<span class="highlight-line">	<span class="token keyword">def</span> <span class="token function">arg_or</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> arg<span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="highlight-line">		<span class="token keyword">return</span> self<span class="token punctuation">.</span>_task<span class="token punctuation">.</span>args<span class="token punctuation">.</span>get<span class="token punctuation">(</span>arg<span class="token punctuation">,</span> default<span class="token punctuation">)</span></span>
<span class="highlight-line"></span></code></pre>
<h3 id="more-parameters" tabindex="-1"><a class="direct-link" href="#more-parameters">More parameters</a></h3>
<p>HTTP APIs are full of other things that you need to specify, like proxy settings or headers or cookies or mTLS or all that. We could set all of those up as different parameters, but at some point we're just repeating the <code>requests</code> API. So instead, we'll offer an access hatch: a dedicated way of passing advanced parameters to the actual call to requests. I've simply labelled these fields as <code>kwargs</code>, which will hopefully indicate that these args are unvalidated. We also add a way of recursively merging the kwargs, which allows us to specify headers for all requests made with the connection and just for specific tasks and have them merged; as an example.</p>
<pre class="language-python"><code class="language-python"><span class="highlight-line"><span class="token keyword">from</span> typing <span class="token keyword">import</span> Dict</span>
<span class="highlight-line"><span class="token keyword">from</span> urllib<span class="token punctuation">.</span>parse <span class="token keyword">import</span> urljoin</span>
<span class="highlight-line"></span>
<span class="highlight-line"><span class="token keyword">import</span> requests</span>
<span class="highlight-line"><span class="token keyword">from</span> ansible<span class="token punctuation">.</span>plugins<span class="token punctuation">.</span>action <span class="token keyword">import</span> ActionBase</span>
<span class="highlight-line"></span>
<span class="highlight-line">NS <span class="token operator">=</span> <span class="token string">"lilatomic_api_http"</span></span>
<span class="highlight-line"></span>
<span class="highlight-line"></span>
<span class="highlight-line"><span class="token keyword">class</span> <span class="token class-name">ConnectionInfo</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="highlight-line">	<span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> base<span class="token punctuation">,</span> kwargs<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="highlight-line">		self<span class="token punctuation">.</span>base <span class="token operator">=</span> base</span>
<span class="highlight-line">		self<span class="token punctuation">.</span>kwargs <span class="token operator">=</span> kwargs <span class="token keyword">or</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span>
<span class="highlight-line"></span>
<span class="highlight-line"></span>
<span class="highlight-line"><span class="token keyword">class</span> <span class="token class-name">ActionModule</span><span class="token punctuation">(</span>ActionBase<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="highlight-line">	<span class="token keyword">def</span> <span class="token function">run</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> tmp<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> task_vars<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="highlight-line">		<span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>run<span class="token punctuation">(</span>tmp<span class="token operator">=</span>tmp<span class="token punctuation">,</span> task_vars<span class="token operator">=</span>task_vars<span class="token punctuation">)</span></span>
<span class="highlight-line"></span>
<span class="highlight-line">		connection_name <span class="token operator">=</span> self<span class="token punctuation">.</span>arg<span class="token punctuation">(</span><span class="token string">"connection"</span><span class="token punctuation">)</span></span>
<span class="highlight-line">		connection_info <span class="token operator">=</span> ConnectionInfo<span class="token punctuation">(</span><span class="token operator">**</span>task_vars<span class="token punctuation">[</span>NS<span class="token punctuation">]</span><span class="token punctuation">[</span>connection_name<span class="token punctuation">]</span><span class="token punctuation">)</span></span>
<span class="highlight-line">		task_kwargs <span class="token operator">=</span> self<span class="token punctuation">.</span>arg_or<span class="token punctuation">(</span><span class="token string">"kwargs"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="highlight-line"></span>
<span class="highlight-line">		method <span class="token operator">=</span> self<span class="token punctuation">.</span>arg_or<span class="token punctuation">(</span><span class="token string">"method"</span><span class="token punctuation">,</span> <span class="token string">"GET"</span><span class="token punctuation">)</span></span>
<span class="highlight-line">		data <span class="token operator">=</span> self<span class="token punctuation">.</span>arg_or<span class="token punctuation">(</span><span class="token string">"data"</span><span class="token punctuation">)</span></span>
<span class="highlight-line">		json <span class="token operator">=</span> self<span class="token punctuation">.</span>arg_or<span class="token punctuation">(</span><span class="token string">"json"</span><span class="token punctuation">)</span></span>
<span class="highlight-line"></span>
<span class="highlight-line">		request_kwargs <span class="token operator">=</span> recursive_merge<span class="token punctuation">(</span>connection_info<span class="token punctuation">.</span>kwargs<span class="token punctuation">,</span> task_kwargs<span class="token punctuation">)</span></span>
<span class="highlight-line">		r <span class="token operator">=</span> requests<span class="token punctuation">.</span>request<span class="token punctuation">(</span>method<span class="token punctuation">,</span> urljoin<span class="token punctuation">(</span>connection_info<span class="token punctuation">.</span>base <span class="token operator">+</span> <span class="token string">'/'</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>arg<span class="token punctuation">(</span><span class="token string">"path"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="highlight-line">			data<span class="token operator">=</span>data<span class="token punctuation">,</span> json<span class="token operator">=</span>json<span class="token punctuation">,</span> <span class="token operator">**</span>request_kwargs<span class="token punctuation">)</span></span>
<span class="highlight-line"></span>
<span class="highlight-line">		<span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token string">"result"</span><span class="token punctuation">:</span> r<span class="token punctuation">.</span>json<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span>
<span class="highlight-line"></span>
<span class="highlight-line">	<span class="token keyword">def</span> <span class="token function">arg</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> arg<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="highlight-line">		<span class="token keyword">return</span> self<span class="token punctuation">.</span>_task<span class="token punctuation">.</span>args<span class="token punctuation">[</span>arg<span class="token punctuation">]</span></span>
<span class="highlight-line"></span>
<span class="highlight-line">	<span class="token keyword">def</span> <span class="token function">arg_or</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> arg<span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="highlight-line">		<span class="token keyword">return</span> self<span class="token punctuation">.</span>_task<span class="token punctuation">.</span>args<span class="token punctuation">.</span>get<span class="token punctuation">(</span>arg<span class="token punctuation">,</span> default<span class="token punctuation">)</span></span>
<span class="highlight-line"></span>
<span class="highlight-line"></span>
<span class="highlight-line"><span class="token keyword">def</span> <span class="token function">recursive_merge</span><span class="token punctuation">(</span>a<span class="token punctuation">:</span> Dict<span class="token punctuation">,</span> b<span class="token punctuation">:</span> Dict<span class="token punctuation">,</span> path<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> Dict<span class="token punctuation">:</span></span>
	<span class="token triple-quoted-string string">""" Recursively merges dictionaries
<span class="highlight-line">	Mostly taken from user `andrew cooke` on [stackoverflow](https://stackoverflow.com/a/7205107)</span>
	"""</span>
<span class="highlight-line">	path <span class="token operator">=</span> path <span class="token keyword">or</span> <span class="token punctuation">[</span><span class="token punctuation">]</span></span>
<span class="highlight-line">	out <span class="token operator">=</span> a<span class="token punctuation">.</span>copy<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="highlight-line">	<span class="token keyword">for</span> k <span class="token keyword">in</span> b<span class="token punctuation">:</span></span>
<span class="highlight-line">		<span class="token keyword">if</span> k <span class="token keyword">in</span> a<span class="token punctuation">:</span></span>
<span class="highlight-line">			<span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>a<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token builtin">dict</span><span class="token punctuation">)</span> <span class="token keyword">and</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>b<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token builtin">dict</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="highlight-line">				out<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">=</span> recursive_merge<span class="token punctuation">(</span>a<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">,</span> b<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">,</span> path <span class="token operator">+</span> <span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span></span>
<span class="highlight-line">			<span class="token keyword">else</span><span class="token punctuation">:</span></span>
<span class="highlight-line">				out<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">=</span> b<span class="token punctuation">[</span>k<span class="token punctuation">]</span></span>
<span class="highlight-line">		<span class="token keyword">else</span><span class="token punctuation">:</span></span>
<span class="highlight-line">			out<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">=</span> b<span class="token punctuation">[</span>k<span class="token punctuation">]</span></span>
<span class="highlight-line">	<span class="token keyword">return</span> out</span>
<span class="highlight-line"></span></code></pre>
<h3 id="simple-auths" tabindex="-1"><a class="direct-link" href="#simple-auths">Simple Auths</a></h3>
<p>Let's add some basic auths. One goal for the auths is that it should be possible to pass around the whole block as a unit. This allows us to easily use different endpoints which share the same underlying authentication system. We want to be able to support a variety of auths. I'm going to use a tagged union, with the <code>method</code> field as the tag. We leverage <code>requests</code> for the Basic auth, and write out own class for Bearer. This class has a few customisation points for APIs which are special and want you to put <code>api_key</code> or <code>GenieKey</code> or something...</p>
<pre class="language-python"><code class="language-python"><span class="highlight-line"><span class="token keyword">from</span> typing <span class="token keyword">import</span> Dict<span class="token punctuation">,</span> Optional</span>
<span class="highlight-line"><span class="token keyword">from</span> urllib<span class="token punctuation">.</span>parse <span class="token keyword">import</span> urljoin</span>
<span class="highlight-line"></span>
<span class="highlight-line"><span class="token keyword">import</span> requests</span>
<span class="highlight-line"><span class="token keyword">from</span> ansible<span class="token punctuation">.</span>plugins<span class="token punctuation">.</span>action <span class="token keyword">import</span> ActionBase</span>
<span class="highlight-line"><span class="token keyword">from</span> requests<span class="token punctuation">.</span>auth <span class="token keyword">import</span> HTTPBasicAuth<span class="token punctuation">,</span> AuthBase</span>
<span class="highlight-line"></span>
<span class="highlight-line">NS <span class="token operator">=</span> <span class="token string">"lilatomic_api_http"</span></span>
<span class="highlight-line"></span>
<span class="highlight-line"></span>
<span class="highlight-line"><span class="token keyword">class</span> <span class="token class-name">HTTPBearerAuth</span><span class="token punctuation">(</span>AuthBase<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="highlight-line">	<span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> token<span class="token punctuation">,</span> header<span class="token operator">=</span><span class="token string">"Authorization"</span><span class="token punctuation">,</span> value_format<span class="token operator">=</span><span class="token string">"Bearer {}"</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="highlight-line">		self<span class="token punctuation">.</span>token <span class="token operator">=</span> token</span>
<span class="highlight-line">		self<span class="token punctuation">.</span>header <span class="token operator">=</span> header</span>
<span class="highlight-line">		self<span class="token punctuation">.</span>value_format <span class="token operator">=</span> value_format</span>
<span class="highlight-line"></span>
<span class="highlight-line">	<span class="token keyword">def</span> <span class="token function">__call__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> r<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="highlight-line">		r<span class="token punctuation">.</span>headers<span class="token punctuation">[</span>self<span class="token punctuation">.</span>header<span class="token punctuation">]</span> <span class="token operator">=</span> self<span class="token punctuation">.</span>value_format<span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>token<span class="token punctuation">)</span></span>
<span class="highlight-line">		<span class="token keyword">return</span> r</span>
<span class="highlight-line"></span>
<span class="highlight-line"></span>
<span class="highlight-line"><span class="token keyword">class</span> <span class="token class-name">ConnectionInfo</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="highlight-line">	<span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> base<span class="token punctuation">,</span> auth<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> kwargs<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="highlight-line">		self<span class="token punctuation">.</span>base <span class="token operator">=</span> base</span>
<span class="highlight-line">		self<span class="token punctuation">.</span>auth <span class="token operator">=</span> self<span class="token punctuation">.</span>make_auth<span class="token punctuation">(</span>auth<span class="token punctuation">)</span></span>
<span class="highlight-line">		self<span class="token punctuation">.</span>kwargs <span class="token operator">=</span> kwargs <span class="token keyword">or</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span>
<span class="highlight-line"></span>
<span class="highlight-line">	<span class="token decorator annotation punctuation">@staticmethod</span></span>
<span class="highlight-line">	<span class="token keyword">def</span> <span class="token function">make_auth</span><span class="token punctuation">(</span>params<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> Optional<span class="token punctuation">[</span>AuthBase<span class="token punctuation">]</span><span class="token punctuation">:</span></span>
<span class="highlight-line">		<span class="token keyword">if</span> params <span class="token keyword">is</span> <span class="token boolean">None</span> <span class="token keyword">or</span> params <span class="token operator">==</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">:</span></span>
<span class="highlight-line">			<span class="token keyword">return</span> <span class="token boolean">None</span></span>
<span class="highlight-line">		auth_method <span class="token operator">=</span> params<span class="token punctuation">.</span>pop<span class="token punctuation">(</span><span class="token string">"method"</span><span class="token punctuation">,</span> <span class="token string">"basic"</span><span class="token punctuation">)</span></span>
<span class="highlight-line">		<span class="token keyword">if</span> auth_method <span class="token operator">==</span> <span class="token string">"basic"</span><span class="token punctuation">:</span></span>
<span class="highlight-line">			<span class="token keyword">return</span> HTTPBasicAuth<span class="token punctuation">(</span>params<span class="token punctuation">[</span><span class="token string">"username"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> params<span class="token punctuation">[</span><span class="token string">"password"</span><span class="token punctuation">]</span><span class="token punctuation">)</span></span>
<span class="highlight-line">		<span class="token keyword">elif</span> auth_method <span class="token operator">==</span> <span class="token string">"bearer"</span><span class="token punctuation">:</span></span>
<span class="highlight-line">			<span class="token keyword">return</span> HTTPBearerAuth<span class="token punctuation">(</span><span class="token operator">**</span>params<span class="token punctuation">)</span></span>
<span class="highlight-line">		<span class="token keyword">else</span><span class="token punctuation">:</span></span>
<span class="highlight-line">			<span class="token keyword">return</span> <span class="token boolean">None</span></span>
<span class="highlight-line"></span>
<span class="highlight-line"></span>
<span class="highlight-line"><span class="token keyword">class</span> <span class="token class-name">ActionModule</span><span class="token punctuation">(</span>ActionBase<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="highlight-line">	<span class="token keyword">def</span> <span class="token function">run</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> tmp<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> task_vars<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="highlight-line">		<span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>run<span class="token punctuation">(</span>tmp<span class="token operator">=</span>tmp<span class="token punctuation">,</span> task_vars<span class="token operator">=</span>task_vars<span class="token punctuation">)</span></span>
<span class="highlight-line"></span>
<span class="highlight-line">		connection_name <span class="token operator">=</span> self<span class="token punctuation">.</span>arg<span class="token punctuation">(</span><span class="token string">"connection"</span><span class="token punctuation">)</span></span>
<span class="highlight-line">		connection_info <span class="token operator">=</span> ConnectionInfo<span class="token punctuation">(</span><span class="token operator">**</span>task_vars<span class="token punctuation">[</span>NS<span class="token punctuation">]</span><span class="token punctuation">[</span>connection_name<span class="token punctuation">]</span><span class="token punctuation">)</span></span>
<span class="highlight-line">		task_kwargs <span class="token operator">=</span> self<span class="token punctuation">.</span>arg_or<span class="token punctuation">(</span><span class="token string">"kwargs"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="highlight-line"></span>
<span class="highlight-line">		method <span class="token operator">=</span> self<span class="token punctuation">.</span>arg_or<span class="token punctuation">(</span><span class="token string">"method"</span><span class="token punctuation">,</span> <span class="token string">"GET"</span><span class="token punctuation">)</span></span>
<span class="highlight-line">		data <span class="token operator">=</span> self<span class="token punctuation">.</span>arg_or<span class="token punctuation">(</span><span class="token string">"data"</span><span class="token punctuation">)</span></span>
<span class="highlight-line">		json <span class="token operator">=</span> self<span class="token punctuation">.</span>arg_or<span class="token punctuation">(</span><span class="token string">"json"</span><span class="token punctuation">)</span></span>
<span class="highlight-line"></span>
<span class="highlight-line">		request_kwargs <span class="token operator">=</span> recursive_merge<span class="token punctuation">(</span>connection_info<span class="token punctuation">.</span>kwargs<span class="token punctuation">,</span> task_kwargs<span class="token punctuation">)</span></span>
<span class="highlight-line">		r <span class="token operator">=</span> requests<span class="token punctuation">.</span>request<span class="token punctuation">(</span>method<span class="token punctuation">,</span> urljoin<span class="token punctuation">(</span>connection_info<span class="token punctuation">.</span>base <span class="token operator">+</span> <span class="token string">'/'</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>arg<span class="token punctuation">(</span><span class="token string">"path"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="highlight-line">			auth<span class="token operator">=</span>connection_info<span class="token punctuation">.</span>auth<span class="token punctuation">,</span> data<span class="token operator">=</span>data<span class="token punctuation">,</span> json<span class="token operator">=</span>json<span class="token punctuation">,</span> <span class="token operator">**</span>request_kwargs<span class="token punctuation">)</span></span>
<span class="highlight-line"></span>
<span class="highlight-line">		<span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token string">"result"</span><span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>__dict__<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"h"</span><span class="token punctuation">:</span> r<span class="token punctuation">.</span>request<span class="token punctuation">.</span>headers<span class="token punctuation">}</span></span>
<span class="highlight-line"></span>
<span class="highlight-line">	<span class="token keyword">def</span> <span class="token function">arg</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> arg<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="highlight-line">		<span class="token keyword">return</span> self<span class="token punctuation">.</span>_task<span class="token punctuation">.</span>args<span class="token punctuation">[</span>arg<span class="token punctuation">]</span></span>
<span class="highlight-line"></span>
<span class="highlight-line">	<span class="token keyword">def</span> <span class="token function">arg_or</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> arg<span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="highlight-line">		<span class="token keyword">return</span> self<span class="token punctuation">.</span>_task<span class="token punctuation">.</span>args<span class="token punctuation">.</span>get<span class="token punctuation">(</span>arg<span class="token punctuation">,</span> default<span class="token punctuation">)</span></span>
<span class="highlight-line"></span>
<span class="highlight-line"></span>
<span class="highlight-line"><span class="token keyword">def</span> <span class="token function">recursive_merge</span><span class="token punctuation">(</span>a<span class="token punctuation">:</span> Dict<span class="token punctuation">,</span> b<span class="token punctuation">:</span> Dict<span class="token punctuation">,</span> path<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> Dict<span class="token punctuation">:</span></span>
	<span class="token triple-quoted-string string">""" Recursively merges dictionaries
<span class="highlight-line">	Mostly taken from user `andrew cooke` on [stackoverflow](https://stackoverflow.com/a/7205107)</span>
	"""</span>
<span class="highlight-line">	path <span class="token operator">=</span> path <span class="token keyword">or</span> <span class="token punctuation">[</span><span class="token punctuation">]</span></span>
<span class="highlight-line">	out <span class="token operator">=</span> a<span class="token punctuation">.</span>copy<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="highlight-line">	<span class="token keyword">for</span> k <span class="token keyword">in</span> b<span class="token punctuation">:</span></span>
<span class="highlight-line">		<span class="token keyword">if</span> k <span class="token keyword">in</span> a<span class="token punctuation">:</span></span>
<span class="highlight-line">			<span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>a<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token builtin">dict</span><span class="token punctuation">)</span> <span class="token keyword">and</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>b<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token builtin">dict</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="highlight-line">				out<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">=</span> recursive_merge<span class="token punctuation">(</span>a<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">,</span> b<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">,</span> path <span class="token operator">+</span> <span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span></span>
<span class="highlight-line">			<span class="token keyword">else</span><span class="token punctuation">:</span></span>
<span class="highlight-line">				out<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">=</span> b<span class="token punctuation">[</span>k<span class="token punctuation">]</span></span>
<span class="highlight-line">		<span class="token keyword">else</span><span class="token punctuation">:</span></span>
<span class="highlight-line">			out<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">=</span> b<span class="token punctuation">[</span>k<span class="token punctuation">]</span></span>
<span class="highlight-line">	<span class="token keyword">return</span> out</span>
<span class="highlight-line"></span></code></pre>
<h3 id="better-returns" tabindex="-1"><a class="direct-link" href="#better-returns">Better returns</a></h3>
<p>Currently we always return the JSON, even if it's not there. This is multiple problems:</p>
<ol>
<li>we can't load anything which doesn't return JSON</li>
<li>we never see any errors</li>
<li>we never get any other information</li>
</ol>
<p>So lets solve those. We can first just <em>not</em> return JSON if it's not supposed to be there:</p>
<pre class="language-python"><code class="language-python"><span class="highlight-line">out <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span>
<span class="highlight-line"><span class="token keyword">if</span> r<span class="token punctuation">.</span>headers<span class="token punctuation">[</span><span class="token string">"Content-Type"</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">"application/json"</span><span class="token punctuation">:</span></span>
<span class="highlight-line">	out<span class="token punctuation">[</span><span class="token string">"json"</span><span class="token punctuation">]</span> <span class="token operator">=</span> r<span class="token punctuation">.</span>json<span class="token punctuation">(</span><span class="token punctuation">)</span></span></code></pre>
<p>Neat. For errors, we can leverage the <code>response.ok</code> property. We'd also like to support the permissible return codes, since sometimes a 409 Conflict just means things are OK. Ansible modules signal failure with the &quot;failure&quot; key in the return: <code>out[&quot;failed&quot;] = not self.is_ok(r, self.arg_or(&quot;status_code&quot;))</code>. The body of that helper method is pretty simple:</p>
<pre class="language-python"><code class="language-python"><span class="highlight-line"><span class="token decorator annotation punctuation">@staticmethod</span></span>
<span class="highlight-line"><span class="token keyword">def</span> <span class="token function">is_ok</span><span class="token punctuation">(</span>response<span class="token punctuation">:</span> Response<span class="token punctuation">,</span> acceptable_codes<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span>List<span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="highlight-line">	<span class="token keyword">if</span> acceptable_codes<span class="token punctuation">:</span></span>
<span class="highlight-line">		<span class="token keyword">return</span> response<span class="token punctuation">.</span>status_code <span class="token keyword">in</span> acceptable_codes</span>
<span class="highlight-line">	<span class="token keyword">else</span><span class="token punctuation">:</span></span>
<span class="highlight-line">		<span class="token keyword">return</span> response<span class="token punctuation">.</span>ok</span></code></pre>
<p>And last we've got to build up the rest of the response. That's pretty easy, it's just transforming things. I've tried to generate all the fields that the <code>ansible.builtin.uri</code> module does.</p>
<pre class="language-python"><code class="language-python"><span class="highlight-line"><span class="token keyword">from</span> typing <span class="token keyword">import</span> Dict<span class="token punctuation">,</span> Optional<span class="token punctuation">,</span> List</span>
<span class="highlight-line"><span class="token keyword">from</span> urllib<span class="token punctuation">.</span>parse <span class="token keyword">import</span> urljoin</span>
<span class="highlight-line"></span>
<span class="highlight-line"><span class="token keyword">import</span> requests</span>
<span class="highlight-line"><span class="token keyword">from</span> ansible<span class="token punctuation">.</span>plugins<span class="token punctuation">.</span>action <span class="token keyword">import</span> ActionBase</span>
<span class="highlight-line"><span class="token keyword">from</span> requests <span class="token keyword">import</span> Response</span>
<span class="highlight-line"><span class="token keyword">from</span> requests<span class="token punctuation">.</span>auth <span class="token keyword">import</span> HTTPBasicAuth<span class="token punctuation">,</span> AuthBase</span>
<span class="highlight-line"></span>
<span class="highlight-line">NS <span class="token operator">=</span> <span class="token string">"lilatomic_api_http"</span></span>
<span class="highlight-line">AUTHORIZATION_HEADER <span class="token operator">=</span> <span class="token string">"Authorization"</span></span>
<span class="highlight-line"></span>
<span class="highlight-line"></span>
<span class="highlight-line"><span class="token keyword">class</span> <span class="token class-name">HTTPBearerAuth</span><span class="token punctuation">(</span>AuthBase<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="highlight-line">	<span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> token<span class="token punctuation">,</span> header<span class="token operator">=</span>AUTHORIZATION_HEADER<span class="token punctuation">,</span> value_format<span class="token operator">=</span><span class="token string">"Bearer {}"</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="highlight-line">		self<span class="token punctuation">.</span>token <span class="token operator">=</span> token</span>
<span class="highlight-line">		self<span class="token punctuation">.</span>header <span class="token operator">=</span> header</span>
<span class="highlight-line">		self<span class="token punctuation">.</span>value_format <span class="token operator">=</span> value_format</span>
<span class="highlight-line"></span>
<span class="highlight-line">	<span class="token keyword">def</span> <span class="token function">__call__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> r<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="highlight-line">		r<span class="token punctuation">.</span>headers<span class="token punctuation">[</span>self<span class="token punctuation">.</span>header<span class="token punctuation">]</span> <span class="token operator">=</span> self<span class="token punctuation">.</span>value_format<span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>token<span class="token punctuation">)</span></span>
<span class="highlight-line">		<span class="token keyword">return</span> r</span>
<span class="highlight-line"></span>
<span class="highlight-line"></span>
<span class="highlight-line"><span class="token keyword">class</span> <span class="token class-name">ConnectionInfo</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="highlight-line">	<span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> base<span class="token punctuation">,</span> auth<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> kwargs<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="highlight-line">		self<span class="token punctuation">.</span>base <span class="token operator">=</span> base</span>
<span class="highlight-line">		self<span class="token punctuation">.</span>auth <span class="token operator">=</span> self<span class="token punctuation">.</span>make_auth<span class="token punctuation">(</span>auth<span class="token punctuation">)</span></span>
<span class="highlight-line">		self<span class="token punctuation">.</span>kwargs <span class="token operator">=</span> kwargs <span class="token keyword">or</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span>
<span class="highlight-line"></span>
<span class="highlight-line">	<span class="token decorator annotation punctuation">@staticmethod</span></span>
<span class="highlight-line">	<span class="token keyword">def</span> <span class="token function">make_auth</span><span class="token punctuation">(</span>params<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> Optional<span class="token punctuation">[</span>AuthBase<span class="token punctuation">]</span><span class="token punctuation">:</span></span>
<span class="highlight-line">		<span class="token keyword">if</span> params <span class="token keyword">is</span> <span class="token boolean">None</span> <span class="token keyword">or</span> params <span class="token operator">==</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">:</span></span>
<span class="highlight-line">			<span class="token keyword">return</span> <span class="token boolean">None</span></span>
<span class="highlight-line">		auth_method <span class="token operator">=</span> params<span class="token punctuation">.</span>pop<span class="token punctuation">(</span><span class="token string">"method"</span><span class="token punctuation">,</span> <span class="token string">"basic"</span><span class="token punctuation">)</span></span>
<span class="highlight-line">		<span class="token keyword">if</span> auth_method <span class="token operator">==</span> <span class="token string">"basic"</span><span class="token punctuation">:</span></span>
<span class="highlight-line">			<span class="token keyword">return</span> HTTPBasicAuth<span class="token punctuation">(</span>params<span class="token punctuation">[</span><span class="token string">"username"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> params<span class="token punctuation">[</span><span class="token string">"password"</span><span class="token punctuation">]</span><span class="token punctuation">)</span></span>
<span class="highlight-line">		<span class="token keyword">elif</span> auth_method <span class="token operator">==</span> <span class="token string">"bearer"</span><span class="token punctuation">:</span></span>
<span class="highlight-line">			<span class="token keyword">return</span> HTTPBearerAuth<span class="token punctuation">(</span><span class="token operator">**</span>params<span class="token punctuation">)</span></span>
<span class="highlight-line">		<span class="token keyword">else</span><span class="token punctuation">:</span></span>
<span class="highlight-line">			<span class="token keyword">return</span> <span class="token boolean">None</span></span>
<span class="highlight-line"></span>
<span class="highlight-line"></span>
<span class="highlight-line"><span class="token keyword">class</span> <span class="token class-name">ActionModule</span><span class="token punctuation">(</span>ActionBase<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="highlight-line">	<span class="token keyword">def</span> <span class="token function">run</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> tmp<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> task_vars<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="highlight-line">		<span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>run<span class="token punctuation">(</span>tmp<span class="token operator">=</span>tmp<span class="token punctuation">,</span> task_vars<span class="token operator">=</span>task_vars<span class="token punctuation">)</span></span>
<span class="highlight-line"></span>
<span class="highlight-line">		connection_name <span class="token operator">=</span> self<span class="token punctuation">.</span>arg<span class="token punctuation">(</span><span class="token string">"connection"</span><span class="token punctuation">)</span></span>
<span class="highlight-line">		connection_info <span class="token operator">=</span> ConnectionInfo<span class="token punctuation">(</span><span class="token operator">**</span>task_vars<span class="token punctuation">[</span>NS<span class="token punctuation">]</span><span class="token punctuation">[</span>connection_name<span class="token punctuation">]</span><span class="token punctuation">)</span></span>
<span class="highlight-line">		task_kwargs <span class="token operator">=</span> self<span class="token punctuation">.</span>arg_or<span class="token punctuation">(</span><span class="token string">"kwargs"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="highlight-line"></span>
<span class="highlight-line">		method <span class="token operator">=</span> self<span class="token punctuation">.</span>arg_or<span class="token punctuation">(</span><span class="token string">"method"</span><span class="token punctuation">,</span> <span class="token string">"GET"</span><span class="token punctuation">)</span></span>
<span class="highlight-line">		data <span class="token operator">=</span> self<span class="token punctuation">.</span>arg_or<span class="token punctuation">(</span><span class="token string">"data"</span><span class="token punctuation">)</span></span>
<span class="highlight-line">		json <span class="token operator">=</span> self<span class="token punctuation">.</span>arg_or<span class="token punctuation">(</span><span class="token string">"json"</span><span class="token punctuation">)</span></span>
<span class="highlight-line"></span>
<span class="highlight-line">		request_kwargs <span class="token operator">=</span> recursive_merge<span class="token punctuation">(</span>connection_info<span class="token punctuation">.</span>kwargs<span class="token punctuation">,</span> task_kwargs<span class="token punctuation">)</span></span>
<span class="highlight-line">		r <span class="token operator">=</span> requests<span class="token punctuation">.</span>request<span class="token punctuation">(</span>method<span class="token punctuation">,</span> urljoin<span class="token punctuation">(</span>connection_info<span class="token punctuation">.</span>base <span class="token operator">+</span> <span class="token string">'/'</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>arg<span class="token punctuation">(</span><span class="token string">"path"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="highlight-line">			auth<span class="token operator">=</span>connection_info<span class="token punctuation">.</span>auth<span class="token punctuation">,</span> data<span class="token operator">=</span>data<span class="token punctuation">,</span> json<span class="token operator">=</span>json<span class="token punctuation">,</span> <span class="token operator">**</span>request_kwargs<span class="token punctuation">)</span></span>
<span class="highlight-line"></span>
<span class="highlight-line">		out <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span>
<span class="highlight-line"></span>
<span class="highlight-line">		<span class="token comment"># response status</span></span>
<span class="highlight-line">		out<span class="token punctuation">[</span><span class="token string">"failed"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">not</span> self<span class="token punctuation">.</span>is_ok<span class="token punctuation">(</span>r<span class="token punctuation">,</span> self<span class="token punctuation">.</span>arg_or<span class="token punctuation">(</span><span class="token string">"status_code"</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="highlight-line"></span>
<span class="highlight-line">		<span class="token comment"># response data</span></span>
<span class="highlight-line">		<span class="token keyword">if</span> r<span class="token punctuation">.</span>headers<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"Content-Type"</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"application/json"</span><span class="token punctuation">:</span></span>
<span class="highlight-line">			out<span class="token punctuation">[</span><span class="token string">"json"</span><span class="token punctuation">]</span> <span class="token operator">=</span> r<span class="token punctuation">.</span>json<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="highlight-line">		out<span class="token punctuation">[</span><span class="token string">"msg"</span><span class="token punctuation">]</span> <span class="token operator">=</span> r<span class="token punctuation">.</span>text</span>
<span class="highlight-line"></span>
<span class="highlight-line">		<span class="token comment"># parameters for ansible.legacy.uri module</span></span>
<span class="highlight-line">		out<span class="token punctuation">.</span>update<span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="highlight-line">			<span class="token string">"content"</span><span class="token punctuation">:</span> r<span class="token punctuation">.</span>content<span class="token punctuation">,</span></span>
<span class="highlight-line">			<span class="token string">"content_length"</span><span class="token punctuation">:</span> r<span class="token punctuation">.</span>headers<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"Content-Length"</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="highlight-line">			<span class="token string">"content_type"</span><span class="token punctuation">:</span> r<span class="token punctuation">.</span>headers<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"Content-Type"</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="highlight-line">			<span class="token string">"cookies"</span><span class="token punctuation">:</span> <span class="token builtin">dict</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>cookies<span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="highlight-line">			<span class="token string">"date"</span><span class="token punctuation">:</span> r<span class="token punctuation">.</span>headers<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"Date"</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="highlight-line">			<span class="token string">"elapsed"</span><span class="token punctuation">:</span> r<span class="token punctuation">.</span>elapsed<span class="token punctuation">.</span>seconds<span class="token punctuation">,</span></span>
<span class="highlight-line">			<span class="token string">"redirected"</span><span class="token punctuation">:</span> r<span class="token punctuation">.</span>is_redirect<span class="token punctuation">,</span></span>
<span class="highlight-line">			<span class="token string">"server"</span><span class="token punctuation">:</span> r<span class="token punctuation">.</span>headers<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"Server"</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="highlight-line">			<span class="token string">"status"</span><span class="token punctuation">:</span> r<span class="token punctuation">.</span>status_code<span class="token punctuation">,</span></span>
<span class="highlight-line">			<span class="token string">"url"</span><span class="token punctuation">:</span> r<span class="token punctuation">.</span>url<span class="token punctuation">,</span></span>
<span class="highlight-line">			<span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="highlight-line"></span>
<span class="highlight-line">		<span class="token comment"># other parameters</span></span>
<span class="highlight-line">		out<span class="token punctuation">.</span>update<span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="highlight-line">			<span class="token string">"encoding"</span><span class="token punctuation">:</span> r<span class="token punctuation">.</span>encoding<span class="token punctuation">,</span></span>
<span class="highlight-line">			<span class="token string">"headers"</span><span class="token punctuation">:</span> r<span class="token punctuation">.</span>headers<span class="token punctuation">,</span></span>
<span class="highlight-line">			<span class="token string">"reason"</span><span class="token punctuation">:</span> r<span class="token punctuation">.</span>reason<span class="token punctuation">,</span></span>
<span class="highlight-line">			<span class="token string">"status_code"</span><span class="token punctuation">:</span> r<span class="token punctuation">.</span>status_code<span class="token punctuation">,</span></span>
<span class="highlight-line">			<span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="highlight-line"></span>
<span class="highlight-line">		<span class="token comment"># request parameters, for debugging</span></span>
<span class="highlight-line">		<span class="token keyword">if</span> self<span class="token punctuation">.</span>arg_or<span class="token punctuation">(</span><span class="token string">"log_request"</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="highlight-line">			req <span class="token operator">=</span> r<span class="token punctuation">.</span>request</span>
<span class="highlight-line">			headers <span class="token operator">=</span> req<span class="token punctuation">.</span>headers<span class="token punctuation">.</span>copy<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="highlight-line">			<span class="token keyword">if</span> <span class="token keyword">not</span> self<span class="token punctuation">.</span>arg_or<span class="token punctuation">(</span><span class="token string">"log_auth"</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="highlight-line">				<span class="token keyword">if</span> AUTHORIZATION_HEADER <span class="token keyword">in</span> headers<span class="token punctuation">:</span></span>
<span class="highlight-line">					headers<span class="token punctuation">[</span>AUTHORIZATION_HEADER<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"*"</span><span class="token operator">*</span><span class="token builtin">len</span><span class="token punctuation">(</span>headers<span class="token punctuation">[</span>AUTHORIZATION_HEADER<span class="token punctuation">]</span><span class="token punctuation">)</span></span>
<span class="highlight-line"></span>
<span class="highlight-line">			out<span class="token punctuation">.</span>update<span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="highlight-line">				<span class="token string">"request"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span></span>
<span class="highlight-line">					<span class="token string">"body"</span><span class="token punctuation">:</span> req<span class="token punctuation">.</span>body<span class="token punctuation">,</span></span>
<span class="highlight-line">					<span class="token string">"headers"</span><span class="token punctuation">:</span> headers<span class="token punctuation">,</span></span>
<span class="highlight-line">					<span class="token string">"method"</span><span class="token punctuation">:</span> req<span class="token punctuation">.</span>method<span class="token punctuation">,</span></span>
<span class="highlight-line">					<span class="token string">"path_url"</span><span class="token punctuation">:</span> req<span class="token punctuation">.</span>path_url<span class="token punctuation">,</span></span>
<span class="highlight-line">					<span class="token string">"url"</span><span class="token punctuation">:</span> req<span class="token punctuation">.</span>url<span class="token punctuation">,</span></span>
<span class="highlight-line">					<span class="token punctuation">}</span></span>
<span class="highlight-line">				<span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="highlight-line"></span>
<span class="highlight-line">		<span class="token keyword">return</span> out</span>
<span class="highlight-line"></span>
<span class="highlight-line">	<span class="token decorator annotation punctuation">@staticmethod</span></span>
<span class="highlight-line">	<span class="token keyword">def</span> <span class="token function">is_ok</span><span class="token punctuation">(</span>response<span class="token punctuation">:</span> Response<span class="token punctuation">,</span> acceptable_codes<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span>List<span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="highlight-line">		<span class="token keyword">if</span> acceptable_codes<span class="token punctuation">:</span></span>
<span class="highlight-line">			<span class="token keyword">return</span> response<span class="token punctuation">.</span>status_code <span class="token keyword">in</span> acceptable_codes</span>
<span class="highlight-line">		<span class="token keyword">else</span><span class="token punctuation">:</span></span>
<span class="highlight-line">			<span class="token keyword">return</span> response<span class="token punctuation">.</span>ok</span>
<span class="highlight-line"></span>
<span class="highlight-line">	<span class="token keyword">def</span> <span class="token function">arg</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> arg<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="highlight-line">		<span class="token keyword">return</span> self<span class="token punctuation">.</span>_task<span class="token punctuation">.</span>args<span class="token punctuation">[</span>arg<span class="token punctuation">]</span></span>
<span class="highlight-line"></span>
<span class="highlight-line">	<span class="token keyword">def</span> <span class="token function">arg_or</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> arg<span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="highlight-line">		<span class="token keyword">return</span> self<span class="token punctuation">.</span>_task<span class="token punctuation">.</span>args<span class="token punctuation">.</span>get<span class="token punctuation">(</span>arg<span class="token punctuation">,</span> default<span class="token punctuation">)</span></span>
<span class="highlight-line"></span>
<span class="highlight-line"></span>
<span class="highlight-line"><span class="token keyword">def</span> <span class="token function">recursive_merge</span><span class="token punctuation">(</span>a<span class="token punctuation">:</span> Dict<span class="token punctuation">,</span> b<span class="token punctuation">:</span> Dict<span class="token punctuation">,</span> path<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> Dict<span class="token punctuation">:</span></span>
	<span class="token triple-quoted-string string">""" Recursively merges dictionaries
<span class="highlight-line">	Mostly taken from user `andrew cooke` on [stackoverflow](https://stackoverflow.com/a/7205107)</span>
	"""</span>
<span class="highlight-line">	path <span class="token operator">=</span> path <span class="token keyword">or</span> <span class="token punctuation">[</span><span class="token punctuation">]</span></span>
<span class="highlight-line">	out <span class="token operator">=</span> a<span class="token punctuation">.</span>copy<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="highlight-line">	<span class="token keyword">for</span> k <span class="token keyword">in</span> b<span class="token punctuation">:</span></span>
<span class="highlight-line">		<span class="token keyword">if</span> k <span class="token keyword">in</span> a<span class="token punctuation">:</span></span>
<span class="highlight-line">			<span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>a<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token builtin">dict</span><span class="token punctuation">)</span> <span class="token keyword">and</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>b<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token builtin">dict</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="highlight-line">				out<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">=</span> recursive_merge<span class="token punctuation">(</span>a<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">,</span> b<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">,</span> path <span class="token operator">+</span> <span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span></span>
<span class="highlight-line">			<span class="token keyword">else</span><span class="token punctuation">:</span></span>
<span class="highlight-line">				out<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">=</span> b<span class="token punctuation">[</span>k<span class="token punctuation">]</span></span>
<span class="highlight-line">		<span class="token keyword">else</span><span class="token punctuation">:</span></span>
<span class="highlight-line">			out<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">=</span> b<span class="token punctuation">[</span>k<span class="token punctuation">]</span></span>
<span class="highlight-line">	<span class="token keyword">return</span> out</span>
<span class="highlight-line"></span></code></pre>
<h3 id="friendlier-api" tabindex="-1"><a class="direct-link" href="#friendlier-api">Friendlier API</a></h3>
<p>The current API requires people to add Headers in the kwargs, which sucks a bit. Adding another parameter is easy enough.</p>
<p>While we're at it, it's pretty easy to make shortcuts for specific methods:</p>
<pre class="language-python"><code class="language-python"><span class="highlight-line"><span class="token keyword">from</span> <span class="token punctuation">.</span>http <span class="token keyword">import</span> ActionModule <span class="token keyword">as</span> Http</span>
<span class="highlight-line"></span>
<span class="highlight-line"></span>
<span class="highlight-line"><span class="token keyword">class</span> <span class="token class-name">ActionModule</span><span class="token punctuation">(</span>Http<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="highlight-line">	<span class="token keyword">def</span> <span class="token function">run</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> tmp<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> task_vars<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="highlight-line">		self<span class="token punctuation">.</span>_task<span class="token punctuation">.</span>args<span class="token punctuation">[</span><span class="token string">"method"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"POST"</span></span>
<span class="highlight-line"></span>
<span class="highlight-line">		<span class="token keyword">return</span> <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>run<span class="token punctuation">(</span>tmp<span class="token operator">=</span>tmp<span class="token punctuation">,</span> task_vars<span class="token operator">=</span>task_vars<span class="token punctuation">)</span></span></code></pre>
<h3 id="documentation" tabindex="-1"><a class="direct-link" href="#documentation">Documentation</a></h3>
<p>Didn't think I'd let us off the hook for this, did you? It's easy if tedious, you just have to create a fake module and fill in the required docstrings. I've only done that for the main HTTP plugin. Ideally, I would pull out everything except for the &quot;method&quot; parameter into a document fragment, and then have them all reference that. something for a future improvement</p>
<h2 id="final-version" tabindex="-1"><a class="direct-link" href="#final-version">Final Version</a></h2>
<p>With a few improvements along the way, we have:</p>
<p>.../plugins/action/http.py</p>
<pre class="language-python"><code class="language-python"><span class="highlight-line"><span class="token keyword">from</span> typing <span class="token keyword">import</span> Dict<span class="token punctuation">,</span> Optional<span class="token punctuation">,</span> List</span>
<span class="highlight-line"><span class="token keyword">from</span> urllib<span class="token punctuation">.</span>parse <span class="token keyword">import</span> urljoin</span>
<span class="highlight-line"></span>
<span class="highlight-line"><span class="token keyword">import</span> requests</span>
<span class="highlight-line"><span class="token keyword">from</span> ansible<span class="token punctuation">.</span>plugins<span class="token punctuation">.</span>action <span class="token keyword">import</span> ActionBase</span>
<span class="highlight-line"><span class="token keyword">from</span> requests <span class="token keyword">import</span> Response</span>
<span class="highlight-line"><span class="token keyword">from</span> requests<span class="token punctuation">.</span>auth <span class="token keyword">import</span> HTTPBasicAuth<span class="token punctuation">,</span> AuthBase</span>
<span class="highlight-line"></span>
<span class="highlight-line">NS <span class="token operator">=</span> <span class="token string">"lilatomic_api_http"</span></span>
<span class="highlight-line">AUTHORIZATION_HEADER <span class="token operator">=</span> <span class="token string">"Authorization"</span></span>
<span class="highlight-line">DEFAULT_TIMEOUT <span class="token operator">=</span> <span class="token number">15</span></span>
<span class="highlight-line"></span>
<span class="highlight-line"></span>
<span class="highlight-line"><span class="token keyword">class</span> <span class="token class-name">HTTPBearerAuth</span><span class="token punctuation">(</span>AuthBase<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="highlight-line">	<span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> token<span class="token punctuation">,</span> header<span class="token operator">=</span>AUTHORIZATION_HEADER<span class="token punctuation">,</span> value_format<span class="token operator">=</span><span class="token string">"Bearer {}"</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="highlight-line">		self<span class="token punctuation">.</span>token <span class="token operator">=</span> token</span>
<span class="highlight-line">		self<span class="token punctuation">.</span>header <span class="token operator">=</span> header</span>
<span class="highlight-line">		self<span class="token punctuation">.</span>value_format <span class="token operator">=</span> value_format</span>
<span class="highlight-line"></span>
<span class="highlight-line">	<span class="token keyword">def</span> <span class="token function">__call__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> r<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="highlight-line">		r<span class="token punctuation">.</span>headers<span class="token punctuation">[</span>self<span class="token punctuation">.</span>header<span class="token punctuation">]</span> <span class="token operator">=</span> self<span class="token punctuation">.</span>value_format<span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>token<span class="token punctuation">)</span></span>
<span class="highlight-line">		<span class="token keyword">return</span> r</span>
<span class="highlight-line"></span>
<span class="highlight-line"></span>
<span class="highlight-line"><span class="token keyword">class</span> <span class="token class-name">ConnectionInfo</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="highlight-line">	<span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> base<span class="token punctuation">,</span> auth<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> kwargs<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="highlight-line">		self<span class="token punctuation">.</span>base <span class="token operator">=</span> base</span>
<span class="highlight-line">		self<span class="token punctuation">.</span>auth <span class="token operator">=</span> self<span class="token punctuation">.</span>make_auth<span class="token punctuation">(</span>auth<span class="token punctuation">)</span></span>
<span class="highlight-line">		self<span class="token punctuation">.</span>kwargs <span class="token operator">=</span> kwargs <span class="token keyword">or</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span>
<span class="highlight-line"></span>
<span class="highlight-line">	<span class="token decorator annotation punctuation">@staticmethod</span></span>
<span class="highlight-line">	<span class="token keyword">def</span> <span class="token function">make_auth</span><span class="token punctuation">(</span>params<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> Optional<span class="token punctuation">[</span>AuthBase<span class="token punctuation">]</span><span class="token punctuation">:</span></span>
<span class="highlight-line">		<span class="token keyword">if</span> params <span class="token keyword">is</span> <span class="token boolean">None</span> <span class="token keyword">or</span> params <span class="token operator">==</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">:</span></span>
<span class="highlight-line">			<span class="token keyword">return</span> <span class="token boolean">None</span></span>
<span class="highlight-line">		auth_method <span class="token operator">=</span> params<span class="token punctuation">.</span>pop<span class="token punctuation">(</span><span class="token string">"method"</span><span class="token punctuation">,</span> <span class="token string">"basic"</span><span class="token punctuation">)</span></span>
<span class="highlight-line">		<span class="token keyword">if</span> auth_method <span class="token operator">==</span> <span class="token string">"basic"</span><span class="token punctuation">:</span></span>
<span class="highlight-line">			<span class="token keyword">return</span> HTTPBasicAuth<span class="token punctuation">(</span>params<span class="token punctuation">[</span><span class="token string">"username"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> params<span class="token punctuation">[</span><span class="token string">"password"</span><span class="token punctuation">]</span><span class="token punctuation">)</span></span>
<span class="highlight-line">		<span class="token keyword">elif</span> auth_method <span class="token operator">==</span> <span class="token string">"bearer"</span><span class="token punctuation">:</span></span>
<span class="highlight-line">			<span class="token keyword">return</span> HTTPBearerAuth<span class="token punctuation">(</span><span class="token operator">**</span>params<span class="token punctuation">)</span></span>
<span class="highlight-line">		<span class="token keyword">else</span><span class="token punctuation">:</span></span>
<span class="highlight-line">			<span class="token keyword">return</span> <span class="token boolean">None</span></span>
<span class="highlight-line"></span>
<span class="highlight-line"></span>
<span class="highlight-line"><span class="token keyword">class</span> <span class="token class-name">ActionModule</span><span class="token punctuation">(</span>ActionBase<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="highlight-line">	<span class="token keyword">def</span> <span class="token function">run</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> tmp<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> task_vars<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="highlight-line">		<span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>run<span class="token punctuation">(</span>tmp<span class="token operator">=</span>tmp<span class="token punctuation">,</span> task_vars<span class="token operator">=</span>task_vars<span class="token punctuation">)</span></span>
<span class="highlight-line"></span>
<span class="highlight-line">		connection_name <span class="token operator">=</span> self<span class="token punctuation">.</span>arg<span class="token punctuation">(</span><span class="token string">"connection"</span><span class="token punctuation">)</span></span>
<span class="highlight-line">		connection_info <span class="token operator">=</span> ConnectionInfo<span class="token punctuation">(</span><span class="token operator">**</span>task_vars<span class="token punctuation">[</span>NS<span class="token punctuation">]</span><span class="token punctuation">[</span>connection_name<span class="token punctuation">]</span><span class="token punctuation">)</span></span>
<span class="highlight-line">		task_kwargs <span class="token operator">=</span> self<span class="token punctuation">.</span>arg_or<span class="token punctuation">(</span><span class="token string">"kwargs"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="highlight-line"></span>
<span class="highlight-line">		method <span class="token operator">=</span> self<span class="token punctuation">.</span>arg_or<span class="token punctuation">(</span><span class="token string">"method"</span><span class="token punctuation">,</span> <span class="token string">"GET"</span><span class="token punctuation">)</span></span>
<span class="highlight-line">		data <span class="token operator">=</span> self<span class="token punctuation">.</span>arg_or<span class="token punctuation">(</span><span class="token string">"data"</span><span class="token punctuation">)</span></span>
<span class="highlight-line">		json <span class="token operator">=</span> self<span class="token punctuation">.</span>arg_or<span class="token punctuation">(</span><span class="token string">"json"</span><span class="token punctuation">)</span></span>
<span class="highlight-line"></span>
<span class="highlight-line">		headers <span class="token operator">=</span> self<span class="token punctuation">.</span>arg_or<span class="token punctuation">(</span><span class="token string">"headers"</span><span class="token punctuation">)</span></span>
<span class="highlight-line"></span>
<span class="highlight-line">		request_kwargs <span class="token operator">=</span> recursive_merge<span class="token punctuation">(</span>recursive_merge<span class="token punctuation">(</span>connection_info<span class="token punctuation">.</span>kwargs<span class="token punctuation">,</span> task_kwargs<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token string">"headers"</span><span class="token punctuation">:</span> headers<span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="highlight-line"></span>
<span class="highlight-line">		request_kwargs<span class="token punctuation">[</span><span class="token string">"timeout"</span><span class="token punctuation">]</span> <span class="token operator">=</span> self<span class="token punctuation">.</span>arg_or<span class="token punctuation">(</span><span class="token string">"timeout"</span><span class="token punctuation">,</span> request_kwargs<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"timeout"</span><span class="token punctuation">,</span> DEFAULT_TIMEOUT<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="highlight-line"></span>
<span class="highlight-line">		r <span class="token operator">=</span> requests<span class="token punctuation">.</span>request<span class="token punctuation">(</span>method<span class="token punctuation">,</span> urljoin<span class="token punctuation">(</span>connection_info<span class="token punctuation">.</span>base <span class="token operator">+</span> <span class="token string">'/'</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>arg<span class="token punctuation">(</span><span class="token string">"path"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="highlight-line">			auth<span class="token operator">=</span>connection_info<span class="token punctuation">.</span>auth<span class="token punctuation">,</span> data<span class="token operator">=</span>data<span class="token punctuation">,</span> json<span class="token operator">=</span>json<span class="token punctuation">,</span> <span class="token operator">**</span>request_kwargs<span class="token punctuation">)</span></span>
<span class="highlight-line"></span>
<span class="highlight-line">		out <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span>
<span class="highlight-line"></span>
<span class="highlight-line">		<span class="token comment"># response status</span></span>
<span class="highlight-line">		out<span class="token punctuation">[</span><span class="token string">"failed"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">not</span> self<span class="token punctuation">.</span>is_ok<span class="token punctuation">(</span>r<span class="token punctuation">,</span> self<span class="token punctuation">.</span>arg_or<span class="token punctuation">(</span><span class="token string">"status_code"</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="highlight-line"></span>
<span class="highlight-line">		<span class="token comment"># response data</span></span>
<span class="highlight-line">		<span class="token keyword">if</span> r<span class="token punctuation">.</span>headers<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"Content-Type"</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"application/json"</span><span class="token punctuation">:</span></span>
<span class="highlight-line">			out<span class="token punctuation">[</span><span class="token string">"json"</span><span class="token punctuation">]</span> <span class="token operator">=</span> r<span class="token punctuation">.</span>json<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="highlight-line">		out<span class="token punctuation">[</span><span class="token string">"msg"</span><span class="token punctuation">]</span> <span class="token operator">=</span> r<span class="token punctuation">.</span>text</span>
<span class="highlight-line"></span>
<span class="highlight-line">		<span class="token comment"># parameters for ansible.legacy.uri module</span></span>
<span class="highlight-line">		out<span class="token punctuation">.</span>update<span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="highlight-line">			<span class="token string">"content"</span><span class="token punctuation">:</span> r<span class="token punctuation">.</span>content<span class="token punctuation">,</span></span>
<span class="highlight-line">			<span class="token string">"content_length"</span><span class="token punctuation">:</span> r<span class="token punctuation">.</span>headers<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"Content-Length"</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="highlight-line">			<span class="token string">"content_type"</span><span class="token punctuation">:</span> r<span class="token punctuation">.</span>headers<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"Content-Type"</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="highlight-line">			<span class="token string">"cookies"</span><span class="token punctuation">:</span> <span class="token builtin">dict</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>cookies<span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="highlight-line">			<span class="token string">"date"</span><span class="token punctuation">:</span> r<span class="token punctuation">.</span>headers<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"Date"</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="highlight-line">			<span class="token string">"elapsed"</span><span class="token punctuation">:</span> r<span class="token punctuation">.</span>elapsed<span class="token punctuation">.</span>seconds<span class="token punctuation">,</span></span>
<span class="highlight-line">			<span class="token string">"redirected"</span><span class="token punctuation">:</span> r<span class="token punctuation">.</span>is_redirect<span class="token punctuation">,</span></span>
<span class="highlight-line">			<span class="token string">"server"</span><span class="token punctuation">:</span> r<span class="token punctuation">.</span>headers<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"Server"</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="highlight-line">			<span class="token string">"status"</span><span class="token punctuation">:</span> r<span class="token punctuation">.</span>status_code<span class="token punctuation">,</span></span>
<span class="highlight-line">			<span class="token string">"url"</span><span class="token punctuation">:</span> r<span class="token punctuation">.</span>url<span class="token punctuation">,</span></span>
<span class="highlight-line">			<span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="highlight-line"></span>
<span class="highlight-line">		<span class="token comment"># other parameters</span></span>
<span class="highlight-line">		out<span class="token punctuation">.</span>update<span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="highlight-line">			<span class="token string">"encoding"</span><span class="token punctuation">:</span> r<span class="token punctuation">.</span>encoding<span class="token punctuation">,</span></span>
<span class="highlight-line">			<span class="token string">"headers"</span><span class="token punctuation">:</span> r<span class="token punctuation">.</span>headers<span class="token punctuation">,</span></span>
<span class="highlight-line">			<span class="token string">"reason"</span><span class="token punctuation">:</span> r<span class="token punctuation">.</span>reason<span class="token punctuation">,</span></span>
<span class="highlight-line">			<span class="token string">"status_code"</span><span class="token punctuation">:</span> r<span class="token punctuation">.</span>status_code<span class="token punctuation">,</span></span>
<span class="highlight-line">			<span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="highlight-line"></span>
<span class="highlight-line">		<span class="token comment"># request parameters, for debugging</span></span>
<span class="highlight-line">		<span class="token keyword">if</span> self<span class="token punctuation">.</span>arg_or<span class="token punctuation">(</span><span class="token string">"log_request"</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="highlight-line">			req <span class="token operator">=</span> r<span class="token punctuation">.</span>request</span>
<span class="highlight-line">			headers <span class="token operator">=</span> req<span class="token punctuation">.</span>headers<span class="token punctuation">.</span>copy<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="highlight-line">			<span class="token keyword">if</span> <span class="token keyword">not</span> self<span class="token punctuation">.</span>arg_or<span class="token punctuation">(</span><span class="token string">"log_auth"</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="highlight-line">				<span class="token keyword">if</span> AUTHORIZATION_HEADER <span class="token keyword">in</span> headers<span class="token punctuation">:</span></span>
<span class="highlight-line">					headers<span class="token punctuation">[</span>AUTHORIZATION_HEADER<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"*"</span> <span class="token operator">*</span> <span class="token builtin">len</span><span class="token punctuation">(</span>headers<span class="token punctuation">[</span>AUTHORIZATION_HEADER<span class="token punctuation">]</span><span class="token punctuation">)</span></span>
<span class="highlight-line"></span>
<span class="highlight-line">			out<span class="token punctuation">.</span>update<span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="highlight-line">				<span class="token string">"request"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span></span>
<span class="highlight-line">					<span class="token string">"body"</span><span class="token punctuation">:</span> req<span class="token punctuation">.</span>body<span class="token punctuation">,</span></span>
<span class="highlight-line">					<span class="token string">"headers"</span><span class="token punctuation">:</span> headers<span class="token punctuation">,</span></span>
<span class="highlight-line">					<span class="token string">"method"</span><span class="token punctuation">:</span> req<span class="token punctuation">.</span>method<span class="token punctuation">,</span></span>
<span class="highlight-line">					<span class="token string">"path_url"</span><span class="token punctuation">:</span> req<span class="token punctuation">.</span>path_url<span class="token punctuation">,</span></span>
<span class="highlight-line">					<span class="token string">"url"</span><span class="token punctuation">:</span> req<span class="token punctuation">.</span>url<span class="token punctuation">,</span></span>
<span class="highlight-line">					<span class="token punctuation">}</span></span>
<span class="highlight-line">				<span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="highlight-line"></span>
<span class="highlight-line">		<span class="token keyword">return</span> out</span>
<span class="highlight-line"></span>
<span class="highlight-line">	<span class="token decorator annotation punctuation">@staticmethod</span></span>
<span class="highlight-line">	<span class="token keyword">def</span> <span class="token function">is_ok</span><span class="token punctuation">(</span>response<span class="token punctuation">:</span> Response<span class="token punctuation">,</span> acceptable_codes<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span>List<span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="highlight-line">		<span class="token keyword">if</span> acceptable_codes<span class="token punctuation">:</span></span>
<span class="highlight-line">			<span class="token keyword">return</span> response<span class="token punctuation">.</span>status_code <span class="token keyword">in</span> acceptable_codes</span>
<span class="highlight-line">		<span class="token keyword">else</span><span class="token punctuation">:</span></span>
<span class="highlight-line">			<span class="token keyword">return</span> response<span class="token punctuation">.</span>ok</span>
<span class="highlight-line"></span>
<span class="highlight-line">	<span class="token decorator annotation punctuation">@staticmethod</span></span>
<span class="highlight-line">	<span class="token keyword">def</span> <span class="token function">parse_content_length</span><span class="token punctuation">(</span>content_length<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> Optional<span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">]</span><span class="token punctuation">:</span></span>
<span class="highlight-line">		<span class="token keyword">if</span> content_length<span class="token punctuation">:</span></span>
<span class="highlight-line">			<span class="token keyword">try</span><span class="token punctuation">:</span></span>
<span class="highlight-line">				<span class="token keyword">return</span> <span class="token builtin">int</span><span class="token punctuation">(</span>content_length<span class="token punctuation">)</span></span>
<span class="highlight-line">			<span class="token keyword">except</span> ValueError<span class="token punctuation">:</span></span>
<span class="highlight-line">				<span class="token keyword">return</span> <span class="token boolean">None</span></span>
<span class="highlight-line">		<span class="token keyword">return</span> <span class="token boolean">None</span></span>
<span class="highlight-line"></span>
<span class="highlight-line">	<span class="token keyword">def</span> <span class="token function">arg</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> arg<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="highlight-line">		<span class="token keyword">return</span> self<span class="token punctuation">.</span>_task<span class="token punctuation">.</span>args<span class="token punctuation">[</span>arg<span class="token punctuation">]</span></span>
<span class="highlight-line"></span>
<span class="highlight-line">	<span class="token keyword">def</span> <span class="token function">arg_or</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> arg<span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="highlight-line">		<span class="token keyword">return</span> self<span class="token punctuation">.</span>_task<span class="token punctuation">.</span>args<span class="token punctuation">.</span>get<span class="token punctuation">(</span>arg<span class="token punctuation">,</span> default<span class="token punctuation">)</span></span>
<span class="highlight-line"></span>
<span class="highlight-line"></span>
<span class="highlight-line"><span class="token keyword">def</span> <span class="token function">recursive_merge</span><span class="token punctuation">(</span>a<span class="token punctuation">:</span> Dict<span class="token punctuation">,</span> b<span class="token punctuation">:</span> Dict<span class="token punctuation">,</span> path<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> Dict<span class="token punctuation">:</span></span>
	<span class="token triple-quoted-string string">""" Recursively merges dictionaries
<span class="highlight-line">	Mostly taken from user `andrew cooke` on [stackoverflow](https://stackoverflow.com/a/7205107)</span>
	"""</span>
<span class="highlight-line">	path <span class="token operator">=</span> path <span class="token keyword">or</span> <span class="token punctuation">[</span><span class="token punctuation">]</span></span>
<span class="highlight-line">	out <span class="token operator">=</span> a<span class="token punctuation">.</span>copy<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="highlight-line">	<span class="token keyword">for</span> k <span class="token keyword">in</span> b<span class="token punctuation">:</span></span>
<span class="highlight-line">		<span class="token keyword">if</span> k <span class="token keyword">in</span> a<span class="token punctuation">:</span></span>
<span class="highlight-line">			<span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>a<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token builtin">dict</span><span class="token punctuation">)</span> <span class="token keyword">and</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>b<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token builtin">dict</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="highlight-line">				out<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">=</span> recursive_merge<span class="token punctuation">(</span>a<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">,</span> b<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">,</span> path <span class="token operator">+</span> <span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span></span>
<span class="highlight-line">			<span class="token keyword">else</span><span class="token punctuation">:</span></span>
<span class="highlight-line">				out<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">=</span> b<span class="token punctuation">[</span>k<span class="token punctuation">]</span></span>
<span class="highlight-line">		<span class="token keyword">else</span><span class="token punctuation">:</span></span>
<span class="highlight-line">			out<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">=</span> b<span class="token punctuation">[</span>k<span class="token punctuation">]</span></span>
<span class="highlight-line">	<span class="token keyword">return</span> out</span>
<span class="highlight-line"></span></code></pre>
<p>.../plugins/modules/http.py</p>
<pre class="language-python"><code class="language-python"><span class="highlight-line"><span class="token comment">#!/usr/bin/python</span></span>
<span class="highlight-line"><span class="token comment"># -*- coding: utf-8 -*-</span></span>
<span class="highlight-line"></span>
<span class="highlight-line"></span>
DOCUMENTATION <span class="token operator">=</span> <span class="token triple-quoted-string string">"""
<span class="highlight-line">---</span>
<span class="highlight-line">module: lilatomic.api.http</span>
<span class="highlight-line">short_description: A nice and friendly HTTP API</span>
<span class="highlight-line">description:</span>
<span class="highlight-line">  - An easy way to use the [requests](https://docs.python-requests.org/en/master/) library to make HTTP requests</span>
<span class="highlight-line">  - Define connections and re-use them across tasks</span>
<span class="highlight-line">version_added: "0.1.0"</span>
<span class="highlight-line">options:</span>
<span class="highlight-line">  connection:</span>
<span class="highlight-line">    description: the name of the connection to use</span>
<span class="highlight-line">    required: true</span>
<span class="highlight-line">    type: string</span>
<span class="highlight-line">  method:</span>
<span class="highlight-line">    description: the HTTP method to use</span>
<span class="highlight-line">    required: true</span>
<span class="highlight-line">    default: GET</span>
<span class="highlight-line">    type: string</span>
<span class="highlight-line">  path:</span>
<span class="highlight-line">    description: the slug to join to the connection's base</span>
<span class="highlight-line">  data:</span>
<span class="highlight-line">    description: object to send in the body of the request.</span>
<span class="highlight-line">    required: false</span>
<span class="highlight-line">    type: string or dict</span>
<span class="highlight-line">  json:</span>
<span class="highlight-line">    description: json data to send in the body of the request.</span>
<span class="highlight-line">    required: false</span>
<span class="highlight-line">    type: string or dict</span>
<span class="highlight-line">  headers:</span>
<span class="highlight-line">    description: HTTP headers for the request</span>
<span class="highlight-line">    required: false</span>
<span class="highlight-line">    type: dict</span>
<span class="highlight-line">    default: dict()</span>
<span class="highlight-line">  status_code:</span>
<span class="highlight-line">    description: acceptable status codes</span>
<span class="highlight-line">    required: false</span>
<span class="highlight-line">    default: requests default, status_code &lt; 400</span>
<span class="highlight-line">    type: list</span>
<span class="highlight-line">    elements: int</span>
<span class="highlight-line">  timeout:</span>
<span class="highlight-line">    description: timeout in seconds of the request</span>
<span class="highlight-line">    required: false</span>
<span class="highlight-line">    default: 15</span>
<span class="highlight-line">    type: float</span>
<span class="highlight-line">  log_request:</span>
<span class="highlight-line">    description: returns information about the request. Useful for debugging. Censors Authorization header unless log_auth is used.</span>
<span class="highlight-line">    required: false</span>
<span class="highlight-line">    default: false</span>
<span class="highlight-line">    type: bool</span>
<span class="highlight-line">  log_auth:</span>
<span class="highlight-line">    description: uncensors the Authorization header.</span>
<span class="highlight-line">    required: false</span>
<span class="highlight-line">    default: false</span>
<span class="highlight-line">    type: bool</span>
<span class="highlight-line">  kwargs:</span>
<span class="highlight-line">    description: Access hatch for passing kwargs to the requests.request method. Recursively merged with and overrides kwargs set on the connection.</span>
<span class="highlight-line">    required: false</span>
<span class="highlight-line">    default: None</span>
<span class="highlight-line">    type: dict</span>
"""</span>
<span class="highlight-line"></span>
EXAMPLES <span class="token operator">=</span> <span class="token triple-quoted-string string">"""
<span class="highlight-line">---</span>
<span class="highlight-line">- name: post</span>
<span class="highlight-line">  lilatomic.api.http:</span>
<span class="highlight-line">    connection: httpbin</span>
<span class="highlight-line">    method: POST</span>
<span class="highlight-line">    path: /post</span>
<span class="highlight-line">    data:</span>
<span class="highlight-line">      1: 1</span>
<span class="highlight-line">      2: 2</span>
<span class="highlight-line">  vars:</span>
<span class="highlight-line">    lilatomic_api_http:</span>
<span class="highlight-line">      httpbin:</span>
<span class="highlight-line">        base: "https://httpbingo.org/"</span>
<span class="highlight-line"></span>
<span class="highlight-line">- name: GET with logging of the request</span>
<span class="highlight-line">  lilatomic.api.http:</span>
<span class="highlight-line">    connection: fishbike</span>
<span class="highlight-line">    path: /</span>
<span class="highlight-line">    log_request: true</span>
<span class="highlight-line">  vars:</span>
<span class="highlight-line">    lilatomic_api_http:</span>
<span class="highlight-line">      httpbin:</span>
<span class="highlight-line">        base: "https://httpbingo.org/"</span>
<span class="highlight-line"></span>
<span class="highlight-line">- name: GET with Bearer auth</span>
<span class="highlight-line">  lilatomic.api.http:</span>
<span class="highlight-line">    connection: httpbin_bearer</span>
<span class="highlight-line">    path: /bearer</span>
<span class="highlight-line">    log_request: true</span>
<span class="highlight-line">    log_auth: true</span>
<span class="highlight-line">  vars:</span>
<span class="highlight-line">    lilatomic_api_http:</span>
<span class="highlight-line">      httpbin_bearer:</span>
<span class="highlight-line">        base: "https://httpbin.org"</span>
<span class="highlight-line">        auth:</span>
<span class="highlight-line">          method: bearer</span>
<span class="highlight-line">          token: hihello</span>
<span class="highlight-line"></span>
<span class="highlight-line">- name: Use Kwargs for disallowing redirects</span>
<span class="highlight-line">  lilatomic.api.http:</span>
<span class="highlight-line">    connection: httpbin</span>
<span class="highlight-line">    path: redirect-to?url=get</span>
<span class="highlight-line">    kwargs:</span>
<span class="highlight-line">      allow_redirects: false</span>
<span class="highlight-line">    status_code: [ 302 ]</span>
<span class="highlight-line">  vars:</span>
<span class="highlight-line">    lilatomic_api_http:</span>
<span class="highlight-line">      httpbin:</span>
<span class="highlight-line">        base: "https://httpbingo.org/"</span>
"""</span>
<span class="highlight-line"></span>
RETURN <span class="token operator">=</span> <span class="token triple-quoted-string string">"""
<span class="highlight-line">---</span>
<span class="highlight-line">json:</span>
<span class="highlight-line">  description: json body</span>
<span class="highlight-line">  returned: response has headers Content-Type == "application/json"</span>
<span class="highlight-line">  type: complex</span>
<span class="highlight-line">  sample: {</span>
<span class="highlight-line">    "authenticated": true,</span>
<span class="highlight-line">    "token": "hihello"</span>
<span class="highlight-line">  }</span>
<span class="highlight-line">content:</span>
<span class="highlight-line">  description: response.content</span>
<span class="highlight-line">  returned: always</span>
<span class="highlight-line">  type: str</span>
<span class="highlight-line">  sample: |</span>
<span class="highlight-line">    {\\n  "authenticated": true, \\n  "token": "hihello"\\n}\\n</span>
<span class="highlight-line">msg:</span>
<span class="highlight-line">  description: response body</span>
<span class="highlight-line">  returned: always</span>
<span class="highlight-line">  type: str</span>
<span class="highlight-line">  sample: |</span>
<span class="highlight-line">    {\\n  "authenticated": true, \\n  "token": "hihello"\\n}\\n</span>
<span class="highlight-line">content-length:</span>
<span class="highlight-line">  description: response Content-Length header</span>
<span class="highlight-line">  returned: always</span>
<span class="highlight-line">  type: int</span>
<span class="highlight-line">  sample: 51</span>
<span class="highlight-line">content-type:</span>
<span class="highlight-line">  description: response Content-Type header</span>
<span class="highlight-line">  returned: always</span>
<span class="highlight-line">  type: string</span>
<span class="highlight-line">  sample: "application/json"</span>
<span class="highlight-line">cookies:</span>
<span class="highlight-line">  description: the cookies from the response</span>
<span class="highlight-line">  returned: always</span>
<span class="highlight-line">  type: dict</span>
<span class="highlight-line">  sample: { }</span>
<span class="highlight-line">date:</span>
<span class="highlight-line">  description: response Date header</span>
<span class="highlight-line">  returned: always</span>
<span class="highlight-line">  type: str</span>
<span class="highlight-line">  sample: "Sat, 10 Jul 2021 23:14:14 GMT"</span>
<span class="highlight-line">elapsed:</span>
<span class="highlight-line">  description: seconds elapsed making the request</span>
<span class="highlight-line">  returned: always</span>
<span class="highlight-line">  type: int</span>
<span class="highlight-line">  sample: 0</span>
<span class="highlight-line">redirected:</span>
<span class="highlight-line">  description: if response was redirected</span>
<span class="highlight-line">  returned: always</span>
<span class="highlight-line">  type: bool</span>
<span class="highlight-line">  sample: false</span>
<span class="highlight-line">server:</span>
<span class="highlight-line">  description: response Server header</span>
<span class="highlight-line">  returned: always</span>
<span class="highlight-line">  type: str</span>
<span class="highlight-line">  sample: "gunicorn/19.9.0"</span>
<span class="highlight-line">status:</span>
<span class="highlight-line">  description: response status code; alias for status_code</span>
<span class="highlight-line">  returned: always</span>
<span class="highlight-line">  type: str</span>
<span class="highlight-line">  sample: 200</span>
<span class="highlight-line">url:</span>
<span class="highlight-line">  description: the URL from the response</span>
<span class="highlight-line">  returned: always</span>
<span class="highlight-line">  type: str</span>
<span class="highlight-line">  sample: "https://httpbin.org/bearer"</span>
<span class="highlight-line">encoding:</span>
<span class="highlight-line">  description: response encoding</span>
<span class="highlight-line">  returned: always</span>
<span class="highlight-line">  type: str</span>
<span class="highlight-line">  sample: "utf-8"</span>
<span class="highlight-line">headers:</span>
<span class="highlight-line">  description: response headers</span>
<span class="highlight-line">  returned: always</span>
<span class="highlight-line">  type: dict</span>
<span class="highlight-line">  elements: str</span>
<span class="highlight-line">  sample: {</span>
<span class="highlight-line">    "Access-Control-Allow-Credentials": "true",</span>
<span class="highlight-line">    "Access-Control-Allow-Origin": "*",</span>
<span class="highlight-line">    "Connection": "keep-alive",</span>
<span class="highlight-line">    "Content-Length": "51",</span>
<span class="highlight-line">    "Content-Type": "application/json",</span>
<span class="highlight-line">    "Date": "Sat, 10 Jul 2021 23:14:14 GMT",</span>
<span class="highlight-line">    "Server": "gunicorn/19.9.0"</span>
<span class="highlight-line">  }</span>
<span class="highlight-line">reason:</span>
<span class="highlight-line">  description: response status reason</span>
<span class="highlight-line">  returned: always</span>
<span class="highlight-line">  type: str</span>
<span class="highlight-line">  sample: "OK"</span>
<span class="highlight-line">status_code:</span>
<span class="highlight-line">  description: response status code</span>
<span class="highlight-line">  returned: always</span>
<span class="highlight-line">  type: str</span>
<span class="highlight-line">  sample: 200</span>
<span class="highlight-line">request:</span>
<span class="highlight-line">  description: the original request, useful for debugging</span>
<span class="highlight-line">  returned: when log_request == true</span>
<span class="highlight-line">  type: complex</span>
<span class="highlight-line">  contains:</span>
<span class="highlight-line">    body:</span>
<span class="highlight-line">      description: request body</span>
<span class="highlight-line">      returned: always</span>
<span class="highlight-line">      type: str</span>
<span class="highlight-line">    headers:</span>
<span class="highlight-line">      description: request headers. Authorization will be censored unless `log_auth` == true</span>
<span class="highlight-line">      returned: always</span>
<span class="highlight-line">      type: dict</span>
<span class="highlight-line">      elements: str</span>
<span class="highlight-line">    method:</span>
<span class="highlight-line">      description: request HTTP method</span>
<span class="highlight-line">      returned: always</span>
<span class="highlight-line">      type: str</span>
<span class="highlight-line">    path_url:</span>
<span class="highlight-line">      description: request path url; the part of the url which is called the path; that's its technical name</span>
<span class="highlight-line">      returned: always</span>
<span class="highlight-line">      type: str</span>
<span class="highlight-line">    url:</span>
<span class="highlight-line">      description: the full url</span>
<span class="highlight-line">      returned: always</span>
<span class="highlight-line">      type: str</span>
<span class="highlight-line">  sample: {</span>
<span class="highlight-line">    "body": null,</span>
<span class="highlight-line">    "headers": {</span>
<span class="highlight-line">      "Accept": "*/*",</span>
<span class="highlight-line">      "Accept-Encoding": "gzip, deflate",</span>
<span class="highlight-line">      "Authorization": "Bearer hihello",</span>
<span class="highlight-line">      "Connection": "keep-alive",</span>
<span class="highlight-line">      "User-Agent": "python-requests/2.25.1"</span>
<span class="highlight-line">    },</span>
<span class="highlight-line">    "method": "GET",</span>
<span class="highlight-line">    "path_url": "/bearer",</span>
<span class="highlight-line">    "url": "https://httpbin.org/bearer"</span>
<span class="highlight-line">  }</span>
"""</span></code></pre>

</div>
</article>



<hr>
<ul><li>Next: <a href="/posts/bicep/">Having fun with Azure Bicep</a></li><li>Previous: <a href="/posts/ansible_httpapi_plugins/">Understanding Ansible HttpApi plugins</a></li>
</ul>

		</main>
		<nav class="nav">
			<ul>
				<li class="nav-item"><a
						href="/">Home</a></li>
				<li class="nav-item"><a
						href="/posts/">Archive</a></li>
				<li class="nav-item"><a
						href="/tags/">Tags</a></li>
				<li class="nav-item"><a
						href="/series/">Series</a></li>
				<li class="nav-item"><a
						href="/about/">About Me</a></li>
				<li class="nav-item"><a
						href="/colophon/">Colophon</a></li>
				<li class="nav-item"><a
						href="/feedlist/">Feeds</a></li>
			</ul>
		</nav>
	</div>
</div>
<footer></footer>

<!-- Current page: /posts/ansible_better_http_api/ -->
</body>
</html>
